name: Auto-merge Claude branches into main

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch branch claude
        run: git fetch origin ${{ github.ref_name }}

      # â”€â”€ GARDE : CHANGELOG.md obligatoire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: VÃ©rifier que CHANGELOG.md a Ã©tÃ© mis Ã  jour
        run: |
          NOUVEAUX=$(git log origin/main..origin/${{ github.ref_name }} --oneline)
          if [ -z "$NOUVEAUX" ]; then
            echo "Aucun nouveau commit Ã  merger â€” rien Ã  faire."
            exit 0
          fi

          CHANGELOG_MODIFIE=$(git diff origin/main..origin/${{ github.ref_name }} \
            --name-only | grep -c "CHANGELOG.md" || true)

          if [ "$CHANGELOG_MODIFIE" -eq 0 ]; then
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "âŒ  CHANGELOG.md n'a pas Ã©tÃ© mis Ã  jour."
            echo ""
            echo "  RÃ¨gle du projet (CLAUDE.md) :"
            echo "  Chaque commit doit documenter ses changements"
            echo "  dans CHANGELOG.md (section MAJOR/MINOR/PATCH)."
            echo ""
            echo "  â†’ Mettez Ã  jour CHANGELOG.md puis re-pushez."
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            exit 1
          fi

          echo "âœ…  CHANGELOG.md prÃ©sent dans les nouveaux commits."

      # â”€â”€ RÃ‰CAPITULATIF PRÃ‰-MERGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: GÃ©nÃ©rer le rÃ©capitulatif de dÃ©ploiement
        run: |
          BRANCH="${{ github.ref_name }}"
          DATE=$(date '+%d/%m/%Y Ã  %H:%M UTC')

          {
            echo "## ðŸš€ DÃ©ploiement \`${BRANCH}\` â†’ \`main\`"
            echo ""
            echo "> **${DATE}**"
            echo ""

            echo "### ðŸ“‹ Commits mergÃ©s"
            echo ""
            git log origin/main..origin/${BRANCH} \
              --pretty=format:"- \`%h\` %s" \
              --no-merges
            echo ""
            echo ""

            echo "### ðŸ“ Fichiers modifiÃ©s"
            echo ""
            git diff origin/main..origin/${BRANCH} --name-only \
              | grep -v "^$" \
              | awk '{print "- `" $0 "`"}'
            echo ""
            echo ""

            echo "### ðŸ“ Notes de version (CHANGELOG.md)"
            echo ""
            # Extrait la premiÃ¨re section du CHANGELOG (jusqu'au premier ---)
            awk '/^---$/{exit} /^## \[/{found=1} found' CHANGELOG.md \
              || echo "_Aucune section trouvÃ©e dans CHANGELOG.md_"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      # â”€â”€ MERGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Merger la branch dans main
        run: |
          git merge origin/${{ github.ref_name }} --no-edit
          git push origin main

      # â”€â”€ STATUT FINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Statut final
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            {
              echo "---"
              echo "### âœ… Merge rÃ©ussi"
              echo "Branch \`${{ github.ref_name }}\` intÃ©grÃ©e dans \`main\`."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "---"
              echo "### âŒ DÃ©ploiement Ã©chouÃ©"
              echo "Voir les logs ci-dessus pour le dÃ©tail."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
