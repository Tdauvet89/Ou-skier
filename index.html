<!doctype html>
<html lang="fr">
    <head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB6G3EL32M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CB6G3EL32M');
</script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ski rando Météo - Dashboard Ski de Randonnée</title>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="icons.js?v=7.13.0"></script>
        <script src="weatherCodes.js?v=7.13.0"></script>
        <script src="massifMapping.js?v=7.13.0"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Inter:wght@400;500&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="design-system.css?v=7.18.0" />
        <style>
            body {
                font-family: "JetBrains Mono", monospace;
                background: white;
                min-height: 100vh;
                padding: 0;
                color: var(--storm-gray);
            }

            .container {
                max-width: 1440px;
                margin: 0 auto;
                background: white;
                animation: slideDown 0.6s ease-out;
            }

            header {
                background: white;
                padding: 20px 75px;
                border-bottom: 1px solid #E1E8F2;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            h1 {
                margin-bottom: 0;
                display: flex;
                align-items: center;
            }

            .subtitle {
                font-size: 0.95rem;
                color: var(--storm-gray);
                font-weight: 500;
                letter-spacing: 1px;
            }

            .header-controls {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                align-items: center;
            }

            .date-display {
                flex: 1;
                padding: 10px 16px;
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                font-size: 0.85rem;
                color: var(--deep-blue);
                font-weight: 500;
            }

            .refresh-btn {
                font-size: 0.95rem;
            }

            .main-content {
                background: white;
                padding: 40px 75px;
                border-radius: 0;
                box-shadow: none;
            }

            .loading {
                text-align: center;
                padding: 60px 20px;
                font-size: 1.2rem;
                color: var(--deep-blue);
            }

            .error {
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 8px;
                padding: 14px 18px;
                margin: 16px 0;
                color: #dc2626;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .section {
                margin-bottom: 40px;
                animation: fadeIn 0.5s ease-out backwards;
            }

            .section:nth-child(1) {
                animation-delay: 0.1s;
            }
            .section:nth-child(2) {
                animation-delay: 0.2s;
            }

            h2 {
                font-family: "Garnett", sans-serif;
                font-size: 24px;
                font-weight: 500;
                color: #1F2023;
                line-height: normal;
                margin-bottom: 20px;
                padding-bottom: 0;
                border-bottom: none;
                display: flex;
                align-items: center;
                gap: 8px;
            }


            /* Generic table styles — overridden by .snow-table for snow section */
            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                border-radius: 10px;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
                border: 1px solid #e2e8f0;
                overflow: hidden;
            }

            thead {
                background: var(--deep-blue);
                color: white;
            }

            th {
                padding: 14px 16px;
                text-align: left;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 0.9rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-right: 1px solid rgba(255, 255, 255, 0.08);
            }

            th:first-child {
                font-size: 1rem;
                min-width: 180px;
            }

            th:last-child {
                border-right: none;
            }

            tbody tr {
                transition: background 0.15s ease;
                background: white;
            }

            tbody tr:nth-child(even) {
                background: #f8fafc;
            }

            tbody tr:hover {
                background: #f0f7ff;
            }

            td {
                padding: 14px 16px;
                border-right: 1px solid #f1f5f9;
                border-bottom: 1px solid #f1f5f9;
                font-size: 0.9rem;
            }

            td:first-child {
                font-weight: 600;
                color: var(--deep-blue);
                font-size: 0.95rem;
            }

            td:last-child {
                border-right: none;
            }

            .heavy-snow .snow-value {
                color: var(--warning-orange);
            }

            .date-header {
                font-size: 0.85rem;
                opacity: 0.9;
                display: block;
                margin-top: 4px;
                font-weight: 400;
            }

            .weather-icon {
                display: inline-flex;
                align-items: center;
                margin-right: 8px;
                vertical-align: middle;
            }
            .weather-icon svg {
                width: 22px;
                height: 22px;
            }

            .temp {
                font-weight: 600;
                color: var(--deep-blue);
            }

            .temp-cold {
                color: #3498db;
            }

            .temp-warm {
                color: var(--warning-orange);
            }

            .conditions {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .wind-info {
                font-size: 0.85rem;
                color: #7f8c8d;
                margin-top: 4px;
            }

            .legend {
                margin-top: 16px;
                padding: 12px 18px;
                background: #f8fafc;
                border-radius: 8px;
                font-size: 0.8rem;
                color: var(--storm-gray);
                border: 1px solid #e2e8f0;
            }

            .legend-item {
                display: inline-block;
                margin-right: 25px;
                margin-bottom: 5px;
            }

            /* Toggle View Switch — Surfline-style pill */
            .view-toggle-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            /* Toggle : utilise .toggle / .toggle-btn de design-system.css */

            /* Hourly sub-header */
            .hourly-col-header {
                text-align: center;
                padding: 4px 2px;
                font-family: "Garnett", sans-serif;
                font-size: 11px;
                font-weight: 500;
                color: #5E7690;
                min-width: 35px;
                max-width: 35px;
                border-right: 1px solid #E1E8F2;
                background: #F9FAFC;
            }

            /* Une heure sur deux en bold pour faciliter la lecture */
            .hourly-col-header:nth-child(2n + 2) {
                font-weight: 500;
                color: #1F2023;
            }

            .hourly-col-header:first-of-type {
                border-left: none;
            }

            .day-cell {
                padding: 38px 16px;
                min-width: 300px;
                min-height: 237px;
                vertical-align: middle;
                background: #f9fafc;
            }

            .day-cell-inner {
                display: flex;
                align-items: flex-start;
                gap: 16px;
            }

            .day-cell-icon {
                flex: 0 0 100px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                gap: 4px;
            }
            .day-cell-icon svg {
                width: 40px;
                height: 40px;
            }

            .day-cell-condition {
                font-family: "Inter", sans-serif;
                font-size: 12px;
                font-weight: 400;
                color: #45556C;
                line-height: 15px;
                text-align: center;
            }

            .day-cell-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            /* Ligne température : -4° + (-7° / -3°) sur la même ligne */
            .cell-temp-line {
                display: flex;
                align-items: baseline;
                gap: 4px;
                line-height: 32px;
            }
            .cell-temp-main {
                font-family: "Inter", sans-serif;
                font-size: 24px;
                font-weight: 700;
                color: #0F172B;
                line-height: 32px;
            }
            .cell-temp-range {
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 400;
                color: #62748E;
                line-height: 20px;
            }

            /* Lignes vent & rafales */
            .day-cell-info .info-row {
                display: flex;
                align-items: center;
                gap: 6px;
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 400;
                color: #314158;
                line-height: 20px;
            }
            .day-cell-info .info-row svg {
                width: 16px;
                height: 16px;
                flex-shrink: 0;
            }

            /* Badge BERA */
            .bera-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 8px;
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 600;
                color: #ffffff;
                line-height: 20px;
                cursor: default;
            }

            /* Lien "Voir le BERA" */
            .bera-link {
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 500;
                color: #155DFC;
                line-height: 20px;
                text-decoration: underline;
                cursor: pointer;
            }
            .bera-link:hover {
                color: #0f3fa0;
            }

            .hourly-cell {
                text-align: center;
                padding: 6px 2px;
                min-width: 35px;
                max-width: 35px;
                border-right: 1px solid #E1E8F2;
                vertical-align: middle;
                font-size: 0.7rem;
            }

            .cell-icon {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 1px 0;
            }
            .cell-icon svg {
                width: 18px;
                height: 18px;
            }

            .cell-temp {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
                margin: 2px 0;
            }

            .cell-wind {
                font-size: 0.6rem;
                color: #7f8c8d;
                margin-top: 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 2px;
                flex-wrap: nowrap;
            }

            .wind-arrow {
                display: inline-flex;
                align-items: center;
                color: #3498db;
                line-height: 1;
            }
            .wind-arrow svg {
                width: 14px;
                height: 14px;
            }

            .wind-cardinal {
                font-size: 0.55rem;
                font-weight: 700;
                color: #555;
            }

            .cell-temp-range {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
            }

            /* Tableau horaire détaillé */
            .hourly-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                overflow-x: auto;
                display: block;
            }

            .hourly-table thead,
            .hourly-table tbody {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            .resort-header-sticky {
                position: sticky;
                left: 0;
                z-index: 10;
                background: white;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                padding: 15px 20px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.3rem;
                color: var(--deep-blue);
                border-bottom: 2px solid var(--glacier);
                min-width: 200px;
                max-width: 200px;
            }

            .day-column {
                text-align: center;
                vertical-align: top;
                border-right: 1px solid #e2e8f0;
                padding: 0;
                min-width: 180px;
                max-width: 180px;
            }

            .day-column:last-child {
                border-right: none;
            }

            .day-header {
                background: var(--deep-blue);
                color: white;
                padding: 10px 6px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 0.8rem;
                font-weight: 700;
                text-transform: uppercase;
                line-height: 1.3;
            }

            .day-header.today-header {
                background: var(--fresh-green);
            }

            .hourly-slots {
                display: flex;
                flex-direction: row;
                border-top: 1px solid #e0e0e0;
            }

            .hour-slot {
                flex: 1;
                padding: 6px 3px;
                border-right: 1px solid #f0f0f0;
                min-width: 60px;
            }

            .hour-slot:last-child {
                border-right: none;
            }

            .hour-time {
                font-size: 0.7rem;
                font-weight: 700;
                color: var(--deep-blue);
                margin-bottom: 4px;
            }

            .hour-icon {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 3px 0;
            }
            .hour-icon svg {
                width: 22px;
                height: 22px;
            }

            .hour-temp {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
                margin: 3px 0;
            }

            .temp-trend {
                font-size: 0.6rem;
                color: #95a5a6;
            }

            .hour-wind {
                font-size: 0.65rem;
                color: #7f8c8d;
                margin-top: 3px;
            }

            .wind-trend {
                font-size: 0.6rem;
                color: #95a5a6;
            }

            .trend-up {
                color: #e74c3c;
            }

            .trend-down {
                color: #3498db;
            }

            .trend-stable {
                color: #95a5a6;
            }

            .weather-table-wrapper {
                overflow-x: auto;
                margin-bottom: 40px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .weather-table-container {
                display: flex;
                min-width: fit-content;
            }

            .resort-name-column {
                position: sticky;
                left: 0;
                z-index: 10;
                background: var(--deep-blue);
                color: white;
                padding: 14px 18px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.1rem;
                font-weight: 700;
                text-transform: uppercase;
                display: flex;
                align-items: center;
                min-width: 200px;
                max-width: 200px;
                box-shadow: 3px 0 6px rgba(0, 0, 0, 0.06);
            }

            .days-container {
                display: flex;
                flex: 1;
            }

            .past-day {
                opacity: 0.7;
                background: #f8f9fa !important;
            }

            .today {
                background: linear-gradient(
                    135deg,
                    rgba(168, 213, 226, 0.2),
                    rgba(212, 233, 247, 0.2)
                ) !important;
                border: 2px solid var(--glacier);
            }

            .future-day {
                background: white !important;
            }

            .add-resort-btn {
                margin-top: 10px;
            }

            /* Modal, input : utilise .modal-overlay / .modal / .modal-header / .input de design-system.css */

            .search-input {
                margin-bottom: 16px;
            }

            .search-results {
                max-height: 300px;
                overflow-y: auto;
                margin-bottom: 20px;
            }

            .search-result-item {
                padding: 12px 14px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                margin-bottom: 8px;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .search-result-item:hover {
                background: #f0f7ff;
                border-color: var(--glacier);
            }

            .result-name {
                font-weight: 700;
                color: var(--deep-blue);
                font-size: 1.1rem;
                margin-bottom: 5px;
            }

            .result-info {
                font-size: 0.85rem;
                color: #7f8c8d;
            }

            .modal-buttons {
                display: flex;
                gap: 15px;
                margin-top: 25px;
            }


            .loading-search {
                text-align: center;
                padding: 20px;
                color: var(--deep-blue);
                font-style: italic;
            }

            .no-results {
                text-align: center;
                padding: 20px;
                color: #95a5a6;
            }

            .resort-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }

            /* Tag : utilise .tag de design-system.css */

            .remove-resort {
                background: none;
                border: none;
                color: var(--deep-blue);
                cursor: pointer;
                font-size: 1.2rem;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s ease;
            }

            .remove-resort:hover {
                background: var(--deep-blue);
                color: white;
            }

            @media (max-width: 1200px) {
                .logo-text-primary {
                    font-size: 1.6rem;
                }
                .logo-text-secondary {
                    font-size: 1.1rem;
                }
                .logo-icon svg {
                    width: 40px;
                    height: 40px;
                }

                .main-content {
                    padding: 25px;
                }

                table {
                    font-size: 0.85rem;
                }

                th,
                td {
                    padding: 12px 10px;
                }
            }

            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                .logo-text-primary {
                    font-size: 1.4rem;
                }
                .logo-text-secondary {
                    font-size: 1rem;
                }
                .logo-icon svg {
                    width: 36px;
                    height: 36px;
                }
                .logo {
                    gap: 10px;
                }

                h2 {
                    font-size: 1.5rem;
                }

                .main-content {
                    padding: 20px;
                }

                table {
                    font-size: 0.75rem;
                }

                th,
                td {
                    padding: 10px 6px;
                }

                .date-header {
                    font-size: 0.7rem;
                }

                .legend-item {
                    display: block;
                    margin-bottom: 8px;
                }

                .resort-inputs {
                    grid-template-columns: 1fr;
                }
            }

        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            // Configuration des secteurs de ski avec coordonnées
            const DEFAULT_RESORTS = [
                {
                    name: "Guzet",
                    lat: 42.7857,
                    lon: 1.2261,
                    altitude: 1400,
                    mbUrl: "guzet-neige_france_7580803",
                },
                {
                    name: "Piau-Engaly",
                    lat: 42.7833,
                    lon: 0.1667,
                    altitude: 1850,
                    mbUrl: "piau-engaly_france_8426488",
                },
                {
                    name: "Saint-Lary",
                    lat: 42.8167,
                    lon: 0.3167,
                    altitude: 1700,
                    mbUrl: "saint-lary-soulan_france_2978975",
                },
            ];

            const API_KEY = "LuUd7q9wHpiG1aWh";

            // === MODE MOCK (fausses données pour itérer sur le design) ===
            const USE_MOCK_DATA = true;

            // Générer les dates dynamiquement (aujourd'hui + 6 jours)
            const _mockDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                _mockDays.push(d.toISOString().split("T")[0]);
            }

            // Générer les timestamps horaires (7 jours × 24h, format UTC)
            const _mockHours = [];
            for (let i = 0; i < 7; i++) {
                for (let h = 0; h < 24; h++) {
                    _mockHours.push(
                        `${_mockDays[i]}T${String(h).padStart(2, "0")}:00:00`,
                    );
                }
            }

            function _buildMockData(resortConfig) {
                // Températures de base selon altitude
                const altFactor = (resortConfig.altitude - 1400) / 400; // 0 pour 1400m, 1 pour 1800m
                const baseTemps = [-4, -3, -2, -1, 0, 2, 1]; // moyennes par jour
                const tempAmplitude = [3, 4, 5, 4, 3, 5, 4];

                // Conditions variées : 1=soleil, 2=peu nuageux, 4=nuageux, 6=couvert, 9=pluie, 14=neige legere, 15=neige, 17=orage neige
                const pictocodes = [2, 1, 6, 15, 14, 4, 1];
                // Vent
                const windMean = [12, 8, 25, 45, 35, 15, 10];
                const gustMin = [15, 10, 35, 55, 45, 20, 12];
                const gustMax = [25, 18, 55, 85, 65, 30, 20];
                const windDir = [180, 200, 270, 300, 290, 220, 190];
                // Precipitations
                const precip = [0, 0, 2, 18, 8, 0.5, 0];
                const snowFrac = [0, 0, 0.3, 0.9, 0.85, 0.5, 0];

                // Données journalières
                const data_day = {
                    time: [..._mockDays],
                    temperature_min: baseTemps.map(
                        (t, i) =>
                            Math.round(
                                (t - tempAmplitude[i] - altFactor * 2) * 10,
                            ) / 10,
                    ),
                    temperature_max: baseTemps.map(
                        (t, i) =>
                            Math.round(
                                (t + tempAmplitude[i] - altFactor * 2) * 10,
                            ) / 10,
                    ),
                    windspeed_mean: windMean.map(
                        (w) => w + Math.round(altFactor * 5),
                    ),
                    windspeed_min: windMean.map((w) =>
                        Math.max(2, w - 8 + Math.round(altFactor * 3)),
                    ),
                    windspeed_max: gustMax.map(
                        (w) => w + Math.round(altFactor * 5),
                    ),
                    gust_min: gustMin.map((w) => w + Math.round(altFactor * 5)),
                    gust_max: gustMax.map((w) => w + Math.round(altFactor * 5)),
                    winddirection: [...windDir],
                    precipitation: [...precip],
                    snowfraction: [...snowFrac],
                    pictocode: [...pictocodes],
                };

                // Données horaires (168 valeurs = 7 jours × 24h)
                const hourlyTemp = [];
                const hourlyWind = [];
                const hourlyGust = [];
                const hourlyDir = [];
                const hourlyPicto = [];

                for (let d = 0; d < 7; d++) {
                    const dayBaseTemp = baseTemps[d] - altFactor * 2;
                    const amp = tempAmplitude[d];
                    const dayWind = windMean[d] + Math.round(altFactor * 5);
                    const dayGust = gustMax[d] + Math.round(altFactor * 5);
                    const dayDir = windDir[d];
                    const dayPicto = pictocodes[d];

                    for (let h = 0; h < 24; h++) {
                        // Courbe de température : min à 5h, max à 14h
                        const tempFrac =
                            Math.sin(((h - 5) / 24) * Math.PI * 2) * 0.5 + 0.5;
                        const temp =
                            Math.round(
                                (dayBaseTemp - amp + tempFrac * amp * 2) * 10,
                            ) / 10;
                        hourlyTemp.push(temp);

                        // Vent : plus fort en journée
                        const windFrac =
                            h >= 10 && h <= 17 ? 1.2 : h >= 6 ? 0.9 : 0.6;
                        hourlyWind.push(Math.round(dayWind * windFrac));
                        hourlyGust.push(Math.round(dayGust * windFrac));
                        hourlyDir.push(dayDir + (h % 3) * 5 - 5);

                        // Pictocode : nuit (31-33) ou jour
                        if (h < 7 || h > 20) {
                            hourlyPicto.push(
                                dayPicto <= 2
                                    ? 31
                                    : dayPicto <= 6
                                      ? 33
                                      : dayPicto,
                            );
                        } else {
                            hourlyPicto.push(dayPicto);
                        }
                    }
                }

                const data_1h = {
                    time: [..._mockHours],
                    temperature: hourlyTemp,
                    windspeed: hourlyWind,
                    windgust: hourlyGust,
                    winddirection: hourlyDir,
                    pictocode: hourlyPicto,
                };

                return {
                    ...resortConfig,
                    data: { data_day, data_1h },
                };
            }

            const MOCK_RESULTS = DEFAULT_RESORTS.map((r) => _buildMockData(r));

            const MOCK_BRA_DATA = {
                Guzet: {
                    "aujourd'hui": {
                        bas: 3,
                        haut: 3,
                        evolution: 0,
                        date: _mockDays[0],
                    },
                    demain: { bas: 2, haut: 2, date: _mockDays[1] },
                    _detail: {
                        massifName: "Couserans",
                        massifId: 69,
                        dateBulletin: _mockDays[0] + "T16:00:00",
                        risqueMaxi: 3,
                        evoluRisque1: 0,
                        risqueMaxiJ2: 2,
                    },
                },
                "Piau-Engaly": {
                    "aujourd'hui": {
                        bas: 2,
                        haut: 3,
                        evolution: 1,
                        date: _mockDays[0],
                    },
                    demain: { bas: 3, haut: 3, date: _mockDays[1] },
                    _detail: {
                        massifName: "Aure-Louron",
                        massifId: 67,
                        dateBulletin: _mockDays[0] + "T16:00:00",
                        risqueMaxi: 3,
                        evoluRisque1: 1,
                        risqueMaxiJ2: 3,
                    },
                },
                "Saint-Lary": {
                    "aujourd'hui": {
                        bas: 2,
                        haut: 2,
                        evolution: 0,
                        date: _mockDays[0],
                    },
                    demain: { bas: 2, haut: 2, date: _mockDays[1] },
                    _detail: {
                        massifName: "Aure-Louron",
                        massifId: 67,
                        dateBulletin: _mockDays[0] + "T16:00:00",
                        risqueMaxi: 2,
                        evoluRisque1: 0,
                        risqueMaxiJ2: 2,
                    },
                },
            };

            // === CACHE MÉTÉO (localStorage, TTL 2h) ===
            const CACHE_TTL_MS = 2 * 60 * 60 * 1000; // 2 heures
            const CACHE_KEY = "weatherCache";
            const CACHE_VERSION = 6; // Incrémenter pour invalider le cache après un changement de logique

            function getWeatherCache() {
                try {
                    const raw = localStorage.getItem(CACHE_KEY);
                    if (!raw) return null;
                    const cache = JSON.parse(raw);
                    // Invalider si version différente
                    if (cache.version !== CACHE_VERSION) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    const age = Date.now() - cache.timestamp;
                    if (age > CACHE_TTL_MS) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    // Invalider le cache si aucun résultat ne contient de données
                    const hasData =
                        cache.results && cache.results.some((r) => r.data);
                    if (!hasData) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    return cache;
                } catch {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
            }

            function setWeatherCache(resorts, results, braDataObj) {
                const cache = {
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    resortKeys: resorts.map(
                        (r) => `${r.name}_${r.lat}_${r.lon}_${r.altitude}`,
                    ),
                    results,
                    braData: braDataObj,
                };
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
                } catch (e) {
                    console.warn("Cache write failed:", e);
                }
            }

            function isCacheValidForResorts(cache, resorts) {
                if (!cache) return false;
                const currentKeys = resorts.map(
                    (r) => `${r.name}_${r.lat}_${r.lon}_${r.altitude}`,
                );
                return (
                    JSON.stringify(currentKeys) ===
                    JSON.stringify(cache.resortKeys)
                );
            }

            // === Météo France BRA — API Key (header apikey:) ===
            // Générer sur https://portail-api.meteofrance.fr > Mes APIs > Générer Token
            // Mettre la durée au maximum (ex: 31536000 = 1 an) pour éviter de renouveler
            const MF_API_KEY =
                "eyJ4NXQiOiJZV0kxTTJZNE1qWTNOemsyTkRZeU5XTTRPV014TXpjek1UVmhNbU14T1RSa09ETXlOVEE0Tnc9PSIsImtpZCI6ImdhdGV3YXlfY2VydGlmaWNhdGVfYWxpYXMiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ0ZGF1dmV0QGNhcmJvbi5zdXBlciIsImFwcGxpY2F0aW9uIjp7Im93bmVyIjoidGRhdXZldCIsInRpZXJRdW90YVR5cGUiOm51bGwsInRpZXIiOiJVbmxpbWl0ZWQiLCJuYW1lIjoiRGVmYXVsdEFwcGxpY2F0aW9uIiwiaWQiOjM2OTU0LCJ1dWlkIjoiOWI5Y2VhNDAtYmEwZi00YzVhLTgwNDctM2EwYjM3NWQyODM3In0sImlzcyI6Imh0dHBzOlwvXC9wb3J0YWlsLWFwaS5tZXRlb2ZyYW5jZS5mcjo0NDNcL29hdXRoMlwvdG9rZW4iLCJ0aWVySW5mbyI6eyI1MFBlck1pbiI6eyJ0aWVyUXVvdGFUeXBlIjoicmVxdWVzdENvdW50IiwiZ3JhcGhRTE1heENvbXBsZXhpdHkiOjAsImdyYXBoUUxNYXhEZXB0aCI6MCwic3RvcE9uUXVvdGFSZWFjaCI6dHJ1ZSwic3Bpa2VBcnJlc3RMaW1pdCI6MCwic3Bpa2VBcnJlc3RVbml0Ijoic2VjIn19LCJrZXl0eXBlIjoiUFJPRFVDVElPTiIsInN1YnNjcmliZWRBUElzIjpbeyJzdWJzY3JpYmVyVGVuYW50RG9tYWluIjoiY2FyYm9uLnN1cGVyIiwibmFtZSI6IkRvbm5lZXNQdWJsaXF1ZXNCUkEiLCJjb250ZXh0IjoiXC9wdWJsaWNcL0RQQlJBXC92MSIsInB1Ymxpc2hlciI6ImJhc3RpZW5nIiwidmVyc2lvbiI6InYxIiwic3Vic2NyaXB0aW9uVGllciI6IjUwUGVyTWluIn1dLCJleHAiOjE4MDIzODIxMDEsInRva2VuX3R5cGUiOiJhcGlLZXkiLCJpYXQiOjE3NzA4NDYxMDEsImp0aSI6IjhkYzI2MjU0LTlmZTktNGIwNC1iYTQyLWIxNzhkZmQzMzI3MCJ9.T0Sah5HGtP61Lk2f7dUMVqxQUTj0kiOz0yn_ceaHuy_gtUSHFfZ0SDec28M72AHqh12On_IETCDNRFR90mrlzbWUTREK8h8b5GvR-wRtPrBAze0WQ_1GhSsOIMcHCETqioCSa84kAy6Kv1yazPlkHnP5Cn9ZNzB5K_x8Dqo1kyyNazuO-7lpnkovmWMg-vnCVYEGmkWaFPPQTpOR_uBn84hiEb1PoG0RJ5vjl5Yxv72kJ24uWSwS-hBQbxsXNhB_ddPTEdd4WIiwuC_wZ7aNsFRplJMCmgCeH7K0sRKy4sLWB4kuQuTozrIgeWny9q_QDlzpc73ZQBV4sSbXF_FcOg==";

            /**
             * Récupère les données BRA (Bulletin Risque Avalanche) pour un massif
             * @param {number} massifId - ID du massif Météo France
             * @returns {Promise<object>} Données BRA
             */
            async function fetchBRAData(massifId) {
                if (!massifId) return null;

                const baseUrl =
                    "https://public-api.meteofrance.fr/public/DPBRA/v1";
                const headers = {
                    apikey: MF_API_KEY,
                };

                try {
                    // Récupérer le XML du bulletin
                    const response = await fetch(
                        `${baseUrl}/massif/BRA?id-massif=${massifId}&format=xml`,
                        { headers },
                    );

                    if (!response.ok) {
                        console.warn(
                            `BRA indisponible pour massif ${massifId}: ${response.status}`,
                        );
                        return null;
                    }

                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                    // Extraire le risque depuis CARTOUCHERISQUE > RISQUE
                    const risqueEl = xmlDoc.querySelector(
                        "CARTOUCHERISQUE RISQUE",
                    );
                    if (!risqueEl) {
                        console.warn(
                            `BRA: pas de balise RISQUE pour massif ${massifId}`,
                        );
                        return null;
                    }

                    const dateBulletin =
                        xmlDoc.documentElement.getAttribute("DATEBULLETIN");
                    const dateEcheance =
                        xmlDoc.documentElement.getAttribute("DATEECHEANCE");

                    // Risque J1 : RISQUE1 est le risque principal, EVOLURISQUE1 l'évolution
                    const risque1 =
                        parseInt(risqueEl.getAttribute("RISQUE1")) || 0;
                    const evoluRisque1 =
                        parseInt(risqueEl.getAttribute("EVOLURISQUE1")) || 0;
                    const risqueMaxi =
                        parseInt(risqueEl.getAttribute("RISQUEMAXI")) ||
                        risque1;

                    // Risque J2
                    const risqueMaxiJ2 =
                        parseInt(risqueEl.getAttribute("RISQUEMAXIJ2")) || 0;

                    // LOC1/LOC2 pour risques différenciés par altitude (ex: "<2400" / ">2400")
                    const loc1 = risqueEl.getAttribute("LOC1") || "";
                    const loc2 = risqueEl.getAttribute("LOC2") || "";
                    const risque2 =
                        parseInt(risqueEl.getAttribute("RISQUE2")) || 0;

                    const braData = {};

                    // Aujourd'hui (J1) — risque maxi, ou différencié bas/haut si LOC1/LOC2 renseignés
                    if (loc1 && loc2 && risque2) {
                        braData["aujourd'hui"] = {
                            bas: risque1,
                            haut: risque2,
                            evolution: evoluRisque1,
                            date: dateEcheance,
                        };
                    } else {
                        braData["aujourd'hui"] = {
                            bas: risqueMaxi,
                            haut: risqueMaxi,
                            evolution: evoluRisque1,
                            date: dateEcheance,
                        };
                    }

                    // Demain (J2)
                    if (risqueMaxiJ2) {
                        const dateJ2 =
                            risqueEl.getAttribute("DATE_RISQUE_J2") || "";
                        braData["demain"] = {
                            bas: risqueMaxiJ2,
                            haut: risqueMaxiJ2,
                            date: dateJ2,
                        };
                    }

                    // Extraire les infos détaillées du BERA
                    const massifName =
                        xmlDoc.documentElement.getAttribute("MASSIF") || "";
                    const commentaireRisque =
                        risqueEl.getAttribute("COMMENTAIRE") || "";
                    const resume =
                        xmlDoc.querySelector("CARTOUCHERISQUE RESUME")
                            ?.textContent || "";
                    const stabilite =
                        xmlDoc.querySelector("STABILITE TEXTESANSTITRE")
                            ?.textContent || "";
                    const qualiteNeige =
                        xmlDoc.querySelector("QUALITE TEXTE")?.textContent ||
                        "";

                    // Enneigement
                    const enneigementEl = xmlDoc.querySelector("ENNEIGEMENT");
                    const enneigement = enneigementEl
                        ? {
                              limiteSud:
                                  enneigementEl.getAttribute("LimiteSud"),
                              limiteNord:
                                  enneigementEl.getAttribute("LimiteNord"),
                          }
                        : null;

                    // Pentes exposées
                    const penteEl = xmlDoc.querySelector(
                        "CARTOUCHERISQUE PENTE",
                    );
                    const pentes = penteEl
                        ? ["N", "NE", "E", "SE", "S", "SW", "W", "NW"].filter(
                              (d) => penteEl.getAttribute(d) === "true",
                          )
                        : [];

                    braData._detail = {
                        massifName,
                        massifId,
                        dateBulletin,
                        commentaireRisque,
                        resume,
                        stabilite,
                        qualiteNeige,
                        enneigement,
                        pentes,
                        risqueMaxi,
                        evoluRisque1,
                        risqueMaxiJ2,
                    };

                    return Object.keys(braData).length > 0 ? braData : null;
                } catch (error) {
                    console.error(`Erreur BRA pour massif ${massifId}:`, error);
                    return null;
                }
            }

            /**
             * Retourne la couleur selon le niveau de risque
             * @param {number} niveau - Niveau de risque (1-5)
             * @returns {string} Code couleur
             */
            function getBRAColor(niveau) {
                switch (niveau) {
                    case 1:
                        return "#27ae60"; // Vert
                    case 2:
                        return "#f1c40f"; // Jaune
                    case 3:
                        return "#e67e22"; // Orange
                    case 4:
                    case 5:
                        return "#e74c3c"; // Rouge
                    default:
                        return "#95a5a6"; // Gris
                }
            }

            // Weather codes importés depuis weatherCodes.js
            // Fonctions disponibles: getWeatherInfo(code, hour), adjustWeatherCodeForDaylight(code, hour)

            /**
             * Convertit une direction en degrés en flèche et point cardinal
             * @param {number} degrees - Direction en degrés (0-360)
             * @returns {object} { arrow: string, cardinal: string }
             */
            function getWindDirectionDisplay(degrees) {
                if (degrees === null || degrees === undefined) {
                    return { cardinal: "" };
                }

                // Normaliser entre 0-360
                const normalized = ((degrees % 360) + 360) % 360;

                // Points cardinaux (8 directions)
                const cardinals = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];

                const index = Math.round(normalized / 45) % 8;
                return { cardinal: cardinals[index] };
            }

            /**
             * Couleur du vent selon la vitesse (km/h)
             */
            function getWindColor(speed) {
                if (speed >= 80) return "#c0392b"; // rouge — dangereux
                if (speed >= 50) return "#e67e22"; // orange — très fort
                if (speed >= 30) return "#f39c12"; // jaune-orange — fort
                return "inherit";
            }

            /**
             * Génère l'URL Meteoblue pour un secteur
             * @param {string} name - Nom du secteur
             * @param {number} lat - Latitude
             * @param {number} lon - Longitude
             * @returns {string} URL Meteoblue
             */
            function getMeteoblueUrl(resort) {
                if (resort.mbUrl) {
                    return `https://www.meteoblue.com/fr/meteo/semaine/${resort.mbUrl}`;
                }
                // Fallback : URL basée sur les coordonnées (moins fiable)
                const slug = resort.name
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/^-+|-+$/g, "");
                return `https://www.meteoblue.com/fr/meteo/semaine/${slug}?lat=${resort.lat}&lon=${resort.lon}&asl=${resort.altitude}`;
            }

            function AddResortModal({ isOpen, onClose, onAdd }) {
                const [searchQuery, setSearchQuery] = useState("");
                const [searchResults, setSearchResults] = useState([]);
                const [isSearching, setIsSearching] = useState(false);

                const searchLocation = async (query) => {
                    if (query.length < 3) {
                        setSearchResults([]);
                        return;
                    }

                    setIsSearching(true);
                    try {
                        const url = `https://www.meteoblue.com/en/server/search/query3?query=${encodeURIComponent(query)}&apikey=${API_KEY}`;
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.results) {
                            setSearchResults(data.results.slice(0, 10));
                        }
                    } catch (err) {
                        console.error("Erreur recherche:", err);
                        setSearchResults([]);
                    } finally {
                        setIsSearching(false);
                    }
                };

                useEffect(() => {
                    const timer = setTimeout(() => {
                        if (searchQuery) {
                            searchLocation(searchQuery);
                        }
                    }, 500);

                    return () => clearTimeout(timer);
                }, [searchQuery]);

                const handleSelect = (location) => {
                    // --- DÉBUT DE L'AJOUT GOOGLE ANALYTICS ---
                    if (typeof gtag === 'function') {
                        gtag('event', 'ajout_secteur', {
                            'nom_secteur': location.name,      // ex: Guzet
                            'region_secteur': location.admin1, // ex: Occitanie
                            'altitude_secteur': location.asl   // ex: 1400
                        });
                    }
                    // --- FIN DE L'AJOUT ---
                    
                    onAdd({
                        name: location.name,
                        lat: location.lat,
                        lon: location.lon,
                        altitude: location.asl || 1000,
                        mbUrl: location.url || null,
                    });
                    setSearchQuery("");
                    setSearchResults([]);
                    onClose();
                };

                if (!isOpen) return null;

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div
                            className="modal"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h2 className="title" style={{marginBottom:'4px'}}>Ajouter un Secteur</h2>
                            <p className="subtitle" style={{marginBottom:'20px'}}>Entrer le nom d'une station, d'un pic pour l'ajouter. Les données sont fournis par meteoblue.</p>

                            <input
                                type="text"
                                className="input search-input"
                                placeholder="Rechercher une commune (min. 3 caractères - ex: Guzet, Saint-Lary...)"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                autoFocus
                            />

                            <div className="search-results">
                                {isSearching && (
                                    <div className="loading-search">
                                        <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.search}}></span> Recherche en cours...
                                    </div>
                                )}

                                {!isSearching &&
                                    searchResults.length === 0 &&
                                    searchQuery.length >= 3 && (
                                        <div className="no-results">
                                            Aucun résultat trouvé. Essayez une
                                            autre recherche.
                                        </div>
                                    )}

                                {!isSearching &&
                                    searchQuery.length > 0 &&
                                    searchQuery.length < 3 && (
                                        <div className="no-results">
                                            Tapez au moins 3 caractères pour
                                            lancer la recherche.
                                        </div>
                                    )}

                                {!isSearching &&
                                    searchResults.map((result, index) => (
                                        <div
                                            key={index}
                                            className="search-result-item"
                                            onClick={() => handleSelect(result)}
                                        >
                                            <div className="result-name">
                                                {result.name}
                                            </div>
                                            <div className="result-info">
                                                {result.country || ""}{" "}
                                                {result.admin1
                                                    ? `• ${result.admin1}`
                                                    : ""}{" "}
                                                {result.asl
                                                    ? `• Alt: ${result.asl}m`
                                                    : ""}
                                            </div>
                                        </div>
                                    ))}
                            </div>

                            <div className="modal-buttons">
                                <button
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            function MountainWeatherApp() {
                const [resorts, setResorts] = useState(() => {
                    const saved = localStorage.getItem("skiResorts");
                    return saved ? JSON.parse(saved) : DEFAULT_RESORTS;
                });
                const [weatherData, setWeatherData] = useState([]);
                const [snowData, setSnowData] = useState([]);
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);
                const [currentDate, setCurrentDate] = useState("");
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [lastUpdate, setLastUpdate] = useState(null);
                const [apiCallsLog, setApiCallsLog] = useState(() => {
                    const saved = localStorage.getItem("apiCallsLog");
                    return saved ? JSON.parse(saved) : [];
                });
                const [viewMode, setViewMode] = useState("day"); // 'day' ou 'hourly'
                const [braData, setBraData] = useState({}); // { resortName: { aujourd'hui: {bas, haut}, demain: {bas, haut}, _detail: {...} } }
                const [beraModal, setBeraModal] = useState(null); // { resortName, detail } ou null
                const [loadedFromCache, setLoadedFromCache] = useState(false);


                // Logger un appel API
                const logApiCall = (
                    resortName,
                    success = true,
                    errorMsg = null,
                ) => {
                    const logEntry = {
                        timestamp: new Date().toISOString(),
                        resort: resortName,
                        success,
                        error: errorMsg,
                        dateFormatted: new Date().toLocaleString("fr-FR"),
                    };

                    const updatedLog = [...apiCallsLog, logEntry];
                    setApiCallsLog(updatedLog);
                    localStorage.setItem(
                        "apiCallsLog",
                        JSON.stringify(updatedLog),
                    );

                    console.log("📊 Appel API:", logEntry);
                };

                // Télécharger le fichier de log
                const downloadLog = () => {
                    const logText = apiCallsLog
                        .map(
                            (entry) =>
                                `${entry.dateFormatted} | ${entry.resort} | ${entry.success ? "SUCCESS" : "FAILED"} ${entry.error ? `| Error: ${entry.error}` : ""}`,
                        )
                        .join("\n");

                    const blob = new Blob([logText], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `meteoblue-api-log-${new Date().toISOString().split("T")[0]}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                // Réinitialiser le log
                const clearLog = () => {
                    setApiCallsLog([]);
                    localStorage.setItem("apiCallsLog", JSON.stringify([]));
                    console.log("🗑️ Log des appels API réinitialisé");
                };

                // Calculer les statistiques
                const getApiStats = () => {
                    const today = new Date().toDateString();
                    const todayCalls = apiCallsLog.filter(
                        (log) =>
                            new Date(log.timestamp).toDateString() === today,
                    );

                    return {
                        total: apiCallsLog.length,
                        today: todayCalls.length,
                        failed: apiCallsLog.filter((log) => !log.success)
                            .length,
                    };
                };

                useEffect(() => {
                    const now = new Date();
                    setCurrentDate(
                        now.toLocaleDateString("fr-FR", {
                            weekday: "long",
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        }) +
                            " à " +
                            now.toLocaleTimeString("fr-FR", {
                                hour: "2-digit",
                                minute: "2-digit",
                            }),
                    );

                    // Charger la dernière mise à jour depuis localStorage
                    const savedUpdate =
                        localStorage.getItem("lastWeatherUpdate");
                    if (savedUpdate) {
                        setLastUpdate(savedUpdate);
                    }

                    // Charger les données au premier chargement (ignore les restrictions)
                    if (resorts.length > 0) {
                        loadInitialWeatherData();
                    }
                }, []);

                const loadInitialWeatherData = async () => {
                    // Mode mock : fausses données, aucun appel API
                    if (USE_MOCK_DATA) {
                        console.log("🎭 Mode MOCK actif — aucun appel API");
                        processWeatherData(MOCK_RESULTS);
                        processSnowData(MOCK_RESULTS);
                        setBraData(MOCK_BRA_DATA);
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                        return;
                    }

                    // Vérifier le cache avant d'appeler l'API
                    const cache = getWeatherCache();
                    if (cache && isCacheValidForResorts(cache, resorts)) {
                        const cacheAgeMin = Math.round(
                            (Date.now() - cache.timestamp) / 60000,
                        );
                        console.log(
                            `📦 Cache valide (${cacheAgeMin} min) — aucun appel API`,
                        );

                        processWeatherData(cache.results);
                        processSnowData(cache.results);
                        if (cache.braData) setBraData(cache.braData);
                        setLoadedFromCache(true);

                        const cachedDate = new Date(cache.timestamp);
                        setLastUpdate(cachedDate.toISOString());
                        setCurrentDate(
                            cachedDate.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                cachedDate.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                        return;
                    }

                    console.log("🌐 Pas de cache valide — appel API Meteoblue");
                    setLoadedFromCache(false);
                    setLoading(true);
                    setError(null);

                    try {
                        const promises = resorts.map((resort) =>
                            fetchWeatherForResort(resort),
                        );
                        const results = await Promise.all(promises);

                        processWeatherData(results);
                        processSnowData(results);

                        // Charger les données BRA pour tous les secteurs
                        const braPromises = resorts.map(async (resort) => {
                            const massif = getMassifFromCoords(
                                resort.lat,
                                resort.lon,
                                resort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                return data
                                    ? { name: resort.name, data }
                                    : null;
                            }
                            return null;
                        });

                        const braResults = await Promise.all(braPromises);
                        const braDataObj = {};
                        braResults.forEach((result) => {
                            if (result) {
                                braDataObj[result.name] = result.data;
                            }
                        });
                        setBraData(braDataObj);

                        // Sauvegarder dans le cache
                        setWeatherCache(resorts, results, braDataObj);

                        // Enregistrer l'heure de mise à jour
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        localStorage.setItem(
                            "lastWeatherUpdate",
                            now.toISOString(),
                        );

                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                    } catch (err) {
                        setError(
                            `Erreur lors de la récupération des données: ${err.message}`,
                        );
                    } finally {
                        setLoading(false);
                    }
                };

                useEffect(() => {
                    localStorage.setItem("skiResorts", JSON.stringify(resorts));
                }, [resorts]);

                const addResort = async (newResort) => {
                    // Ajouter le secteur à la liste
                    const updatedResorts = [...resorts, newResort];
                    setResorts(updatedResorts);

                    // Charger uniquement les données pour ce nouveau secteur (sans loading général)
                    try {
                        const result = await fetchWeatherForResort(newResort);

                        // Ajouter les données météo du nouveau secteur
                        if (result.data) {
                            const newWeatherData =
                                processWeatherDataForResort(result);
                            const newSnowData =
                                processSnowDataForResort(result);

                            if (newWeatherData) {
                                setWeatherData((prev) => [
                                    ...prev,
                                    newWeatherData,
                                ]);
                            }
                            if (newSnowData) {
                                setSnowData((prev) => [...prev, newSnowData]);
                            }

                            // Récupérer les données BRA pour ce secteur
                            const massif = getMassifFromCoords(
                                newResort.lat,
                                newResort.lon,
                                newResort.name,
                            );
                            if (massif) {
                                console.log(
                                    `🏔️ Massif détecté pour ${newResort.name}: ${massif.name} (ID ${massif.id})`,
                                );
                                const data = await fetchBRAData(massif.id);
                                if (data) {
                                    setBraData((prev) => ({
                                        ...prev,
                                        [newResort.name]: data,
                                    }));
                                }
                            }
                        }
                        // Invalider le cache (la liste de stations a changé)
                        localStorage.removeItem(CACHE_KEY);
                    } catch (err) {
                        console.error(
                            "Erreur lors de l'ajout du secteur:",
                            err,
                        );
                    }
                };

                const removeResort = (index) => {
                    // Retirer le secteur et ses données
                    const newResorts = resorts.filter((_, i) => i !== index);
                    setResorts(newResorts);
                    setWeatherData((prev) =>
                        prev.filter((_, i) => i !== index),
                    );
                    setSnowData((prev) => prev.filter((_, i) => i !== index));
                    // Invalider le cache (la liste de stations a changé)
                    localStorage.removeItem(CACHE_KEY);
                };

                const fetchWeatherForResort = async (resort) => {
                    // Utiliser le package qui inclut les données horaires
                    const url = `https://my.meteoblue.com/packages/basic-1h_basic-day_snowice-day_wind-1h_wind-day?apikey=${API_KEY}&lat=${resort.lat}&lon=${resort.lon}&asl=${resort.altitude}&format=json`;

                    // DEBUG pour Pic de Lurtet
                    const isPicLurtet = resort.name
                        .toLowerCase()
                        .includes("lurtet");
                    if (isPicLurtet) {
                        console.log(
                            "🌐 ========== APPEL API PIC DE LURTET ==========",
                        );
                        console.log("📍 Coordonnées utilisées:");
                        console.log("   Latitude:", resort.lat);
                        console.log("   Longitude:", resort.lon);
                        console.log("   Altitude:", resort.altitude);
                        console.log(
                            "🔗 URL API (sans clé):",
                            url.replace(API_KEY, "XXX"),
                        );
                    }

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            logApiCall(
                                resort.name,
                                false,
                                `HTTP ${response.status}`,
                            );
                            throw new Error(
                                `Erreur API pour ${resort.name}: ${response.status}`,
                            );
                        }
                        const data = await response.json();
                        logApiCall(resort.name, true);

                        if (isPicLurtet) {
                            console.log(
                                "✅ Réponse API reçue pour Pic de Lurtet",
                            );
                            console.log(
                                "🌐 ========== FIN APPEL API ==========",
                            );
                        }

                        return { ...resort, data };
                    } catch (err) {
                        console.error(`Erreur pour ${resort.name}:`, err);
                        logApiCall(resort.name, false, err.message);
                        return { ...resort, data: null, error: err.message };
                    }
                };

                const fetchAllWeatherData = async () => {
                    // Mode mock : pas d'appel API
                    if (USE_MOCK_DATA) {
                        console.log("🎭 Mode MOCK — actualisation simulée");
                        processWeatherData(MOCK_RESULTS);
                        processSnowData(MOCK_RESULTS);
                        setBraData(MOCK_BRA_DATA);
                        return;
                    }

                    console.log(
                        "🔄 Actualisation forcée — appel API Meteoblue",
                    );
                    setLoadedFromCache(false);
                    setLoading(true);
                    setError(null);

                    try {
                        const promises = resorts.map((resort) =>
                            fetchWeatherForResort(resort),
                        );
                        const results = await Promise.all(promises);

                        processWeatherData(results);
                        processSnowData(results);

                        // Recharger les BRA aussi
                        const braPromises = resorts.map(async (resort) => {
                            const massif = getMassifFromCoords(
                                resort.lat,
                                resort.lon,
                                resort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                return data
                                    ? { name: resort.name, data }
                                    : null;
                            }
                            return null;
                        });
                        const braResults = await Promise.all(braPromises);
                        const braDataObj = {};
                        braResults.forEach((result) => {
                            if (result) braDataObj[result.name] = result.data;
                        });
                        setBraData(braDataObj);

                        // Sauvegarder dans le cache
                        setWeatherCache(resorts, results, braDataObj);

                        // Enregistrer l'heure de mise à jour
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        localStorage.setItem(
                            "lastWeatherUpdate",
                            now.toISOString(),
                        );

                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                    } catch (err) {
                        setError(
                            `Erreur lors de la récupération des données: ${err.message}`,
                        );
                    } finally {
                        setLoading(false);
                    }
                };

                const getDayLabel = (offset) => {
                    const date = new Date();
                    date.setDate(date.getDate() + offset);

                    if (offset === 0) return "Aujourd'hui";
                    if (offset === 1) return "Demain";

                    // Pour J+2 et plus : afficher le jour de la semaine + date
                    const dayName = date.toLocaleDateString("fr-FR", {
                        weekday: "long",
                    });
                    const dateStr = date.toLocaleDateString("fr-FR", {
                        day: "2-digit",
                        month: "2-digit",
                    });
                    return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${dateStr}`;
                };

                const processWeatherDataForResort = (resort) => {
                    if (!resort.data || !resort.data.data_day) {
                        console.log(
                            "Pas de données journalières pour",
                            resort.name,
                        );
                        return null;
                    }

                    const dayData = resort.data.data_day;
                    const hourData = resort.data.data_1h; // Données horaires
                    const days = {};

                    // DEBUG APPROFONDI pour Pic de Lurtet
                    const isPicLurtet = resort.name
                        .toLowerCase()
                        .includes("lurtet");
                    if (isPicLurtet) {
                        console.log(
                            "🔍 ========== DEBUG PIC DE LURTET ==========",
                        );
                        console.log("📍 Coordonnées:", {
                            lat: resort.lat,
                            lon: resort.lon,
                            altitude: resort.altitude,
                        });
                        console.log(
                            "📅 Date actuelle:",
                            new Date().toISOString(),
                        );
                        console.log(
                            "📊 Données journalières (data_day.time):",
                            dayData.time,
                        );
                        console.log(
                            "🌡️ Températures min:",
                            dayData.temperature_min,
                        );
                        console.log(
                            "🌡️ Températures max:",
                            dayData.temperature_max,
                        );

                        if (hourData && hourData.time) {
                            console.log(
                                "⏰ Premier timestamp horaire:",
                                hourData.time[0],
                            );
                            console.log(
                                "⏰ Dernier timestamp horaire:",
                                hourData.time[hourData.time.length - 1],
                            );
                            console.log(
                                "📊 Nombre total d'heures:",
                                hourData.time.length,
                            );
                        }
                    }

                    // ✅ CORRECTION FINALE : Trouver dynamiquement l'index qui correspond à aujourd'hui
                    const today = new Date();
                    const todayStr = today.toISOString().split("T")[0]; // "2026-02-09"

                    let todayIndex = -1;
                    for (let i = 0; i < dayData.time.length; i++) {
                        if (dayData.time[i] === todayStr) {
                            todayIndex = i;
                            break;
                        }
                    }

                    if (isPicLurtet) {
                        console.log(
                            "🎯 Recherche de la date d'aujourd'hui:",
                            todayStr,
                        );
                        console.log(
                            "📌 Index trouvé pour aujourd'hui:",
                            todayIndex,
                        );
                    }

                    // Si on ne trouve pas aujourd'hui, utiliser le premier jour disponible
                    if (todayIndex === -1) {
                        if (isPicLurtet) {
                            console.log(
                                "⚠️ Aujourd'hui non trouvé dans les données",
                            );
                            console.log(
                                "   Les données commencent à:",
                                dayData.time[0],
                            );
                        }
                        todayIndex = 0;
                    }

                    console.log("Traitement des données pour", resort.name);
                    console.log(
                        "- Données journalières (data_day):",
                        dayData ? "OK" : "Manquant",
                    );
                    console.log(
                        "- Données horaires (data_1h):",
                        hourData ? "OK" : "Manquant",
                    );
                    console.log(
                        "- Index aujourd'hui:",
                        todayIndex,
                        "→",
                        dayData.time[todayIndex],
                    );

                    // On récupère 5 jours : aujourd'hui + 4 jours futurs
                    for (let offset = 0; offset <= 4; offset++) {
                        const dataIndex = todayIndex + offset;

                        if (dataIndex >= 0 && dataIndex < dayData.time.length) {
                            const weatherCode =
                                dayData.pictocode?.[dataIndex] || 1;
                            const weatherInfo = getWeatherInfo(weatherCode);

                            // DEBUG pour Pic de Lurtet
                            if (isPicLurtet) {
                                console.log(
                                    `📆 Offset ${offset} (${offset === 0 ? "AUJOURD'HUI" : offset > 0 ? "J+" + offset : "J" + offset}):`,
                                );
                                console.log(
                                    `   Date: ${dayData.time[dataIndex]}`,
                                );
                                console.log(
                                    `   Temp min/max: ${dayData.temperature_min[dataIndex]}° / ${dayData.temperature_max[dataIndex]}°`,
                                );
                            }

                            // Extraire les données horaires pour ce jour
                            let hourlyData = null;
                            if (hourData && hourData.time) {
                                const targetDate = dayData.time[dataIndex];
                                if (isPicLurtet) {
                                    console.log(
                                        `   🔍 Extraction horaire pour: ${targetDate}`,
                                    );
                                }
                                hourlyData = extractHourlyData(
                                    hourData,
                                    targetDate,
                                    isPicLurtet,
                                );
                            }

                            // Neige en cm : snowfraction * precipitation
                            const snowFraction =
                                dayData.snowfraction?.[dataIndex] || 0;
                            const precip =
                                dayData.precipitation?.[dataIndex] || 0;
                            const snowCm = Math.round(
                                (snowFraction * precip) / 10,
                            );
                            const rainMm = Math.round(
                                (1 - snowFraction) * precip,
                            );

                            days[offset] = {
                                offset,
                                date: dayData.time?.[dataIndex] || "",
                                condition: weatherInfo.desc,
                                icon: weatherInfo.icon,
                                temp_max:
                                    dayData.temperature_max?.[dataIndex] || 0,
                                temp_min:
                                    dayData.temperature_min?.[dataIndex] || 0,
                                wind_mean:
                                    dayData.windspeed_mean?.[dataIndex] || 0,
                                gust_min: dayData.gust_min?.[dataIndex] || 0,
                                gust_max: dayData.gust_max?.[dataIndex] || 0,
                                windDirection:
                                    dayData.winddirection?.[dataIndex] || null,
                                precipitation: precip,
                                snowCm,
                                rainMm,
                                hourly: hourlyData,
                            };
                        }
                    }

                    if (isPicLurtet) {
                        console.log(
                            "🔍 ========== FIN DEBUG PIC DE LURTET ==========",
                        );
                    }

                    return {
                        name: resort.name,
                        days,
                    };
                };

                const extractHourlyData = (
                    hourData,
                    targetDate,
                    debugMode = false,
                ) => {
                    if (!hourData || !hourData.time) {
                        if (debugMode)
                            console.log(
                                "   ⚠️ Pas de données horaires disponibles",
                            );
                        return null;
                    }

                    // DEBUG : Afficher toutes les clés disponibles dans hourData
                    if (debugMode) {
                        console.log(
                            "   📋 Variables disponibles dans data_1h:",
                            Object.keys(hourData).join(", "),
                        );
                    }

                    // NOUVEAU : Toutes les heures de 1h à 23h (comme Meteoblue)
                    const requestedHours = [
                        1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
                        17, 18, 19, 20, 21, 22, 23,
                    ];
                    const result = {};

                    if (debugMode) {
                        console.log(
                            "   🔎 Recherche horaires pour:",
                            targetDate,
                        );
                        console.log(
                            "   📊 Exemples de timestamps:",
                            hourData.time.slice(0, 5),
                        );
                    }

                    // Vérifier si les timestamps sont en UTC
                    const firstTimestamp = hourData.time[0] || "";
                    const isUTC =
                        firstTimestamp.includes("Z") ||
                        !firstTimestamp.includes(" ");

                    if (debugMode && isUTC) {
                        console.log(
                            "   ⚠️ Timestamps en UTC détectés - ajustement UTC+1 appliqué",
                        );
                    }

                    for (let i = 0; i < hourData.time.length; i++) {
                        const timeStr = hourData.time[i];

                        if (!timeStr.startsWith(targetDate)) continue;

                        // Extraire l'heure du timestamp
                        let hour;
                        if (timeStr.includes("T")) {
                            const timePart = timeStr.split("T")[1];
                            hour = parseInt(timePart.substring(0, 2));
                        } else if (timeStr.includes(" ")) {
                            const timePart = timeStr.split(" ")[1];
                            hour = parseInt(timePart.substring(0, 2));
                        } else {
                            continue;
                        }

                        // Conversion UTC → Local si nécessaire
                        let localHour = hour;
                        if (isUTC) {
                            localHour = hour + 1;
                            if (localHour >= 24) localHour -= 24;
                        }

                        if (requestedHours.includes(localHour)) {
                            const weatherCode = hourData.pictocode?.[i] || 1;

                            // CORRECTION : Remplacer les codes NUIT par codes JOUR si l'heure est en journée
                            let adjustedCode = weatherCode;
                            if (localHour >= 6 && localHour <= 20) {
                                // C'est le jour, convertir les codes nuit en codes jour
                                if (weatherCode === 31) adjustedCode = 1; // Nuit claire → Ensoleillé
                                if (weatherCode === 32) adjustedCode = 2; // Nuit peu nuageuse → Peu nuageux
                                if (weatherCode === 33) adjustedCode = 4; // Nuit nuageuse → Nuageux
                            }

                            const weatherInfo = getWeatherInfo(
                                adjustedCode,
                                localHour,
                            );
                            const temp = Math.round(
                                hourData.temperature?.[i] || 0,
                            );

                            // Vent : windspeed et gust séparés
                            const wind = Math.round(
                                hourData.windspeed?.[i] || 0,
                            );
                            const gust = Math.round(
                                hourData.windgust?.[i] ||
                                    hourData.windspeed?.[i] ||
                                    0,
                            );

                            // NOUVEAU : Direction du vent
                            const windDirection =
                                hourData.winddirection?.[i] || null;
                            let windDirCard = "";
                            if (windDirection !== null) {
                                // Convertir degrés en points cardinaux
                                const dirs = [
                                    "N",
                                    "NE",
                                    "E",
                                    "SE",
                                    "S",
                                    "SW",
                                    "W",
                                    "NW",
                                ];
                                const index =
                                    Math.round((windDirection % 360) / 45) % 8;
                                windDirCard = dirs[index];
                            }

                            result[localHour] = {
                                temp,
                                wind,
                                gust,
                                windDirection,
                                windDirectionCardinal: windDirCard,
                                icon: weatherInfo.icon,
                                condition: weatherInfo.desc,
                                timestamp: timeStr,
                                weatherCode: adjustedCode,
                                originalCode: weatherCode,
                            };

                            if (debugMode) {
                                console.log(
                                    `   ✓ ${localHour}h (${isUTC ? hour + "h UTC" : "locale"}): temp=${temp}°, vent=${wind}km/h, raf=${gust}km/h ${windDirCard}, code=${weatherCode}${weatherCode !== adjustedCode ? "→" + adjustedCode : ""}, icône=${weatherInfo.icon} [${timeStr}]`,
                                );
                            }
                        }
                    }

                    if (Object.keys(result).length === 0) {
                        if (debugMode) {
                            console.log(
                                "   ⚠️ Aucune donnée horaire trouvée pour",
                                targetDate,
                            );
                        }
                        return null;
                    }

                    return result;
                };

                const getTempTrend = (temp1, temp2) => {
                    const diff = temp2 - temp1;
                    if (Math.abs(diff) < 1)
                        return { symbol: "→", class: "trend-stable" };
                    if (diff > 0) return { symbol: "↗", class: "trend-up" };
                    return { symbol: "↘", class: "trend-down" };
                };

                const getWindTrend = (wind1, wind2) => {
                    const diff = wind2 - wind1;
                    if (Math.abs(diff) < 3)
                        return { symbol: "→", class: "trend-stable" };
                    if (diff > 0) return { symbol: "↗", class: "trend-up" };
                    return { symbol: "↘", class: "trend-down" };
                };

                const processSnowDataForResort = (resort) => {
                    if (!resort.data || !resort.data.data_day) {
                        return null;
                    }

                    const dayData = resort.data.data_day;
                    const snowByDay = [];

                    // ✅ CORRECTION : Trouver dynamiquement l'index qui correspond à aujourd'hui
                    const today = new Date();
                    const todayStr = today.toISOString().split("T")[0];

                    let todayIndex = -1;
                    for (let i = 0; i < dayData.time.length; i++) {
                        if (dayData.time[i] === todayStr) {
                            todayIndex = i;
                            break;
                        }
                    }

                    // Si on ne trouve pas aujourd'hui, utiliser le premier jour disponible
                    if (todayIndex === -1) {
                        todayIndex = 0;
                    }

                    // Calculer les chutes de neige pour 7 jours (de -2 à +4)
                    for (let offset = -2; offset <= 4; offset++) {
                        const dataIndex = todayIndex + offset; // ✅ Calculé depuis todayIndex

                        if (dataIndex >= 0 && dataIndex < dayData.time.length) {
                            const snowFraction =
                                dayData.snowfraction?.[dataIndex] || 0;
                            const precipitation =
                                dayData.precipitation?.[dataIndex] || 0;
                            const snowCm = Math.round(
                                (snowFraction * precipitation) / 10,
                            );
                            snowByDay.push(snowCm);
                        } else {
                            snowByDay.push(0);
                        }
                    }

                    return {
                        name: resort.name,
                        snowByDay,
                    };
                };

                const processWeatherData = (results) => {
                    const processed = results
                        .map((resort) => processWeatherDataForResort(resort))
                        .filter(Boolean);
                    setWeatherData(processed);
                };

                const processSnowData = (results) => {
                    const processed = results
                        .map((resort) => processSnowDataForResort(resort))
                        .filter(Boolean);
                    setSnowData(processed);
                };

                if (loading) {
                    return (
                        <div className="container">
                            <header>
                                <h1>
                                    <span className="logo" dangerouslySetInnerHTML={{__html: logoSvg}}></span>
                                </h1>
                            </header>
                            <div className="main-content">
                                <div className="loading">
                                    <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.refresh}}></span>{" "}
                                    Chargement des données météo depuis
                                    Meteoblue...
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="container">
                        <header>
                            <h1>
                                <span className="logo" dangerouslySetInnerHTML={{__html: logoSvg}}></span>
                            </h1>
                            <div className="header-controls">
                                <a
                                    className="btn btn-primary"
                                    href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{textDecoration: "none"}}
                                >
                                    Proposer une amélioration
                                </a>
                            </div>
                        </header>

                        <div className="main-content">
                            {error && <div className="error"><span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.alert}}></span> {error}</div>}

                            <div className="sectors-block">
                                <p className="title-xl" style={{textAlign:"center",margin:0}}>Ajoute tes stations préférées pour voir d'un coup d'œil où sont les meilleures conditions de ski.</p>
                                {resorts.length > 0 && (
                                    <div className="resort-list">
                                        {resorts.map((resort, index) => (
                                            <div key={index} className="tag">
                                                {resort.name}
                                                <button
                                                    className="remove-resort"
                                                    onClick={() => removeResort(index)}
                                                    title="Retirer ce secteur"
                                                >×</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <button
                                    className="btn btn-primary"
                                    onClick={() => setIsModalOpen(true)}
                                >
                                    <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.plus}}></span> Ajouter un Secteur
                                </button>
                            </div>

                            {resorts.length > 0 ? (
                                <>
                                    {snowData.length > 0 && (
                                        <section className="section">
                                            <div className="comparison-card">
                                                <div className="comparison-card-header">
                                                    <div>
                                                        <h2 className="title" style={{margin:0}}>Chutes de Neige (7 jours)</h2>
                                                        <p className="subtitle" style={{margin:0}}>Les données viennent de Meteobleu</p>
                                                    </div>
                                                </div>
                                                <div className="comparison-card-body">
                                            <div className="snow-table">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>Secteur</th>
                                                            {[
                                                                -2, -1, 0, 1, 2, 3,
                                                                4,
                                                            ].map((offset) => {
                                                                const date = new Date();
                                                                date.setDate(date.getDate() + offset);
                                                                const dayAbbr = date.toLocaleDateString("fr-FR", { weekday: "short" });
                                                                const dayNum = date.getDate();
                                                                return (
                                                                    <th key={offset}>
                                                                        <span className="day-abbr">{dayAbbr.charAt(0).toUpperCase() + dayAbbr.slice(1)}</span>
                                                                        <span className="day-num">{dayNum}</span>
                                                                    </th>
                                                                );
                                                            })}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {snowData.map(
                                                            (resort, index) => {
                                                                const resortInfo = resorts[index];
                                                                return (
                                                                    <tr key={index}>
                                                                        <td>
                                                                            <span className="sector-name">{resort.name}</span>
                                                                            <span className="sector-altitude"> ({resortInfo?.altitude}m)</span>
                                                                        </td>
                                                                        {resort.snowByDay.map(
                                                                            (snow, dayIndex) => (
                                                                                <td key={dayIndex}>
                                                                                    <span className="snow-value">{snow}</span>
                                                                                    {" "}<span className="snow-unit">cm</span>
                                                                                </td>
                                                                            ),
                                                                        )}
                                                                    </tr>
                                                                );
                                                            },
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                                </div>
                                            </div>
                                        </section>
                                    )}

                                    {weatherData.length > 0 && (
                                        <section className="section">
                                            <div className="comparison-card">
                                                <div className="comparison-card-header">
                                                    <div>
                                                        <h2 className="title" style={{margin:0}}>Prévisions météo 5 jours</h2>
                                                        <p className="subtitle" style={{margin:0}}>Les données viennent de Meteobleu et France Météo. Contrairement aux chutes de neige, il n'est pas possible d'afficher la météo des jours précédents.</p>
                                                    </div>
                                                </div>
                                                <div className="comparison-card-body">
                                            <div className="snow-table">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>
                                                                Secteur
                                                            </th>
                                                            {viewMode === "day"
                                                                ? // Vue par jour
                                                                  [
                                                                      0, 1, 2,
                                                                      3, 4,
                                                                  ].map(
                                                                      (
                                                                          offset,
                                                                      ) => {
                                                                          const date = new Date();
                                                                          date.setDate(date.getDate() + offset);
                                                                          const dayAbbr = date.toLocaleDateString("fr-FR", { weekday: "short" });
                                                                          const dayNum = date.getDate();
                                                                          return (
                                                                              <th key={offset}>
                                                                                  <span className="day-abbr">{dayAbbr.charAt(0).toUpperCase() + dayAbbr.slice(1)}</span>
                                                                                  <span className="day-num">{dayNum}</span>
                                                                              </th>
                                                                          );
                                                                      },
                                                                  )
                                                                : // Vue horaire (23 heures par jour : 1h-23h)
                                                                  [
                                                                      0, 1, 2,
                                                                      3, 4,
                                                                  ].map(
                                                                      (
                                                                          offset,
                                                                      ) => {
                                                                          const date = new Date();
                                                                          date.setDate(date.getDate() + offset);
                                                                          const dayAbbr = date.toLocaleDateString("fr-FR", { weekday: "short" });
                                                                          const dayNum = date.getDate();
                                                                          return (
                                                                              <th
                                                                                  key={offset}
                                                                                  colSpan={23}
                                                                              >
                                                                                  <span className="day-abbr">{dayAbbr.charAt(0).toUpperCase() + dayAbbr.slice(1)}</span>
                                                                                  <span className="day-num">{dayNum}</span>
                                                                              </th>
                                                                          );
                                                                      },
                                                                  )}
                                                        </tr>
                                                        {viewMode ===
                                                            "hourly" && (
                                                            <tr>
                                                                <th
                                                                    style={{
                                                                        fontSize:
                                                                            "0.7rem",
                                                                    }}
                                                                ></th>
                                                                {[
                                                                    0, 1, 2, 3,
                                                                    4,
                                                                ].map(
                                                                    (
                                                                        offset,
                                                                    ) => (
                                                                        <React.Fragment
                                                                            key={
                                                                                offset
                                                                            }
                                                                        >
                                                                            {[
                                                                                1,
                                                                                2,
                                                                                3,
                                                                                4,
                                                                                5,
                                                                                6,
                                                                                7,
                                                                                8,
                                                                                9,
                                                                                10,
                                                                                11,
                                                                                12,
                                                                                13,
                                                                                14,
                                                                                15,
                                                                                16,
                                                                                17,
                                                                                18,
                                                                                19,
                                                                                20,
                                                                                21,
                                                                                22,
                                                                                23,
                                                                            ].map(
                                                                                (
                                                                                    h,
                                                                                ) => (
                                                                                    <th
                                                                                        key={
                                                                                            h
                                                                                        }
                                                                                        className="hourly-col-header"
                                                                                    >
                                                                                        {
                                                                                            h
                                                                                        }

                                                                                        h
                                                                                    </th>
                                                                                ),
                                                                            )}
                                                                        </React.Fragment>
                                                                    ),
                                                                )}
                                                            </tr>
                                                        )}
                                                    </thead>
                                                    <tbody>
                                                        {weatherData.map(
                                                            (
                                                                resort,
                                                                resortIndex,
                                                            ) => {
                                                                const resortInfo =
                                                                    resorts.find(
                                                                        (r) =>
                                                                            r.name ===
                                                                            resort.name,
                                                                    );
                                                                const meteoblueUrl =
                                                                    resortInfo
                                                                        ? getMeteoblueUrl(
                                                                              resortInfo,
                                                                          )
                                                                        : "#";
                                                                return (
                                                                    <tr
                                                                        key={
                                                                            resortIndex
                                                                        }
                                                                    >
                                                                        <td>
                                                                            <span className="sector-name">{resort.name}</span>
                                                                            <span className="sector-altitude"> ({resortInfo?.altitude || "?"}m)</span>
                                                                        </td>

                                                                        {viewMode ===
                                                                        "day"
                                                                            ? // Vue par jour
                                                                              [
                                                                                  0,
                                                                                  1,
                                                                                  2,
                                                                                  3,
                                                                                  4,
                                                                              ].map(
                                                                                  (
                                                                                      offset,
                                                                                  ) => {
                                                                                      const dayWeather =
                                                                                          resort
                                                                                              .days[
                                                                                              offset
                                                                                          ];
                                                                                      if (
                                                                                          !dayWeather
                                                                                      )
                                                                                          return (
                                                                                              <td
                                                                                                  key={
                                                                                                      offset
                                                                                                  }
                                                                                              >
                                                                                                  -
                                                                                              </td>
                                                                                          );

                                                                                      const avgTemp =
                                                                                          Math.round(
                                                                                              (dayWeather.temp_max +
                                                                                                  dayWeather.temp_min) /
                                                                                                  2,
                                                                                          );
                                                                                      const braDataForResort =
                                                                                          braData[
                                                                                              resort
                                                                                                  .name
                                                                                          ];

                                                                                      // Déterminer quelle échéance BRA afficher selon l'offset
                                                                                      let braEcheance =
                                                                                          null;
                                                                                      if (
                                                                                          offset ===
                                                                                              0 &&
                                                                                          braDataForResort?.[
                                                                                              "aujourd'hui"
                                                                                          ]
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort[
                                                                                                  "aujourd'hui"
                                                                                              ];
                                                                                      } else if (
                                                                                          offset ===
                                                                                              1 &&
                                                                                          braDataForResort?.demain
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort.demain;
                                                                                      } else if (
                                                                                          offset ===
                                                                                              2 &&
                                                                                          braDataForResort?.apresdemain
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort.apresdemain;
                                                                                      }

                                                                                      // Vent moyen + direction
                                                                                      const windMean =
                                                                                          Math.round(
                                                                                              dayWeather.wind_mean,
                                                                                          );
                                                                                      const gustMin =
                                                                                          Math.round(
                                                                                              dayWeather.gust_min,
                                                                                          );
                                                                                      const gustMax =
                                                                                          Math.round(
                                                                                              dayWeather.gust_max,
                                                                                          );
                                                                                      const windDir =
                                                                                          dayWeather.windDirection !==
                                                                                          null
                                                                                              ? getWindDirectionDisplay(
                                                                                                    dayWeather.windDirection,
                                                                                                )
                                                                                              : null;

                                                                                      // Couleur rafales (sur le max)
                                                                                      const gustColor =
                                                                                          getWindColor(
                                                                                              gustMax,
                                                                                          );

                                                                                      return (
                                                                                          <td
                                                                                              key={
                                                                                                  offset
                                                                                              }
                                                                                              className="day-cell"
                                                                                          >
                                                                                              <div className="day-cell-inner">
                                                                                                  {/* Colonne gauche : icône + label */}
                                                                                                  <div className="day-cell-icon" title={dayWeather.condition}>
                                                                                                      <span dangerouslySetInnerHTML={{__html: dayWeather.icon}}></span>
                                                                                                      <div className="day-cell-condition">{dayWeather.condition}</div>
                                                                                                  </div>
                                                                                                  {/* Colonne droite : données */}
                                                                                                  <div className="day-cell-info">
                                                                                                      {/* -4° (−7° / −3°) sur la même ligne, mixed styles */}
                                                                                                      <div className="cell-temp-line">
                                                                                                          <span className="cell-temp-main">{avgTemp}°</span>
                                                                                                          <span className="cell-temp-range">({Math.round(dayWeather.temp_min)}° / {Math.round(dayWeather.temp_max)}°)</span>
                                                                                                      </div>
                                                                                                      {/* ↓ Vent 12 km/h */}
                                                                                                      <div className="info-row">
                                                                                                          {windDir && (
                                                                                                              <span dangerouslySetInnerHTML={{__html: windArrowSvg(dayWeather.windDirection, 16)}}></span>
                                                                                                          )}
                                                                                                          <span>Vent {windMean} km/h</span>
                                                                                                      </div>
                                                                                                      {/* Raf. 15-25 km/h */}
                                                                                                      <div className="info-row">
                                                                                                          <span>Raf. {gustMin}-{gustMax} km/h</span>
                                                                                                      </div>
                                                                                                      {/* Précipitations — masque si ≤ 0 */}
                                                                                                      {dayWeather.snowCm > 0 && (
                                                                                                          <div className="info-row" style={{color:"#3498db",fontWeight:600}}>
                                                                                                              <span dangerouslySetInnerHTML={{__html: uiSvg.snowflake}}></span>
                                                                                                              {dayWeather.snowCm} cm
                                                                                                          </div>
                                                                                                      )}
                                                                                                      {dayWeather.rainMm > 0 && dayWeather.snowCm <= 0 && (
                                                                                                          <div className="info-row" style={{color:"#2980b9"}}>
                                                                                                              <span dangerouslySetInnerHTML={{__html: uiSvg.droplet}}></span>
                                                                                                              {dayWeather.rainMm} mm
                                                                                                          </div>
                                                                                                      )}
                                                                                                      {/* Badge BERA */}
                                                                                                      {braEcheance && braEcheance.haut > 0 && (
                                                                                                          <div className="bera-badge" style={{backgroundColor: getBRAColor(braEcheance.haut)}}>
                                                                                                              BERA {braEcheance.haut}/5
                                                                                                          </div>
                                                                                                      )}
                                                                                                      {/* Lien "Voir le BERA" */}
                                                                                                      {braDataForResort?._detail && (offset === 0 || offset === 1) && (
                                                                                                          <a className="bera-link" href="#" onClick={(e) => {
                                                                                                              e.preventDefault();
                                                                                                              const detail = braDataForResort._detail;
                                                                                                              setBeraModal({ resortName: resort.name, detail, loading: true });
                                                                                                              fetch(
                                                                                                                  `https://public-api.meteofrance.fr/public/DPBRA/v1/massif/BRA?id-massif=${detail.massifId}&format=pdf`,
                                                                                                                  { headers: { apikey: MF_API_KEY } }
                                                                                                              )
                                                                                                                  .then(r => r.blob())
                                                                                                                  .then(blob => {
                                                                                                                      const url = URL.createObjectURL(blob);
                                                                                                                      setBeraModal(prev => prev ? { ...prev, pdfUrl: url, loading: false } : null);
                                                                                                                  })
                                                                                                                  .catch(() => {
                                                                                                                      setBeraModal(prev => prev ? { ...prev, loading: false, pdfError: true } : null);
                                                                                                                  });
                                                                                                          }}>
                                                                                                              Voir le BERA
                                                                                                          </a>
                                                                                                      )}
                                                                                                  </div>
                                                                                              </div>
                                                                                          </td>
                                                                                      );
                                                                                  },
                                                                              )
                                                                            : // Vue horaire (1h-23h)
                                                                              [
                                                                                  0,
                                                                                  1,
                                                                                  2,
                                                                                  3,
                                                                                  4,
                                                                              ].map(
                                                                                  (
                                                                                      offset,
                                                                                  ) => {
                                                                                      const dayWeather =
                                                                                          resort
                                                                                              .days[
                                                                                              offset
                                                                                          ];
                                                                                      if (
                                                                                          !dayWeather ||
                                                                                          !dayWeather.hourly
                                                                                      ) {
                                                                                          return (
                                                                                              <React.Fragment
                                                                                                  key={
                                                                                                      offset
                                                                                                  }
                                                                                              >
                                                                                                  {[
                                                                                                      1,
                                                                                                      2,
                                                                                                      3,
                                                                                                      4,
                                                                                                      5,
                                                                                                      6,
                                                                                                      7,
                                                                                                      8,
                                                                                                      9,
                                                                                                      10,
                                                                                                      11,
                                                                                                      12,
                                                                                                      13,
                                                                                                      14,
                                                                                                      15,
                                                                                                      16,
                                                                                                      17,
                                                                                                      18,
                                                                                                      19,
                                                                                                      20,
                                                                                                      21,
                                                                                                      22,
                                                                                                      23,
                                                                                                  ].map(
                                                                                                      (
                                                                                                          h,
                                                                                                      ) => (
                                                                                                          <td
                                                                                                              key={
                                                                                                                  h
                                                                                                              }
                                                                                                              className="hourly-cell"
                                                                                                              style={{
                                                                                                                  fontSize:
                                                                                                                      "0.65rem",
                                                                                                                  color: "#95a5a6",
                                                                                                              }}
                                                                                                          >
                                                                                                              -
                                                                                                          </td>
                                                                                                      ),
                                                                                                  )}
                                                                                              </React.Fragment>
                                                                                          );
                                                                                      }

                                                                                      return (
                                                                                          <React.Fragment
                                                                                              key={
                                                                                                  offset
                                                                                              }
                                                                                          >
                                                                                              {[
                                                                                                  1,
                                                                                                  2,
                                                                                                  3,
                                                                                                  4,
                                                                                                  5,
                                                                                                  6,
                                                                                                  7,
                                                                                                  8,
                                                                                                  9,
                                                                                                  10,
                                                                                                  11,
                                                                                                  12,
                                                                                                  13,
                                                                                                  14,
                                                                                                  15,
                                                                                                  16,
                                                                                                  17,
                                                                                                  18,
                                                                                                  19,
                                                                                                  20,
                                                                                                  21,
                                                                                                  22,
                                                                                                  23,
                                                                                              ].map(
                                                                                                  (
                                                                                                      hour,
                                                                                                  ) => {
                                                                                                      const hourData =
                                                                                                          dayWeather
                                                                                                              .hourly[
                                                                                                              hour
                                                                                                          ];
                                                                                                      if (
                                                                                                          !hourData
                                                                                                      ) {
                                                                                                          return (
                                                                                                              <td
                                                                                                                  key={
                                                                                                                      hour
                                                                                                                  }
                                                                                                                  className="hourly-cell"
                                                                                                                  style={{
                                                                                                                      fontSize:
                                                                                                                          "0.65rem",
                                                                                                                      color: "#95a5a6",
                                                                                                                  }}
                                                                                                              >
                                                                                                                  -
                                                                                                              </td>
                                                                                                          );
                                                                                                      }

                                                                                                      return (
                                                                                                          <td
                                                                                                              key={
                                                                                                                  hour
                                                                                                              }
                                                                                                              className="hourly-cell"
                                                                                                          >
                                                                                                              <div
                                                                                                                  className="cell-icon"
                                                                                                                  title={
                                                                                                                      hourData.condition
                                                                                                                  }
                                                                                                                  dangerouslySetInnerHTML={{__html: hourData.icon}}
                                                                                                              ></div>
                                                                                                              <div className="cell-temp">
                                                                                                                  {
                                                                                                                      hourData.temp
                                                                                                                  }

                                                                                                                  °
                                                                                                              </div>
                                                                                                              <div className="cell-wind">
                                                                                                                  <span>
                                                                                                                      {
                                                                                                                          hourData.wind
                                                                                                                      }
                                                                                                                  </span>
                                                                                                                  {hourData.windDirection !==
                                                                                                                      null &&
                                                                                                                      (() => {
                                                                                                                          const windDir =
                                                                                                                              getWindDirectionDisplay(
                                                                                                                                  hourData.windDirection,
                                                                                                                              );
                                                                                                                          return (
                                                                                                                              <>
                                                                                                                                  <span className="wind-arrow" dangerouslySetInnerHTML={{__html: windArrowSvg(hourData.windDirection, 12)}}></span>
                                                                                                                                  <span className="wind-cardinal">
                                                                                                                                      {
                                                                                                                                          windDir.cardinal
                                                                                                                                      }
                                                                                                                                  </span>
                                                                                                                              </>
                                                                                                                          );
                                                                                                                      })()}
                                                                                                              </div>
                                                                                                          </td>
                                                                                                      );
                                                                                                  },
                                                                                              )}
                                                                                          </React.Fragment>
                                                                                      );
                                                                                  },
                                                                              )}
                                                                    </tr>
                                                                );
                                                            },
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                                </div>
                                            </div>
                                        </section>
                                    )}
                                </>
                            ) : null}
                        </div>

                        <AddResortModal
                            isOpen={isModalOpen}
                            onClose={() => setIsModalOpen(false)}
                            onAdd={addResort}
                        />

                        {/* Modale BERA — PDF embed */}
                        {beraModal && (
                            <div
                                style={{
                                    position: "fixed",
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    backgroundColor: "rgba(0,0,0,0.6)",
                                    zIndex: 9999,
                                    display: "flex",
                                    alignItems: "center",
                                    justifyContent: "center",
                                    padding: "16px",
                                }}
                                onClick={() => {
                                    if (beraModal.pdfUrl)
                                        URL.revokeObjectURL(beraModal.pdfUrl);
                                    setBeraModal(null);
                                }}
                            >
                                <div
                                    style={{
                                        background: "white",
                                        borderRadius: "12px",
                                        width: "100%",
                                        maxWidth: "900px",
                                        height: "90vh",
                                        display: "flex",
                                        flexDirection: "column",
                                        position: "relative",
                                        boxShadow:
                                            "0 20px 60px rgba(0,0,0,0.3)",
                                        overflow: "hidden",
                                    }}
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    {/* Header */}
                                    <div
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            padding: "16px 20px",
                                            borderBottom: "1px solid #e0e0e0",
                                            flexShrink: 0,
                                        }}
                                    >
                                        <div>
                                            <h2
                                                style={{
                                                    margin: 0,
                                                    fontSize: "1.1rem",
                                                    color: "var(--deep-blue)",
                                                }}
                                            >
                                                BERA —{" "}
                                                {beraModal.detail.massifName}
                                            </h2>
                                            <div
                                                style={{
                                                    fontSize: "0.75rem",
                                                    color: "#666",
                                                    marginTop: "2px",
                                                }}
                                            >
                                                {beraModal.resortName} —
                                                Bulletin du{" "}
                                                {new Date(
                                                    beraModal.detail
                                                        .dateBulletin,
                                                ).toLocaleDateString("fr-FR", {
                                                    weekday: "long",
                                                    day: "numeric",
                                                    month: "long",
                                                    year: "numeric",
                                                })}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (beraModal.pdfUrl)
                                                    URL.revokeObjectURL(
                                                        beraModal.pdfUrl,
                                                    );
                                                setBeraModal(null);
                                            }}
                                            style={{
                                                background: "#e0e0e0",
                                                border: "none",
                                                borderRadius: "50%",
                                                width: "36px",
                                                height: "36px",
                                                fontSize: "1.2rem",
                                                cursor: "pointer",
                                                display: "flex",
                                                alignItems: "center",
                                                justifyContent: "center",
                                                flexShrink: 0,
                                            }}
                                        >
                                            X
                                        </button>
                                    </div>

                                    {/* Contenu PDF */}
                                    <div
                                        style={{ flex: 1, overflow: "hidden" }}
                                    >
                                        {beraModal.loading ? (
                                            <div
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    height: "100%",
                                                    fontSize: "1rem",
                                                    color: "#666",
                                                }}
                                            >
                                                Chargement du BERA...
                                            </div>
                                        ) : beraModal.pdfError ? (
                                            <div
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    height: "100%",
                                                    fontSize: "0.9rem",
                                                    color: "#c00",
                                                }}
                                            >
                                                Impossible de charger le PDF du
                                                BERA.
                                            </div>
                                        ) : beraModal.pdfUrl ? (
                                            <iframe
                                                src={beraModal.pdfUrl}
                                                style={{
                                                    width: "100%",
                                                    height: "100%",
                                                    border: "none",
                                                }}
                                                title="BERA PDF"
                                            />
                                        ) : null}
                                    </div>

                                    {/* Footer */}
                                    <div
                                        style={{
                                            padding: "12px 20px",
                                            borderTop: "1px solid #e0e0e0",
                                            textAlign: "center",
                                            flexShrink: 0,
                                        }}
                                    >
                                        <button
                                            onClick={() => {
                                                if (beraModal.pdfUrl)
                                                    URL.revokeObjectURL(
                                                        beraModal.pdfUrl,
                                                    );
                                                setBeraModal(null);
                                            }}
                                            style={{
                                                background: "var(--deep-blue)",
                                                color: "white",
                                                border: "none",
                                                borderRadius: "8px",
                                                padding: "10px 32px",
                                                fontSize: "0.9rem",
                                                fontWeight: "600",
                                                cursor: "pointer",
                                            }}
                                        >
                                            Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Footer CTA */}
                        <div className="footer-cta">
                            <div className="footer-cta-title">
                                Trouves le bon spot pour ta rando
                            </div>
                            <div className="footer-cta-buttons">
                                <a
                                    className="btn btn-primary"
                                    href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{textDecoration: "none"}}
                                >
                                    Proposer une amélioration
                                </a>
                                <a
                                    className="btn btn-secondary"
                                    href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{textDecoration: "none"}}
                                >
                                    Faire un don
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.render(
                <MountainWeatherApp />,
                document.getElementById("root"),
            );
        </script>
    </body>
</html>
