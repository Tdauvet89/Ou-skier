<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ski rando Météo - Dashboard Ski de Randonnée</title>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="icons.js?v=7.6.0"></script>
        <script src="weatherCodes.js?v=7.6.0"></script>
        <script src="massifMapping.js?v=7.6.0"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Inter:wght@400;500&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="design-system.css?v=7.6.0" />
        <style>
            /* --- MODIFICATIONS STRUCTURELLES --- */
            body {
                font-family: "JetBrains Mono", monospace;
                background: white !important; /* Force le blanc */
                min-height: 100vh;
                padding: 0;
                color: var(--storm-gray);
            }

            .container {
                max-width: 1440px;
                margin: 0 auto;
                background: white !important;
            }

            header {
                background: white !important;
                padding: 20px 75px;
                border-bottom: 1px solid #E1E8F2;
                display: flex;
                align-items: center;
                justify-content: space-between;
                /* Sticky Header */
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .main-content {
                background: white !important;
                padding: 40px 75px;
                border-radius: 0;
                box-shadow: none;
            }

            /* Sous-texte des titres */
            .subtitle-detail {
                font-family: "JetBrains Mono", monospace;
                font-weight: 400;
                font-size: 0.7rem;
                color: var(--storm-gray);
                margin-top: -12px;
                margin-bottom: 20px;
            }

            /* --- STYLES NOUVEAU TABLEAU (TEST) --- */
            .new-weather-card {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 16px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                margin-top: 20px;
            }
            .new-table-container { overflow-x: auto; width: 100%; }
            .new-weather-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1100px; border:none; }
            .new-weather-table th { background: #f8fafc; padding: 16px; border-bottom: 1px solid #e2e8f0; color: var(--deep-blue); }
            .new-weather-table .th-sector { position: sticky; left: 0; z-index: 20; border-right: 1px solid #e2e8f0; background: #f8fafc; text-align: left; }
            .new-weather-table .th-date { text-align: center; min-width: 150px; }
            .new-date-day { font-size: 0.75rem; color: #64748b; text-transform: uppercase; display: block; }
            .new-date-num { font-size: 1.5rem; font-weight: 700; display: block; margin-top: 4px; }
            .new-weather-table td { padding: 20px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: top; background: white; }
            .new-weather-table .td-sector { position: sticky; left: 0; z-index: 10; border-right: 1px solid #f1f5f9; font-weight: 600; font-size: 1.1rem; background: white; text-align: left; }
            
            .weather-cell-inner { display: flex; gap: 12px; align-items: flex-start; text-align: left; }
            .weather-left-col { display: flex; flex-direction: column; align-items: center; min-width: 80px; gap: 4px; }
            .weather-main-icon svg { width: 40px; height: 40px; }
            .weather-condition-label { font-size: 0.7rem; color: #475569; text-align: center; line-height: 1.2; }
            .weather-right-col { flex: 1; display: flex; flex-direction: column; gap: 4px; }
            .weather-temp-main { font-size: 1.4rem; font-weight: 700; color: var(--deep-blue); }
            .weather-temp-range { font-size: 0.75rem; color: #64748b; }
            .weather-detail-row { font-size: 0.8rem; color: var(--storm-gray); display: flex; align-items: center; gap: 4px; }
            
            .bera-tag { display: inline-block; padding: 2px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 700; margin-top: 4px; }
            .bera-1 { background: #27ae60; } .bera-2 { background: #f1c40f; color: #000; } 
            .bera-3 { background: #e67e22; } .bera-4, .bera-5 { background: #e74c3c; }
            .precip-badge { display: inline-flex; align-items: center; gap: 4px; color: #2563eb; font-weight: 700; font-size: 0.8rem; margin-top: 4px; }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            // --- UTILITAIRE VENT ---
            const getWindDirectionDisplay = (deg) => {
                if (deg === null || deg === undefined) return { cardinal: "N/A" };
                const sectors = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
                const index = Math.round(deg / 45) % 8;
                return { cardinal: sectors[index] };
            };

            // Ta configuration d'origine
            const DEFAULT_RESORTS = [
                { name: "Guzet", lat: 42.7857, lon: 1.2261, altitude: 1400 },
                { name: "Piau-Engaly", lat: 42.7833, lon: 0.1667, altitude: 1850 },
                { name: "Saint-Lary", lat: 42.8167, lon: 0.3167, altitude: 1700 },
                { name: "Couterets", lat: 42.8833, lon: -0.1167, altitude: 1730 },
                { name: "Tourmalet", lat: 42.908, lon: 0.145, altitude: 1800 },
                { name: "Peyragudes", lat: 42.793, lon: 0.443, altitude: 1600 },
                { name: "Ax 3 Domaines", lat: 42.7, lon: 1.833, altitude: 1400 }
            ];

            const MF_API_KEY = "LuUd7q9wHpiG1aWh";

            function MountainWeatherApp() {
                const [resorts, setResorts] = useState(DEFAULT_RESORTS);
                const [weatherData, setWeatherData] = useState([]);
                const [snowData, setSnowData] = useState([]);
                const [braData, setBraData] = useState({});
                const [viewMode, setViewMode] = useState("day");
                const [beraModal, setBeraModal] = useState(null);

                // Récupération des données (Logique d'origine conservée)
                useEffect(() => {
                    const fetchData = async () => {
                        const allWeatherData = [];
                        const allSnowData = [];
                        const allBraData = {};

                        for (const resort of resorts) {
                            try {
                                const response = await fetch(`https://my.meteoblue.com/packages/basic-day_wind-day?lat=${resort.lat}&lon=${resort.lon}&apikey=${MF_API_KEY}&format=json`);
                                const data = await response.json();
                                
                                if (data.data_day) {
                                    const days = data.data_day.time.map((time, i) => ({
                                        time,
                                        temp_min: data.data_day.tempmin[i],
                                        temp_max: data.data_day.tempmax[i],
                                        condition: weatherCodes[data.data_day.pictocode[i]]?.description || "Inconnu",
                                        icon: weatherSvg[weatherCodes[data.data_day.pictocode[i]]?.icon] || weatherSvg.sun,
                                        wind_mean: data.data_day.windspeed_mean[i],
                                        windDirection: data.data_day.winddirection[i],
                                        gust_min: data.data_day.windspeed_min[i],
                                        gust_max: data.data_day.windspeed_max[i],
                                        snowCm: data.data_day.snowfraction[i] > 0 ? Math.round(data.data_day.precipitation[i]) : 0,
                                        rainMm: data.data_day.snowfraction[i] === 0 ? data.data_day.precipitation[i] : 0
                                    }));
                                    allWeatherData.push({ name: resort.name, days });
                                    allSnowData.push({ name: resort.name, snowByDay: data.data_day.precipitation.map((p, i) => data.data_day.snowfraction[i] > 0 ? Math.round(p) : 0) });
                                }

                                // Mock BERA pour démo si massifMapping existe
                                if (typeof massifMapping !== 'undefined') {
                                    const massifId = massifMapping[resort.name];
                                    if (massifId) {
                                        allBraData[resort.name] = { "aujourd'hui": { haut: 2 }, demain: { haut: 3 } };
                                    }
                                }
                            } catch (e) { console.error(e); }
                        }
                        setWeatherData(allWeatherData);
                        setSnowData(allSnowData);
                        setBraData(allBraData);
                    };
                    fetchData();
                }, [resorts]);

                return (
                    <div className="container">
                        {/* --- HEADER D'ORIGINE --- */}
                        <header>
                            <div className="logo" style={{display: 'flex', alignItems: 'center'}}>
                                <div className="logo-text-primary">Ski rando</div>
                                <div className="logo-text-secondary" style={{marginLeft: '5px'}}>météo</div>
                            </div>
                            <div className="header-controls">
                                <div className="view-toggle">
                                    <button className={`toggle-btn ${viewMode === 'day' ? 'active' : ''}`} onClick={() => setViewMode('day')}>7 jours</button>
                                    <button className={`toggle-btn ${viewMode === 'hourly' ? 'active' : ''}`} onClick={() => setViewMode('hourly')}>Horaire</button>
                                </div>
                            </div>
                        </header>

                        <main className="main-content">
                            {/* --- TABLEAU 1 (DESIGN ACTUEL) --- */}
                            {weatherData.length > 0 && (
                                <section className="section">
                                    <h2>Météo Comparative (5 jours)</h2>
                                    <div className="subtitle-detail">Les données ci-dessous viennent de Metéobleu et de Metéo France</div>
                                    <div className="snow-table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Secteur</th>
                                                    {weatherData[0].days.slice(0,5).map((d, i) => (
                                                        <th key={i}>{new Date(d.time).toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric'})}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {weatherData.map((resort, idx) => (
                                                    <tr key={idx}>
                                                        <td className="station-name">{resort.name}</td>
                                                        {resort.days.slice(0,5).map((day, i) => (
                                                            <td key={i}>{Math.round((day.temp_min + day.temp_max)/2)}°</td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            )}

                            {/* --- TABLEAU 2 (NOUVEAU DESIGN TEST) --- */}
                            {weatherData.length > 0 && viewMode === 'day' && (
                                <section className="section">
                                    <h2 style={{ marginTop: '60px' }}>Nouveau Design (Preview)</h2>
                                    <div className="subtitle-detail">Test d'intégration du nouveau design system</div>
                                    <div className="new-weather-card">
                                        <div className="new-table-container">
                                            <table className="new-weather-table">
                                                <thead>
                                                    <tr>
                                                        <th className="th-sector">Secteur</th>
                                                        {weatherData[0].days.slice(0,5).map((day, i) => {
                                                            const d = new Date(day.time);
                                                            return (
                                                                <th key={i} className="th-date">
                                                                    <span className="new-date-day">{d.toLocaleDateString("fr-FR", { weekday: "short" })}</span>
                                                                    <span className="new-date-num">{d.getDate()}</span>
                                                                </th>
                                                            );
                                                        })}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {weatherData.map((resort, idx) => (
                                                        <tr key={idx}>
                                                            <td className="td-sector">
                                                                <div>{resort.name}</div>
                                                                <div style={{ fontSize: '0.75rem', fontWeight: 400, color: '#64748b' }}>
                                                                    {resorts.find(r => r.name === resort.name)?.altitude}m
                                                                </div>
                                                            </td>
                                                            {resort.days.slice(0, 5).map((day, i) => {
                                                                const bra = braData[resort.name]?.["aujourd'hui"];
                                                                const windDir = getWindDirectionDisplay(day.windDirection);
                                                                return (
                                                                    <td key={i}>
                                                                        <div className="weather-cell-inner">
                                                                            <div className="weather-left-col">
                                                                                <div className="weather-main-icon" dangerouslySetInnerHTML={{ __html: day.icon }}></div>
                                                                                <div className="weather-condition-label">{day.condition}</div>
                                                                            </div>
                                                                            <div className="weather-right-col">
                                                                                <div className="weather-temp-row">
                                                                                    <span className="weather-temp-main">{Math.round((day.temp_max+day.temp_min)/2)}°</span>
                                                                                    <span className="weather-temp-range">({Math.round(day.temp_min)}°/{Math.round(day.temp_max)}°)</span>
                                                                                </div>
                                                                                <div className="weather-detail-row">
                                                                                    <span dangerouslySetInnerHTML={{ __html: typeof windArrowSvg !== 'undefined' ? windArrowSvg(day.windDirection, 14) : '' }}></span>
                                                                                    {windDir.cardinal} {Math.round(day.wind_mean)} km/h
                                                                                </div>
                                                                                {bra && <div className={`bera-tag bera-${bra.haut}`}>BERA {bra.haut}/5</div>}
                                                                                {day.snowCm > 0 && <div className="precip-badge">❄️ {day.snowCm} cm</div>}
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                );
                                                            })}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </section>
                            )}

                            {/* --- TABLEAU CHUTES DE NEIGE (ORIGINAL) --- */}
                            {snowData.length > 0 && (
                                <section className="section" style={{marginTop: '60px'}}>
                                    <h2>Chutes de Neige (7 jours)</h2>
                                    <div className="subtitle-detail">Les données ci-dessous viennent de Metéobleu</div>
                                    <div className="snow-table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Station</th>
                                                    {[0,1,2,3,4,5,6].map(i => <th key={i}>J+{i}</th>)}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {snowData.map((s, idx) => (
                                                    <tr key={idx}>
                                                        <td>{s.name}</td>
                                                        {s.snowByDay.map((val, i) => <td key={i}>{val > 0 ? `${val}cm` : '-'}</td>)}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            )}
                        </main>

                        {/* --- FOOTER D'ORIGINE --- */}
                        <footer className="footer">
                            <div className="container">
                                <div className="footer-content" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                    <div className="footer-brand">
                                        <div className="logo-text-primary">Ski rando</div>
                                        <div className="logo-text-secondary">météo</div>
                                        <div className="subtitle-detail" style={{ marginTop: '15px', marginBottom: '5px' }}>
                                            Les données viennent de Metéobleu et de Metéo France.
                                        </div>
                                        <div className="footer-tagline">Trouves le bon spot pour ta rando</div>
                                    </div>
                                    <div className="footer-cta-buttons">
                                        <a className="btn btn-dark" href="#" style={{marginRight: '10px'}}>Proposer une amélioration</a>
                                        <a className="btn btn-ghost" href="#">Faire un don</a>
                                    </div>
                                </div>
                            </div>
                        </footer>
                    </div>
                );
            }

            ReactDOM.render(<MountainWeatherApp />, document.getElementById("root"));
        </script>
    </body>
</html>
