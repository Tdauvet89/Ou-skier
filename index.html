<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>M√©t√©o Montagne - Dashboard Ski</title>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="weatherCodes.js?v=6.6.0"></script>
        <script src="massifMapping.js?v=6.6.0"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                /* === DESIGN SYSTEM - VARIABLES === */
                /* Couleurs Principales */
                --deep-blue: #1a5276;
                --glacier: #5dade2;
                --powder: #d4e9f7;
                --storm-gray: #5d6d7e;
                --fresh-green: #27ae60;
                --shadow-blue: rgba(0, 0, 0, 0.1);
                --ice-blue: #d4e9f7;
                --snow-white: #fafbfc;
                --fresh-snow: #ecf0f1;

                /* Couleurs M√©t√©o */
                --temp-cold: #3498db;
                --temp-warm: #e67e22;
                --warning-orange: #e67e22;
                --heavy-snow: #e74c3c;

                /* Espacements */
                --padding-xs: 4px;
                --padding-sm: 8px;
                --padding-md: 15px;
                --padding-lg: 20px;
                --padding-xl: 40px;

                --margin-xs: 4px;
                --margin-sm: 8px;
                --margin-md: 15px;
                --margin-lg: 25px;
                --margin-xl: 40px;

                --space-between-sections: 40px;
                --space-between-elements: 15px;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "JetBrains Mono", monospace;
                background: linear-gradient(
                    135deg,
                    #1a5276 0%,
                    #2874a6 50%,
                    #5dade2 100%
                );
                min-height: 100vh;
                padding: 20px;
                color: var(--storm-gray);
            }

            .container {
                max-width: 1800px;
                margin: 0 auto;
                animation: slideDown 0.6s ease-out;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            header {
                background: rgba(255, 255, 255, 0.95);
                padding: 30px 40px;
                border-radius: 16px 16px 0 0;
                border-bottom: 4px solid var(--glacier);
                box-shadow: 0 4px 20px var(--shadow-blue);
            }

            h1 {
                font-family: "Barlow Condensed", sans-serif;
                font-size: 3.5rem;
                font-weight: 800;
                color: var(--deep-blue);
                text-transform: uppercase;
                letter-spacing: 2px;
                margin-bottom: 8px;
                text-shadow: 2px 2px 0 var(--glacier);
            }

            .subtitle {
                font-size: 0.95rem;
                color: var(--storm-gray);
                font-weight: 500;
                letter-spacing: 1px;
            }

            .header-controls {
                display: flex;
                gap: 15px;
                margin-top: 20px;
                flex-wrap: wrap;
            }

            .date-display {
                flex: 1;
                padding: 12px 20px;
                background: var(--powder);
                border-left: 4px solid var(--deep-blue);
                border-radius: 6px;
                font-size: 0.9rem;
                color: var(--deep-blue);
                font-weight: 500;
            }

            .refresh-btn {
                padding: 12px 24px;
                background: linear-gradient(135deg, var(--deep-blue), #2874a6);
                color: white;
                border: none;
                border-radius: 6px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1rem;
                font-weight: 700;
                text-transform: uppercase;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }

            .refresh-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .refresh-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .main-content {
                background: rgba(255, 255, 255, 0.98);
                padding: 40px;
                border-radius: 0 0 16px 16px;
                box-shadow: 0 10px 40px var(--shadow-blue);
            }

            .loading {
                text-align: center;
                padding: 60px 20px;
                font-size: 1.2rem;
                color: var(--deep-blue);
            }

            .error {
                background: #ffe5e5;
                border: 2px solid #ff4444;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
                color: #cc0000;
            }

            .section {
                margin-bottom: 50px;
                animation: fadeIn 0.8s ease-out backwards;
            }

            .section:nth-child(1) {
                animation-delay: 0.1s;
            }
            .section:nth-child(2) {
                animation-delay: 0.2s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            h2 {
                font-family: "Barlow Condensed", sans-serif;
                font-size: 2rem;
                font-weight: 700;
                color: var(--deep-blue);
                text-transform: uppercase;
                letter-spacing: 1.5px;
                margin-bottom: 25px;
                padding-bottom: 12px;
                border-bottom: 3px solid var(--glacier);
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .icon {
                font-size: 1.8rem;
            }

            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                /* overflow: hidden;  <-- REMOVED to fix sticky */
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            }

            thead {
                background: linear-gradient(
                    135deg,
                    var(--deep-blue) 0%,
                    #2874a6 100%
                );
                color: white;
            }

            th {
                padding: 18px 16px;
                text-align: left;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 1px;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }

            th:first-child {
                border-radius: 12px 0 0 0;
                font-size: 1.1rem;
                min-width: 180px;
            }

            th:last-child {
                border-radius: 0 12px 0 0;
                border-right: none;
            }

            tbody tr {
                transition: all 0.3s ease;
                background: white;
            }

            tbody tr:nth-child(even) {
                background: var(--fresh-snow);
            }

            tbody tr:hover {
                background: var(--powder);
                /* Animation supprim√©e pour meilleure lisibilit√© */
            }

            td {
                padding: 16px;
                border-right: 1px solid #e0e0e0;
                font-size: 0.9rem;
                transition: all 0.2s ease;
            }

            td:first-child {
                font-weight: 600;
                color: var(--deep-blue);
                font-size: 1rem;
                background: rgba(212, 233, 247, 0.3);
            }

            td:last-child {
                border-right: none;
            }

            .snow-value {
                font-weight: 600;
                color: var(--deep-blue);
                font-size: 1.05rem;
            }

            .heavy-snow {
                color: var(--warning-orange);
                font-weight: 700;
            }

            .date-header {
                font-size: 0.85rem;
                opacity: 0.9;
                display: block;
                margin-top: 4px;
                font-weight: 400;
            }

            .weather-icon {
                font-size: 1.5rem;
                margin-right: 8px;
                vertical-align: middle;
            }

            .temp {
                font-weight: 600;
                color: var(--deep-blue);
            }

            .temp-cold {
                color: #3498db;
            }

            .temp-warm {
                color: var(--warning-orange);
            }

            .conditions {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .wind-info {
                font-size: 0.85rem;
                color: #7f8c8d;
                margin-top: 4px;
            }

            .legend {
                margin-top: 20px;
                padding: 15px 20px;
                background: var(--powder);
                border-radius: 8px;
                font-size: 0.85rem;
                color: var(--storm-gray);
                border-left: 4px solid var(--glacier);
            }

            .legend-item {
                display: inline-block;
                margin-right: 25px;
                margin-bottom: 5px;
            }

            /* Toggle View Switch */
            .view-toggle-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding: 15px 20px;
                background: var(--powder);
                border-radius: 8px;
            }

            .view-toggle {
                display: flex;
                background: white;
                border-radius: 8px;
                padding: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .view-toggle-btn {
                padding: 10px 20px;
                border: none;
                background: transparent;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1rem;
                font-weight: 700;
                text-transform: uppercase;
                cursor: pointer;
                border-radius: 6px;
                transition: all 0.3s ease;
                color: var(--storm-gray);
            }

            .view-toggle-btn.active {
                background: linear-gradient(135deg, var(--deep-blue), #2874a6);
                color: white;
                box-shadow: 0 2px 6px rgba(26, 82, 118, 0.3);
            }

            .view-toggle-btn:hover:not(.active) {
                background: var(--powder);
            }

            /* Unified Table */
            .unified-weather-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                border-radius: 12px;
                /* overflow: hidden; REMOVED! - This was breaking sticky */
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                position: relative;
            }

            .unified-weather-table thead th {
                position: -webkit-sticky;
                position: sticky;
                top: 0;
                z-index: 30; /* High z-index for headers */
            }

            /* Unified Table avec scroll horizontal - sticky column fix */
            .unified-table-wrapper {
                width: 100%;
                overflow-x: auto;
                margin-bottom: 40px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                position: relative; /* Ensure wrapper context */
            }

            /* Sticky first column - TOUJOURS visible au scroll */
            .unified-weather-table .sticky-first-col {
                position: sticky;
                left: 0;
                z-index: 20; /* Increased to stay above scrolling content */
                background: white;
                font-weight: 600;
                padding: 12px 16px;
                min-width: 180px;
                box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
                border-right: 2px solid var(--glacier); /* Added clear border */
            }

            /* Header sticky column - Intersection top/left */
            .unified-weather-table thead .sticky-first-col {
                background: linear-gradient(
                    135deg,
                    var(--deep-blue) 0%,
                    #2874a6 100%
                );
                color: white;
                z-index: 40; /* Highest z-index (header + sticky col) */
            }

            /* Body sticky column */
            .unified-weather-table tbody .sticky-first-col {
                background: #eaf6fc; /* Solid color, not transparent */
                color: var(--deep-blue);
            }

            .day-col-header {
                text-align: center;
                padding: 12px 8px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 0.8rem;
                font-weight: 700;
                text-transform: uppercase;
                line-height: 1.3;
                min-width: 140px;
            }

            .day-col-header.today-col {
                background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            }

            .hourly-col-header {
                text-align: center;
                padding: 4px 2px;
                font-size: 0.65rem;
                font-weight: 400;
                color: white;
                min-width: 35px;
                max-width: 35px;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }

            /* Une heure sur deux en bold pour faciliter la lecture */
            .hourly-col-header:nth-child(2n + 2) {
                font-weight: 700;
            }

            .hourly-col-header:first-of-type {
                border-left: none;
            }

            .day-cell {
                padding: 8px 6px;
                border-right: 2px solid var(--glacier);
                min-width: 150px;
                vertical-align: middle;
            }

            .day-cell-inner {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .day-cell-icon {
                flex: 0 0 30%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2.2rem;
            }

            .day-cell-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 2px;
                align-items: flex-start;
                font-size: 0.75rem;
            }

            .day-cell-info .info-row {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            /* Liens cliquables - bleu visible */
            table a,
            .info-row a {
                color: #2980b9;
                text-decoration: underline;
            }
            table a:hover,
            .info-row a:hover {
                color: #1a5276;
            }

            .day-cell.today-cell {
                background: rgba(39, 174, 96, 0.08);
            }

            .hourly-cell {
                text-align: center;
                padding: 6px 2px;
                min-width: 35px;
                max-width: 35px;
                border-right: 1px solid #f0f0f0;
                vertical-align: middle;
                font-size: 0.7rem;
            }

            .hourly-cell.today-cell {
                background: rgba(39, 174, 96, 0.08);
            }

            .cell-icon {
                font-size: 1.1rem;
                margin: 1px 0;
            }

            .cell-temp {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
                margin: 2px 0;
            }

            .cell-wind {
                font-size: 0.6rem;
                color: #7f8c8d;
                margin-top: 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 2px;
                flex-wrap: nowrap;
            }

            .wind-arrow {
                font-size: 0.8rem;
                color: #3498db;
                line-height: 1;
            }

            .wind-cardinal {
                font-size: 0.55rem;
                font-weight: 700;
                color: #555;
            }

            .cell-temp-range {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
            }

            /* Tableau horaire d√©taill√© */
            .hourly-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                overflow-x: auto;
                display: block;
            }

            .hourly-table thead,
            .hourly-table tbody {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            .resort-header-sticky {
                position: sticky;
                left: 0;
                z-index: 10;
                background: white;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                padding: 15px 20px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.3rem;
                color: var(--deep-blue);
                border-bottom: 2px solid var(--glacier);
                min-width: 200px;
                max-width: 200px;
            }

            .day-column {
                text-align: center;
                vertical-align: top;
                border-right: 2px solid var(--glacier);
                padding: 0;
                min-width: 180px;
                max-width: 180px;
            }

            .day-column:last-child {
                border-right: none;
            }

            .day-header {
                background: linear-gradient(
                    135deg,
                    var(--deep-blue) 0%,
                    #2874a6 100%
                );
                color: white;
                padding: 10px 6px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 0.8rem;
                font-weight: 700;
                text-transform: uppercase;
                line-height: 1.3;
            }

            .day-header.today-header {
                background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            }

            .hourly-slots {
                display: flex;
                flex-direction: row;
                border-top: 1px solid #e0e0e0;
            }

            .hour-slot {
                flex: 1;
                padding: 6px 3px;
                border-right: 1px solid #f0f0f0;
                min-width: 60px;
            }

            .hour-slot:last-child {
                border-right: none;
            }

            .hour-time {
                font-size: 0.7rem;
                font-weight: 700;
                color: var(--deep-blue);
                margin-bottom: 4px;
            }

            .hour-icon {
                font-size: 1.3rem;
                margin: 3px 0;
            }

            .hour-temp {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
                margin: 3px 0;
            }

            .temp-trend {
                font-size: 0.6rem;
                color: #95a5a6;
            }

            .hour-wind {
                font-size: 0.65rem;
                color: #7f8c8d;
                margin-top: 3px;
            }

            .wind-trend {
                font-size: 0.6rem;
                color: #95a5a6;
            }

            .trend-up {
                color: #e74c3c;
            }

            .trend-down {
                color: #3498db;
            }

            .trend-stable {
                color: #95a5a6;
            }

            .weather-table-wrapper {
                overflow-x: auto;
                margin-bottom: 40px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .weather-table-container {
                display: flex;
                min-width: fit-content;
            }

            .resort-name-column {
                position: sticky;
                left: 0;
                z-index: 10;
                background: linear-gradient(
                    135deg,
                    var(--deep-blue) 0%,
                    #2874a6 100%
                );
                color: white;
                padding: 15px 20px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.2rem;
                font-weight: 700;
                text-transform: uppercase;
                display: flex;
                align-items: center;
                min-width: 200px;
                max-width: 200px;
                box-shadow: 3px 0 8px rgba(0, 0, 0, 0.15);
            }

            .days-container {
                display: flex;
                flex: 1;
            }

            .past-day {
                opacity: 0.7;
                background: #f8f9fa !important;
            }

            .today {
                background: linear-gradient(
                    135deg,
                    rgba(168, 213, 226, 0.2),
                    rgba(212, 233, 247, 0.2)
                ) !important;
                border: 2px solid var(--glacier);
            }

            .future-day {
                background: white !important;
            }

            .add-resort-btn {
                padding: 14px 28px;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                border: none;
                border-radius: 8px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.1rem;
                font-weight: 700;
                text-transform: uppercase;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
                margin-top: 10px;
            }

            .add-resort-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: fadeInOverlay 0.3s ease-out;
            }

            @keyframes fadeInOverlay {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .modal {
                background: white;
                border-radius: 16px;
                padding: 40px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideInModal 0.3s ease-out;
            }

            @keyframes slideInModal {
                from {
                    opacity: 0;
                    transform: translateY(-50px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .modal-header {
                font-family: "Barlow Condensed", sans-serif;
                font-size: 2rem;
                font-weight: 700;
                color: var(--deep-blue);
                margin-bottom: 25px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .search-input {
                width: 100%;
                padding: 15px 20px;
                border: 2px solid var(--glacier);
                border-radius: 8px;
                font-family: "JetBrains Mono", monospace;
                font-size: 1rem;
                margin-bottom: 20px;
                transition: border-color 0.3s ease;
            }

            .search-input:focus {
                outline: none;
                border-color: var(--deep-blue);
            }

            .search-results {
                max-height: 300px;
                overflow-y: auto;
                margin-bottom: 20px;
            }

            .search-result-item {
                padding: 15px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .search-result-item:hover {
                background: var(--powder);
                border-color: var(--glacier);
                transform: translateX(5px);
            }

            .result-name {
                font-weight: 700;
                color: var(--deep-blue);
                font-size: 1.1rem;
                margin-bottom: 5px;
            }

            .result-info {
                font-size: 0.85rem;
                color: #7f8c8d;
            }

            .modal-buttons {
                display: flex;
                gap: 15px;
                margin-top: 25px;
            }

            .modal-btn {
                flex: 1;
                padding: 14px;
                border: none;
                border-radius: 8px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1rem;
                font-weight: 700;
                text-transform: uppercase;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .modal-btn-cancel {
                background: #95a5a6;
                color: white;
            }

            .modal-btn-cancel:hover {
                background: #7f8c8d;
            }

            .loading-search {
                text-align: center;
                padding: 20px;
                color: var(--deep-blue);
                font-style: italic;
            }

            .no-results {
                text-align: center;
                padding: 20px;
                color: #95a5a6;
            }

            .resort-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }

            .resort-tag {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 15px;
                background: var(--glacier);
                color: var(--deep-blue);
                border-radius: 20px;
                font-weight: 600;
                font-size: 0.9rem;
            }

            .remove-resort {
                background: none;
                border: none;
                color: var(--deep-blue);
                cursor: pointer;
                font-size: 1.2rem;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s ease;
            }

            .remove-resort:hover {
                background: var(--deep-blue);
                color: white;
            }

            @media (max-width: 1200px) {
                h1 {
                    font-size: 2.5rem;
                }

                .main-content {
                    padding: 25px;
                }

                table {
                    font-size: 0.85rem;
                }

                th,
                td {
                    padding: 12px 10px;
                }
            }

            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                h1 {
                    font-size: 2rem;
                }

                h2 {
                    font-size: 1.5rem;
                }

                .main-content {
                    padding: 20px;
                }

                table {
                    font-size: 0.75rem;
                }

                th,
                td {
                    padding: 10px 6px;
                }

                .date-header {
                    font-size: 0.7rem;
                }

                .legend-item {
                    display: block;
                    margin-bottom: 8px;
                }

                .resort-inputs {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            // Configuration des secteurs de ski avec coordonn√©es
            const DEFAULT_RESORTS = [
                {
                    name: "Guzet",
                    lat: 42.7857,
                    lon: 1.2261,
                    altitude: 1400,
                    mbUrl: "guzet-neige_france_7580803",
                },
                {
                    name: "Piau-Engaly",
                    lat: 42.7833,
                    lon: 0.1667,
                    altitude: 1850,
                    mbUrl: "piau-engaly_france_8426488",
                },
                {
                    name: "Saint-Lary",
                    lat: 42.8167,
                    lon: 0.3167,
                    altitude: 1700,
                    mbUrl: "saint-lary-soulan_france_2978975",
                },
            ];

            const API_KEY = "LuUd7q9wHpiG1aWh";

            // === CACHE M√âT√âO (localStorage, TTL 2h) ===
            const CACHE_TTL_MS = 2 * 60 * 60 * 1000; // 2 heures
            const CACHE_KEY = "weatherCache";
            const CACHE_VERSION = 5; // Incr√©menter pour invalider le cache apr√®s un changement de logique

            function getWeatherCache() {
                try {
                    const raw = localStorage.getItem(CACHE_KEY);
                    if (!raw) return null;
                    const cache = JSON.parse(raw);
                    // Invalider si version diff√©rente
                    if (cache.version !== CACHE_VERSION) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    const age = Date.now() - cache.timestamp;
                    if (age > CACHE_TTL_MS) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    // Invalider le cache si aucun r√©sultat ne contient de donn√©es
                    const hasData =
                        cache.results && cache.results.some((r) => r.data);
                    if (!hasData) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    return cache;
                } catch {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
            }

            function setWeatherCache(resorts, results, braDataObj) {
                const cache = {
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    resortKeys: resorts.map(
                        (r) => `${r.name}_${r.lat}_${r.lon}_${r.altitude}`,
                    ),
                    results,
                    braData: braDataObj,
                };
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
                } catch (e) {
                    console.warn("Cache write failed:", e);
                }
            }

            function isCacheValidForResorts(cache, resorts) {
                if (!cache) return false;
                const currentKeys = resorts.map(
                    (r) => `${r.name}_${r.lat}_${r.lon}_${r.altitude}`,
                );
                return (
                    JSON.stringify(currentKeys) ===
                    JSON.stringify(cache.resortKeys)
                );
            }

            // === M√©t√©o France BRA ‚Äî API Key (header apikey:) ===
            // G√©n√©rer sur https://portail-api.meteofrance.fr > Mes APIs > G√©n√©rer Token
            // Mettre la dur√©e au maximum (ex: 31536000 = 1 an) pour √©viter de renouveler
            const MF_API_KEY =
                "eyJ4NXQiOiJZV0kxTTJZNE1qWTNOemsyTkRZeU5XTTRPV014TXpjek1UVmhNbU14T1RSa09ETXlOVEE0Tnc9PSIsImtpZCI6ImdhdGV3YXlfY2VydGlmaWNhdGVfYWxpYXMiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ0ZGF1dmV0QGNhcmJvbi5zdXBlciIsImFwcGxpY2F0aW9uIjp7Im93bmVyIjoidGRhdXZldCIsInRpZXJRdW90YVR5cGUiOm51bGwsInRpZXIiOiJVbmxpbWl0ZWQiLCJuYW1lIjoiRGVmYXVsdEFwcGxpY2F0aW9uIiwiaWQiOjM2OTU0LCJ1dWlkIjoiOWI5Y2VhNDAtYmEwZi00YzVhLTgwNDctM2EwYjM3NWQyODM3In0sImlzcyI6Imh0dHBzOlwvXC9wb3J0YWlsLWFwaS5tZXRlb2ZyYW5jZS5mcjo0NDNcL29hdXRoMlwvdG9rZW4iLCJ0aWVySW5mbyI6eyI1MFBlck1pbiI6eyJ0aWVyUXVvdGFUeXBlIjoicmVxdWVzdENvdW50IiwiZ3JhcGhRTE1heENvbXBsZXhpdHkiOjAsImdyYXBoUUxNYXhEZXB0aCI6MCwic3RvcE9uUXVvdGFSZWFjaCI6dHJ1ZSwic3Bpa2VBcnJlc3RMaW1pdCI6MCwic3Bpa2VBcnJlc3RVbml0Ijoic2VjIn19LCJrZXl0eXBlIjoiUFJPRFVDVElPTiIsInN1YnNjcmliZWRBUElzIjpbeyJzdWJzY3JpYmVyVGVuYW50RG9tYWluIjoiY2FyYm9uLnN1cGVyIiwibmFtZSI6IkRvbm5lZXNQdWJsaXF1ZXNCUkEiLCJjb250ZXh0IjoiXC9wdWJsaWNcL0RQQlJBXC92MSIsInB1Ymxpc2hlciI6ImJhc3RpZW5nIiwidmVyc2lvbiI6InYxIiwic3Vic2NyaXB0aW9uVGllciI6IjUwUGVyTWluIn1dLCJleHAiOjE4MDIzODIxMDEsInRva2VuX3R5cGUiOiJhcGlLZXkiLCJpYXQiOjE3NzA4NDYxMDEsImp0aSI6IjhkYzI2MjU0LTlmZTktNGIwNC1iYTQyLWIxNzhkZmQzMzI3MCJ9.T0Sah5HGtP61Lk2f7dUMVqxQUTj0kiOz0yn_ceaHuy_gtUSHFfZ0SDec28M72AHqh12On_IETCDNRFR90mrlzbWUTREK8h8b5GvR-wRtPrBAze0WQ_1GhSsOIMcHCETqioCSa84kAy6Kv1yazPlkHnP5Cn9ZNzB5K_x8Dqo1kyyNazuO-7lpnkovmWMg-vnCVYEGmkWaFPPQTpOR_uBn84hiEb1PoG0RJ5vjl5Yxv72kJ24uWSwS-hBQbxsXNhB_ddPTEdd4WIiwuC_wZ7aNsFRplJMCmgCeH7K0sRKy4sLWB4kuQuTozrIgeWny9q_QDlzpc73ZQBV4sSbXF_FcOg==";

            /**
             * R√©cup√®re les donn√©es BRA (Bulletin Risque Avalanche) pour un massif
             * @param {number} massifId - ID du massif M√©t√©o France
             * @returns {Promise<object>} Donn√©es BRA
             */
            async function fetchBRAData(massifId) {
                if (!massifId) return null;

                const baseUrl =
                    "https://public-api.meteofrance.fr/public/DPBRA/v1";
                const headers = {
                    apikey: MF_API_KEY,
                };

                try {
                    // R√©cup√©rer le XML du bulletin
                    const response = await fetch(
                        `${baseUrl}/massif/BRA?id-massif=${massifId}&format=xml`,
                        { headers },
                    );

                    if (!response.ok) {
                        console.warn(
                            `BRA indisponible pour massif ${massifId}: ${response.status}`,
                        );
                        return null;
                    }

                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                    // Extraire le risque depuis CARTOUCHERISQUE > RISQUE
                    const risqueEl = xmlDoc.querySelector(
                        "CARTOUCHERISQUE RISQUE",
                    );
                    if (!risqueEl) {
                        console.warn(
                            `BRA: pas de balise RISQUE pour massif ${massifId}`,
                        );
                        return null;
                    }

                    const dateBulletin =
                        xmlDoc.documentElement.getAttribute("DATEBULLETIN");
                    const dateEcheance =
                        xmlDoc.documentElement.getAttribute("DATEECHEANCE");

                    // Risque J1 : RISQUE1 est le risque principal, EVOLURISQUE1 l'√©volution
                    const risque1 =
                        parseInt(risqueEl.getAttribute("RISQUE1")) || 0;
                    const evoluRisque1 =
                        parseInt(risqueEl.getAttribute("EVOLURISQUE1")) || 0;
                    const risqueMaxi =
                        parseInt(risqueEl.getAttribute("RISQUEMAXI")) ||
                        risque1;

                    // Risque J2
                    const risqueMaxiJ2 =
                        parseInt(risqueEl.getAttribute("RISQUEMAXIJ2")) || 0;

                    // LOC1/LOC2 pour risques diff√©renci√©s par altitude (ex: "<2400" / ">2400")
                    const loc1 = risqueEl.getAttribute("LOC1") || "";
                    const loc2 = risqueEl.getAttribute("LOC2") || "";
                    const risque2 =
                        parseInt(risqueEl.getAttribute("RISQUE2")) || 0;

                    const braData = {};

                    // Aujourd'hui (J1) ‚Äî risque maxi, ou diff√©renci√© bas/haut si LOC1/LOC2 renseign√©s
                    if (loc1 && loc2 && risque2) {
                        braData["aujourd'hui"] = {
                            bas: risque1,
                            haut: risque2,
                            evolution: evoluRisque1,
                            date: dateEcheance,
                        };
                    } else {
                        braData["aujourd'hui"] = {
                            bas: risqueMaxi,
                            haut: risqueMaxi,
                            evolution: evoluRisque1,
                            date: dateEcheance,
                        };
                    }

                    // Demain (J2)
                    if (risqueMaxiJ2) {
                        const dateJ2 =
                            risqueEl.getAttribute("DATE_RISQUE_J2") || "";
                        braData["demain"] = {
                            bas: risqueMaxiJ2,
                            haut: risqueMaxiJ2,
                            date: dateJ2,
                        };
                    }

                    // Extraire les infos d√©taill√©es du BERA
                    const massifName =
                        xmlDoc.documentElement.getAttribute("MASSIF") || "";
                    const commentaireRisque =
                        risqueEl.getAttribute("COMMENTAIRE") || "";
                    const resume =
                        xmlDoc.querySelector("CARTOUCHERISQUE RESUME")
                            ?.textContent || "";
                    const stabilite =
                        xmlDoc.querySelector("STABILITE TEXTESANSTITRE")
                            ?.textContent || "";
                    const qualiteNeige =
                        xmlDoc.querySelector("QUALITE TEXTE")?.textContent ||
                        "";

                    // Enneigement
                    const enneigementEl = xmlDoc.querySelector("ENNEIGEMENT");
                    const enneigement = enneigementEl
                        ? {
                              limiteSud:
                                  enneigementEl.getAttribute("LimiteSud"),
                              limiteNord:
                                  enneigementEl.getAttribute("LimiteNord"),
                          }
                        : null;

                    // Pentes expos√©es
                    const penteEl = xmlDoc.querySelector(
                        "CARTOUCHERISQUE PENTE",
                    );
                    const pentes = penteEl
                        ? ["N", "NE", "E", "SE", "S", "SW", "W", "NW"].filter(
                              (d) => penteEl.getAttribute(d) === "true",
                          )
                        : [];

                    braData._detail = {
                        massifName,
                        massifId,
                        dateBulletin,
                        commentaireRisque,
                        resume,
                        stabilite,
                        qualiteNeige,
                        enneigement,
                        pentes,
                        risqueMaxi,
                        evoluRisque1,
                        risqueMaxiJ2,
                    };

                    return Object.keys(braData).length > 0 ? braData : null;
                } catch (error) {
                    console.error(`Erreur BRA pour massif ${massifId}:`, error);
                    return null;
                }
            }

            /**
             * Retourne la couleur selon le niveau de risque
             * @param {number} niveau - Niveau de risque (1-5)
             * @returns {string} Code couleur
             */
            function getBRAColor(niveau) {
                switch (niveau) {
                    case 1:
                        return "#27ae60"; // Vert
                    case 2:
                        return "#f1c40f"; // Jaune
                    case 3:
                        return "#e67e22"; // Orange
                    case 4:
                    case 5:
                        return "#e74c3c"; // Rouge
                    default:
                        return "#95a5a6"; // Gris
                }
            }

            // Weather codes import√©s depuis weatherCodes.js
            // Fonctions disponibles: getWeatherInfo(code, hour), adjustWeatherCodeForDaylight(code, hour)

            /**
             * Convertit une direction en degr√©s en fl√®che et point cardinal
             * @param {number} degrees - Direction en degr√©s (0-360)
             * @returns {object} { arrow: string, cardinal: string }
             */
            function getWindDirectionDisplay(degrees) {
                if (degrees === null || degrees === undefined) {
                    return { arrow: "", cardinal: "" };
                }

                // Normaliser entre 0-360
                const normalized = ((degrees % 360) + 360) % 360;

                // Points cardinaux (8 directions)
                const directions = [
                    { name: "N", arrow: "‚Üì" }, // 0¬∞ = Nord = vent vient du nord (fl√®che vers bas)
                    { name: "NE", arrow: "‚Üô" }, // 45¬∞
                    { name: "E", arrow: "‚Üê" }, // 90¬∞
                    { name: "SE", arrow: "‚Üñ" }, // 135¬∞
                    { name: "S", arrow: "‚Üë" }, // 180¬∞
                    { name: "SW", arrow: "‚Üó" }, // 225¬∞
                    { name: "W", arrow: "‚Üí" }, // 270¬∞
                    { name: "NW", arrow: "‚Üò" }, // 315¬∞
                ];

                const index = Math.round(normalized / 45) % 8;
                return directions[index];
            }

            /**
             * G√©n√®re l'URL Meteoblue pour un secteur
             * @param {string} name - Nom du secteur
             * @param {number} lat - Latitude
             * @param {number} lon - Longitude
             * @returns {string} URL Meteoblue
             */
            function getMeteoblueUrl(resort) {
                if (resort.mbUrl) {
                    return `https://www.meteoblue.com/fr/meteo/semaine/${resort.mbUrl}`;
                }
                // Fallback : URL bas√©e sur les coordonn√©es (moins fiable)
                const slug = resort.name
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/^-+|-+$/g, "");
                return `https://www.meteoblue.com/fr/meteo/semaine/${slug}?lat=${resort.lat}&lon=${resort.lon}&asl=${resort.altitude}`;
            }

            function AddResortModal({ isOpen, onClose, onAdd }) {
                const [searchQuery, setSearchQuery] = useState("");
                const [searchResults, setSearchResults] = useState([]);
                const [isSearching, setIsSearching] = useState(false);

                const searchLocation = async (query) => {
                    if (query.length < 3) {
                        setSearchResults([]);
                        return;
                    }

                    setIsSearching(true);
                    try {
                        const url = `https://www.meteoblue.com/en/server/search/query3?query=${encodeURIComponent(query)}&apikey=${API_KEY}`;
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.results) {
                            setSearchResults(data.results.slice(0, 10));
                        }
                    } catch (err) {
                        console.error("Erreur recherche:", err);
                        setSearchResults([]);
                    } finally {
                        setIsSearching(false);
                    }
                };

                useEffect(() => {
                    const timer = setTimeout(() => {
                        if (searchQuery) {
                            searchLocation(searchQuery);
                        }
                    }, 500);

                    return () => clearTimeout(timer);
                }, [searchQuery]);

                const handleSelect = (location) => {
                    onAdd({
                        name: location.name,
                        lat: location.lat,
                        lon: location.lon,
                        altitude: location.asl || 1000,
                        mbUrl: location.url || null,
                    });
                    setSearchQuery("");
                    setSearchResults([]);
                    onClose();
                };

                if (!isOpen) return null;

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div
                            className="modal"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="modal-header">
                                üèîÔ∏è Ajouter un Secteur
                            </div>

                            <input
                                type="text"
                                className="search-input"
                                placeholder="Rechercher une commune (min. 3 caract√®res - ex: Guzet, Saint-Lary...)"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                autoFocus
                            />

                            <div className="search-results">
                                {isSearching && (
                                    <div className="loading-search">
                                        üîç Recherche en cours...
                                    </div>
                                )}

                                {!isSearching &&
                                    searchResults.length === 0 &&
                                    searchQuery.length >= 3 && (
                                        <div className="no-results">
                                            Aucun r√©sultat trouv√©. Essayez une
                                            autre recherche.
                                        </div>
                                    )}

                                {!isSearching &&
                                    searchQuery.length > 0 &&
                                    searchQuery.length < 3 && (
                                        <div className="no-results">
                                            Tapez au moins 3 caract√®res pour
                                            lancer la recherche.
                                        </div>
                                    )}

                                {!isSearching &&
                                    searchResults.map((result, index) => (
                                        <div
                                            key={index}
                                            className="search-result-item"
                                            onClick={() => handleSelect(result)}
                                        >
                                            <div className="result-name">
                                                {result.name}
                                            </div>
                                            <div className="result-info">
                                                üìç {result.country || ""}{" "}
                                                {result.admin1
                                                    ? `‚Ä¢ ${result.admin1}`
                                                    : ""}{" "}
                                                {result.asl
                                                    ? `‚Ä¢ Alt: ${result.asl}m`
                                                    : ""}
                                            </div>
                                        </div>
                                    ))}
                            </div>

                            <div className="modal-buttons">
                                <button
                                    className="modal-btn modal-btn-cancel"
                                    onClick={onClose}
                                >
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            function MountainWeatherApp() {
                const [resorts, setResorts] = useState(() => {
                    const saved = localStorage.getItem("skiResorts");
                    return saved ? JSON.parse(saved) : DEFAULT_RESORTS;
                });
                const [weatherData, setWeatherData] = useState([]);
                const [snowData, setSnowData] = useState([]);
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);
                const [currentDate, setCurrentDate] = useState("");
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [lastUpdate, setLastUpdate] = useState(null);
                const [apiCallsLog, setApiCallsLog] = useState(() => {
                    const saved = localStorage.getItem("apiCallsLog");
                    return saved ? JSON.parse(saved) : [];
                });
                const [viewMode, setViewMode] = useState("day"); // 'day' ou 'hourly'
                const [braData, setBraData] = useState({}); // { resortName: { aujourd'hui: {bas, haut}, demain: {bas, haut}, _detail: {...} } }
                const [beraModal, setBeraModal] = useState(null); // { resortName, detail } ou null
                const [loadedFromCache, setLoadedFromCache] = useState(false);

                // Logger un appel API
                const logApiCall = (
                    resortName,
                    success = true,
                    errorMsg = null,
                ) => {
                    const logEntry = {
                        timestamp: new Date().toISOString(),
                        resort: resortName,
                        success,
                        error: errorMsg,
                        dateFormatted: new Date().toLocaleString("fr-FR"),
                    };

                    const updatedLog = [...apiCallsLog, logEntry];
                    setApiCallsLog(updatedLog);
                    localStorage.setItem(
                        "apiCallsLog",
                        JSON.stringify(updatedLog),
                    );

                    console.log("üìä Appel API:", logEntry);
                };

                // T√©l√©charger le fichier de log
                const downloadLog = () => {
                    const logText = apiCallsLog
                        .map(
                            (entry) =>
                                `${entry.dateFormatted} | ${entry.resort} | ${entry.success ? "SUCCESS" : "FAILED"} ${entry.error ? `| Error: ${entry.error}` : ""}`,
                        )
                        .join("\n");

                    const blob = new Blob([logText], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `meteoblue-api-log-${new Date().toISOString().split("T")[0]}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                // R√©initialiser le log
                const clearLog = () => {
                    setApiCallsLog([]);
                    localStorage.setItem("apiCallsLog", JSON.stringify([]));
                    console.log("üóëÔ∏è Log des appels API r√©initialis√©");
                };

                // Calculer les statistiques
                const getApiStats = () => {
                    const today = new Date().toDateString();
                    const todayCalls = apiCallsLog.filter(
                        (log) =>
                            new Date(log.timestamp).toDateString() === today,
                    );

                    return {
                        total: apiCallsLog.length,
                        today: todayCalls.length,
                        failed: apiCallsLog.filter((log) => !log.success)
                            .length,
                    };
                };

                useEffect(() => {
                    const now = new Date();
                    setCurrentDate(
                        now.toLocaleDateString("fr-FR", {
                            weekday: "long",
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        }) +
                            " √† " +
                            now.toLocaleTimeString("fr-FR", {
                                hour: "2-digit",
                                minute: "2-digit",
                            }),
                    );

                    // Charger la derni√®re mise √† jour depuis localStorage
                    const savedUpdate =
                        localStorage.getItem("lastWeatherUpdate");
                    if (savedUpdate) {
                        setLastUpdate(savedUpdate);
                    }

                    // Charger les donn√©es au premier chargement (ignore les restrictions)
                    if (resorts.length > 0) {
                        loadInitialWeatherData();
                    }
                }, []);

                const loadInitialWeatherData = async () => {
                    // V√©rifier le cache avant d'appeler l'API
                    const cache = getWeatherCache();
                    if (cache && isCacheValidForResorts(cache, resorts)) {
                        const cacheAgeMin = Math.round(
                            (Date.now() - cache.timestamp) / 60000,
                        );
                        console.log(
                            `üì¶ Cache valide (${cacheAgeMin} min) ‚Äî aucun appel API`,
                        );

                        processWeatherData(cache.results);
                        processSnowData(cache.results);
                        if (cache.braData) setBraData(cache.braData);
                        setLoadedFromCache(true);

                        const cachedDate = new Date(cache.timestamp);
                        setLastUpdate(cachedDate.toISOString());
                        setCurrentDate(
                            cachedDate.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " √† " +
                                cachedDate.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                        return;
                    }

                    console.log("üåê Pas de cache valide ‚Äî appel API Meteoblue");
                    setLoadedFromCache(false);
                    setLoading(true);
                    setError(null);

                    try {
                        const promises = resorts.map((resort) =>
                            fetchWeatherForResort(resort),
                        );
                        const results = await Promise.all(promises);

                        processWeatherData(results);
                        processSnowData(results);

                        // Charger les donn√©es BRA pour tous les secteurs
                        const braPromises = resorts.map(async (resort) => {
                            const massif = getMassifFromCoords(
                                resort.lat,
                                resort.lon,
                                resort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                return data
                                    ? { name: resort.name, data }
                                    : null;
                            }
                            return null;
                        });

                        const braResults = await Promise.all(braPromises);
                        const braDataObj = {};
                        braResults.forEach((result) => {
                            if (result) {
                                braDataObj[result.name] = result.data;
                            }
                        });
                        setBraData(braDataObj);

                        // Sauvegarder dans le cache
                        setWeatherCache(resorts, results, braDataObj);

                        // Enregistrer l'heure de mise √† jour
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        localStorage.setItem(
                            "lastWeatherUpdate",
                            now.toISOString(),
                        );

                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " √† " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                    } catch (err) {
                        setError(
                            `Erreur lors de la r√©cup√©ration des donn√©es: ${err.message}`,
                        );
                    } finally {
                        setLoading(false);
                    }
                };

                useEffect(() => {
                    localStorage.setItem("skiResorts", JSON.stringify(resorts));
                }, [resorts]);

                const addResort = async (newResort) => {
                    // Ajouter le secteur √† la liste
                    const updatedResorts = [...resorts, newResort];
                    setResorts(updatedResorts);

                    // Charger uniquement les donn√©es pour ce nouveau secteur (sans loading g√©n√©ral)
                    try {
                        const result = await fetchWeatherForResort(newResort);

                        // Ajouter les donn√©es m√©t√©o du nouveau secteur
                        if (result.data) {
                            const newWeatherData =
                                processWeatherDataForResort(result);
                            const newSnowData =
                                processSnowDataForResort(result);

                            if (newWeatherData) {
                                setWeatherData((prev) => [
                                    ...prev,
                                    newWeatherData,
                                ]);
                            }
                            if (newSnowData) {
                                setSnowData((prev) => [...prev, newSnowData]);
                            }

                            // R√©cup√©rer les donn√©es BRA pour ce secteur
                            const massif = getMassifFromCoords(
                                newResort.lat,
                                newResort.lon,
                                newResort.name,
                            );
                            if (massif) {
                                console.log(
                                    `üèîÔ∏è Massif d√©tect√© pour ${newResort.name}: ${massif.name} (ID ${massif.id})`,
                                );
                                const data = await fetchBRAData(massif.id);
                                if (data) {
                                    setBraData((prev) => ({
                                        ...prev,
                                        [newResort.name]: data,
                                    }));
                                }
                            }
                        }
                        // Invalider le cache (la liste de stations a chang√©)
                        localStorage.removeItem(CACHE_KEY);
                    } catch (err) {
                        console.error(
                            "Erreur lors de l'ajout du secteur:",
                            err,
                        );
                    }
                };

                const removeResort = (index) => {
                    // Retirer le secteur et ses donn√©es
                    const newResorts = resorts.filter((_, i) => i !== index);
                    setResorts(newResorts);
                    setWeatherData((prev) =>
                        prev.filter((_, i) => i !== index),
                    );
                    setSnowData((prev) => prev.filter((_, i) => i !== index));
                    // Invalider le cache (la liste de stations a chang√©)
                    localStorage.removeItem(CACHE_KEY);
                };

                const fetchWeatherForResort = async (resort) => {
                    // Utiliser le package qui inclut les donn√©es horaires
                    const url = `https://my.meteoblue.com/packages/basic-1h_basic-day_snowice-day_wind-1h_wind-day?apikey=${API_KEY}&lat=${resort.lat}&lon=${resort.lon}&asl=${resort.altitude}&format=json`;

                    // DEBUG pour Pic de Lurtet
                    const isPicLurtet = resort.name
                        .toLowerCase()
                        .includes("lurtet");
                    if (isPicLurtet) {
                        console.log(
                            "üåê ========== APPEL API PIC DE LURTET ==========",
                        );
                        console.log("üìç Coordonn√©es utilis√©es:");
                        console.log("   Latitude:", resort.lat);
                        console.log("   Longitude:", resort.lon);
                        console.log("   Altitude:", resort.altitude);
                        console.log(
                            "üîó URL API (sans cl√©):",
                            url.replace(API_KEY, "XXX"),
                        );
                    }

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            logApiCall(
                                resort.name,
                                false,
                                `HTTP ${response.status}`,
                            );
                            throw new Error(
                                `Erreur API pour ${resort.name}: ${response.status}`,
                            );
                        }
                        const data = await response.json();
                        logApiCall(resort.name, true);

                        if (isPicLurtet) {
                            console.log(
                                "‚úÖ R√©ponse API re√ßue pour Pic de Lurtet",
                            );
                            console.log(
                                "üåê ========== FIN APPEL API ==========",
                            );
                        }

                        return { ...resort, data };
                    } catch (err) {
                        console.error(`Erreur pour ${resort.name}:`, err);
                        logApiCall(resort.name, false, err.message);
                        return { ...resort, data: null, error: err.message };
                    }
                };

                const fetchAllWeatherData = async () => {
                    console.log(
                        "üîÑ Actualisation forc√©e ‚Äî appel API Meteoblue",
                    );
                    setLoadedFromCache(false);
                    setLoading(true);
                    setError(null);

                    try {
                        const promises = resorts.map((resort) =>
                            fetchWeatherForResort(resort),
                        );
                        const results = await Promise.all(promises);

                        processWeatherData(results);
                        processSnowData(results);

                        // Recharger les BRA aussi
                        const braPromises = resorts.map(async (resort) => {
                            const massif = getMassifFromCoords(
                                resort.lat,
                                resort.lon,
                                resort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                return data
                                    ? { name: resort.name, data }
                                    : null;
                            }
                            return null;
                        });
                        const braResults = await Promise.all(braPromises);
                        const braDataObj = {};
                        braResults.forEach((result) => {
                            if (result) braDataObj[result.name] = result.data;
                        });
                        setBraData(braDataObj);

                        // Sauvegarder dans le cache
                        setWeatherCache(resorts, results, braDataObj);

                        // Enregistrer l'heure de mise √† jour
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        localStorage.setItem(
                            "lastWeatherUpdate",
                            now.toISOString(),
                        );

                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " √† " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                    } catch (err) {
                        setError(
                            `Erreur lors de la r√©cup√©ration des donn√©es: ${err.message}`,
                        );
                    } finally {
                        setLoading(false);
                    }
                };

                const getDayLabel = (offset) => {
                    const date = new Date();
                    date.setDate(date.getDate() + offset);

                    if (offset === 0) return "Aujourd'hui";
                    if (offset === 1) return "Demain";

                    // Pour J+2 et plus : afficher le jour de la semaine + date
                    const dayName = date.toLocaleDateString("fr-FR", {
                        weekday: "long",
                    });
                    const dateStr = date.toLocaleDateString("fr-FR", {
                        day: "2-digit",
                        month: "2-digit",
                    });
                    return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${dateStr}`;
                };

                const processWeatherDataForResort = (resort) => {
                    if (!resort.data || !resort.data.data_day) {
                        console.log(
                            "Pas de donn√©es journali√®res pour",
                            resort.name,
                        );
                        return null;
                    }

                    const dayData = resort.data.data_day;
                    const hourData = resort.data.data_1h; // Donn√©es horaires
                    const days = {};

                    // DEBUG APPROFONDI pour Pic de Lurtet
                    const isPicLurtet = resort.name
                        .toLowerCase()
                        .includes("lurtet");
                    if (isPicLurtet) {
                        console.log(
                            "üîç ========== DEBUG PIC DE LURTET ==========",
                        );
                        console.log("üìç Coordonn√©es:", {
                            lat: resort.lat,
                            lon: resort.lon,
                            altitude: resort.altitude,
                        });
                        console.log(
                            "üìÖ Date actuelle:",
                            new Date().toISOString(),
                        );
                        console.log(
                            "üìä Donn√©es journali√®res (data_day.time):",
                            dayData.time,
                        );
                        console.log(
                            "üå°Ô∏è Temp√©ratures min:",
                            dayData.temperature_min,
                        );
                        console.log(
                            "üå°Ô∏è Temp√©ratures max:",
                            dayData.temperature_max,
                        );

                        if (hourData && hourData.time) {
                            console.log(
                                "‚è∞ Premier timestamp horaire:",
                                hourData.time[0],
                            );
                            console.log(
                                "‚è∞ Dernier timestamp horaire:",
                                hourData.time[hourData.time.length - 1],
                            );
                            console.log(
                                "üìä Nombre total d'heures:",
                                hourData.time.length,
                            );
                        }
                    }

                    // ‚úÖ CORRECTION FINALE : Trouver dynamiquement l'index qui correspond √† aujourd'hui
                    const today = new Date();
                    const todayStr = today.toISOString().split("T")[0]; // "2026-02-09"

                    let todayIndex = -1;
                    for (let i = 0; i < dayData.time.length; i++) {
                        if (dayData.time[i] === todayStr) {
                            todayIndex = i;
                            break;
                        }
                    }

                    if (isPicLurtet) {
                        console.log(
                            "üéØ Recherche de la date d'aujourd'hui:",
                            todayStr,
                        );
                        console.log(
                            "üìå Index trouv√© pour aujourd'hui:",
                            todayIndex,
                        );
                    }

                    // Si on ne trouve pas aujourd'hui, utiliser le premier jour disponible
                    if (todayIndex === -1) {
                        if (isPicLurtet) {
                            console.log(
                                "‚ö†Ô∏è Aujourd'hui non trouv√© dans les donn√©es",
                            );
                            console.log(
                                "   Les donn√©es commencent √†:",
                                dayData.time[0],
                            );
                        }
                        todayIndex = 0;
                    }

                    console.log("Traitement des donn√©es pour", resort.name);
                    console.log(
                        "- Donn√©es journali√®res (data_day):",
                        dayData ? "OK" : "Manquant",
                    );
                    console.log(
                        "- Donn√©es horaires (data_1h):",
                        hourData ? "OK" : "Manquant",
                    );
                    console.log(
                        "- Index aujourd'hui:",
                        todayIndex,
                        "‚Üí",
                        dayData.time[todayIndex],
                    );

                    // On r√©cup√®re 5 jours : aujourd'hui + 4 jours futurs
                    for (let offset = 0; offset <= 4; offset++) {
                        const dataIndex = todayIndex + offset;

                        if (dataIndex >= 0 && dataIndex < dayData.time.length) {
                            const weatherCode =
                                dayData.pictocode?.[dataIndex] || 1;
                            const weatherInfo = getWeatherInfo(weatherCode);

                            // DEBUG pour Pic de Lurtet
                            if (isPicLurtet) {
                                console.log(
                                    `üìÜ Offset ${offset} (${offset === 0 ? "AUJOURD'HUI" : offset > 0 ? "J+" + offset : "J" + offset}):`,
                                );
                                console.log(
                                    `   Date: ${dayData.time[dataIndex]}`,
                                );
                                console.log(
                                    `   Temp min/max: ${dayData.temperature_min[dataIndex]}¬∞ / ${dayData.temperature_max[dataIndex]}¬∞`,
                                );
                            }

                            // Extraire les donn√©es horaires pour ce jour
                            let hourlyData = null;
                            if (hourData && hourData.time) {
                                const targetDate = dayData.time[dataIndex];
                                if (isPicLurtet) {
                                    console.log(
                                        `   üîç Extraction horaire pour: ${targetDate}`,
                                    );
                                }
                                hourlyData = extractHourlyData(
                                    hourData,
                                    targetDate,
                                    isPicLurtet,
                                );
                            }

                            days[offset] = {
                                offset,
                                date: dayData.time?.[dataIndex] || "",
                                condition: weatherInfo.desc,
                                icon: weatherInfo.icon,
                                temp_max:
                                    dayData.temperature_max?.[dataIndex] || 0,
                                temp_min:
                                    dayData.temperature_min?.[dataIndex] || 0,
                                wind: dayData.windspeed_max?.[dataIndex] || 0,
                                windDirection:
                                    dayData.winddirection?.[dataIndex] || null,
                                precipitation:
                                    dayData.precipitation?.[dataIndex] || 0,
                                hourly: hourlyData,
                            };
                        }
                    }

                    if (isPicLurtet) {
                        console.log(
                            "üîç ========== FIN DEBUG PIC DE LURTET ==========",
                        );
                    }

                    return {
                        name: resort.name,
                        days,
                    };
                };

                const extractHourlyData = (
                    hourData,
                    targetDate,
                    debugMode = false,
                ) => {
                    if (!hourData || !hourData.time) {
                        if (debugMode)
                            console.log(
                                "   ‚ö†Ô∏è Pas de donn√©es horaires disponibles",
                            );
                        return null;
                    }

                    // DEBUG : Afficher toutes les cl√©s disponibles dans hourData
                    if (debugMode) {
                        console.log(
                            "   üìã Variables disponibles dans data_1h:",
                            Object.keys(hourData).join(", "),
                        );
                    }

                    // NOUVEAU : Toutes les heures de 1h √† 23h (comme Meteoblue)
                    const requestedHours = [
                        1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
                        17, 18, 19, 20, 21, 22, 23,
                    ];
                    const result = {};

                    if (debugMode) {
                        console.log(
                            "   üîé Recherche horaires pour:",
                            targetDate,
                        );
                        console.log(
                            "   üìä Exemples de timestamps:",
                            hourData.time.slice(0, 5),
                        );
                    }

                    // V√©rifier si les timestamps sont en UTC
                    const firstTimestamp = hourData.time[0] || "";
                    const isUTC =
                        firstTimestamp.includes("Z") ||
                        !firstTimestamp.includes(" ");

                    if (debugMode && isUTC) {
                        console.log(
                            "   ‚ö†Ô∏è Timestamps en UTC d√©tect√©s - ajustement UTC+1 appliqu√©",
                        );
                    }

                    for (let i = 0; i < hourData.time.length; i++) {
                        const timeStr = hourData.time[i];

                        if (!timeStr.startsWith(targetDate)) continue;

                        // Extraire l'heure du timestamp
                        let hour;
                        if (timeStr.includes("T")) {
                            const timePart = timeStr.split("T")[1];
                            hour = parseInt(timePart.substring(0, 2));
                        } else if (timeStr.includes(" ")) {
                            const timePart = timeStr.split(" ")[1];
                            hour = parseInt(timePart.substring(0, 2));
                        } else {
                            continue;
                        }

                        // Conversion UTC ‚Üí Local si n√©cessaire
                        let localHour = hour;
                        if (isUTC) {
                            localHour = hour + 1;
                            if (localHour >= 24) localHour -= 24;
                        }

                        if (requestedHours.includes(localHour)) {
                            const weatherCode = hourData.pictocode?.[i] || 1;

                            // CORRECTION : Remplacer les codes NUIT par codes JOUR si l'heure est en journ√©e
                            let adjustedCode = weatherCode;
                            if (localHour >= 6 && localHour <= 20) {
                                // C'est le jour, convertir les codes nuit en codes jour
                                if (weatherCode === 31) adjustedCode = 1; // Nuit claire ‚Üí Ensoleill√©
                                if (weatherCode === 32) adjustedCode = 2; // Nuit peu nuageuse ‚Üí Peu nuageux
                                if (weatherCode === 33) adjustedCode = 4; // Nuit nuageuse ‚Üí Nuageux
                            }

                            const weatherInfo = getWeatherInfo(
                                adjustedCode,
                                localHour,
                            );
                            const temp = Math.round(
                                hourData.temperature?.[i] || 0,
                            );

                            // CORRECTION VENT : Tester TOUTES les variables possibles
                            let wind = 0;
                            let windVariableUsed = "none";

                            // Ordre de pr√©f√©rence pour correspondre √† Meteoblue
                            if (hourData.windgust && hourData.windgust[i]) {
                                wind = Math.round(hourData.windgust[i]);
                                windVariableUsed = "windgust";
                            } else if (
                                hourData.windspeed_max &&
                                hourData.windspeed_max[i]
                            ) {
                                wind = Math.round(hourData.windspeed_max[i]);
                                windVariableUsed = "windspeed_max";
                            } else if (
                                hourData.windspeed_mean &&
                                hourData.windspeed_mean[i]
                            ) {
                                wind = Math.round(hourData.windspeed_mean[i]);
                                windVariableUsed = "windspeed_mean";
                            } else if (
                                hourData.windspeed &&
                                hourData.windspeed[i]
                            ) {
                                wind = Math.round(hourData.windspeed[i]);
                                windVariableUsed = "windspeed";
                            }

                            // NOUVEAU : Direction du vent
                            const windDirection =
                                hourData.winddirection?.[i] || null;
                            let windDirCard = "";
                            if (windDirection !== null) {
                                // Convertir degr√©s en points cardinaux
                                const dirs = [
                                    "N",
                                    "NE",
                                    "E",
                                    "SE",
                                    "S",
                                    "SW",
                                    "W",
                                    "NW",
                                ];
                                const index =
                                    Math.round((windDirection % 360) / 45) % 8;
                                windDirCard = dirs[index];
                            }

                            result[localHour] = {
                                temp,
                                wind,
                                windDirection,
                                windDirectionCardinal: windDirCard,
                                icon: weatherInfo.icon,
                                condition: weatherInfo.desc,
                                timestamp: timeStr,
                                weatherCode: adjustedCode,
                                originalCode: weatherCode,
                            };

                            if (debugMode) {
                                console.log(
                                    `   ‚úì ${localHour}h (${isUTC ? hour + "h UTC" : "locale"}): temp=${temp}¬∞, vent=${wind}km/h (${windVariableUsed}) ${windDirCard}, code=${weatherCode}${weatherCode !== adjustedCode ? "‚Üí" + adjustedCode : ""}, ic√¥ne=${weatherInfo.icon} [${timeStr}]`,
                                );
                                // Afficher toutes les valeurs de vent disponibles
                                if (hourData.windspeed)
                                    console.log(
                                        `      windspeed: ${Math.round(hourData.windspeed[i])}km/h`,
                                    );
                                if (hourData.windspeed_mean)
                                    console.log(
                                        `      windspeed_mean: ${Math.round(hourData.windspeed_mean[i])}km/h`,
                                    );
                                if (hourData.windspeed_max)
                                    console.log(
                                        `      windspeed_max: ${Math.round(hourData.windspeed_max[i])}km/h`,
                                    );
                                if (hourData.windgust)
                                    console.log(
                                        `      windgust: ${Math.round(hourData.windgust[i])}km/h`,
                                    );
                            }
                        }
                    }

                    if (Object.keys(result).length === 0) {
                        if (debugMode) {
                            console.log(
                                "   ‚ö†Ô∏è Aucune donn√©e horaire trouv√©e pour",
                                targetDate,
                            );
                        }
                        return null;
                    }

                    return result;
                };

                const getTempTrend = (temp1, temp2) => {
                    const diff = temp2 - temp1;
                    if (Math.abs(diff) < 1)
                        return { symbol: "‚Üí", class: "trend-stable" };
                    if (diff > 0) return { symbol: "‚Üó", class: "trend-up" };
                    return { symbol: "‚Üò", class: "trend-down" };
                };

                const getWindTrend = (wind1, wind2) => {
                    const diff = wind2 - wind1;
                    if (Math.abs(diff) < 3)
                        return { symbol: "‚Üí", class: "trend-stable" };
                    if (diff > 0) return { symbol: "‚Üó", class: "trend-up" };
                    return { symbol: "‚Üò", class: "trend-down" };
                };

                const processSnowDataForResort = (resort) => {
                    if (!resort.data || !resort.data.data_day) {
                        return null;
                    }

                    const dayData = resort.data.data_day;
                    const snowByDay = [];

                    // ‚úÖ CORRECTION : Trouver dynamiquement l'index qui correspond √† aujourd'hui
                    const today = new Date();
                    const todayStr = today.toISOString().split("T")[0];

                    let todayIndex = -1;
                    for (let i = 0; i < dayData.time.length; i++) {
                        if (dayData.time[i] === todayStr) {
                            todayIndex = i;
                            break;
                        }
                    }

                    // Si on ne trouve pas aujourd'hui, utiliser le premier jour disponible
                    if (todayIndex === -1) {
                        todayIndex = 0;
                    }

                    // Calculer les chutes de neige pour 7 jours (de -2 √† +4)
                    for (let offset = -2; offset <= 4; offset++) {
                        const dataIndex = todayIndex + offset; // ‚úÖ Calcul√© depuis todayIndex

                        if (dataIndex >= 0 && dataIndex < dayData.time.length) {
                            const snowFraction =
                                dayData.snowfraction?.[dataIndex] || 0;
                            const precipitation =
                                dayData.precipitation?.[dataIndex] || 0;
                            const snowCm = Math.round(
                                (snowFraction * precipitation) / 10,
                            );
                            snowByDay.push(snowCm);
                        } else {
                            snowByDay.push(0);
                        }
                    }

                    return {
                        name: resort.name,
                        snowByDay,
                    };
                };

                const processWeatherData = (results) => {
                    const processed = results
                        .map((resort) => processWeatherDataForResort(resort))
                        .filter(Boolean);
                    setWeatherData(processed);
                };

                const processSnowData = (results) => {
                    const processed = results
                        .map((resort) => processSnowDataForResort(resort))
                        .filter(Boolean);
                    setSnowData(processed);
                };

                if (loading) {
                    return (
                        <div className="container">
                            <header>
                                <h1>‚õ∑Ô∏è M√©t√©o Montagne</h1>
                                <div className="subtitle">
                                    Dashboard Ski ‚Ä¢ Powered by Meteoblue
                                </div>
                            </header>
                            <div className="main-content">
                                <div className="loading">
                                    üîÑ Chargement des donn√©es m√©t√©o depuis
                                    Meteoblue...
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="container">
                        <header>
                            <h1>‚õ∑Ô∏è M√©t√©o Montagne</h1>
                            <div className="subtitle">
                                Dashboard Ski ‚Ä¢ Powered by Meteoblue
                            </div>
                            <div className="header-controls">
                                <div className="date-display">
                                    üìÖ Derni√®re mise √† jour : {currentDate}
                                    {loadedFromCache && (
                                        <span
                                            style={{
                                                marginLeft: "10px",
                                                padding: "2px 8px",
                                                background: "#27ae60",
                                                color: "white",
                                                borderRadius: "4px",
                                                fontSize: "0.75rem",
                                                fontWeight: "700",
                                            }}
                                        >
                                            CACHE
                                        </span>
                                    )}
                                    <div
                                        style={{
                                            marginTop: "8px",
                                            fontSize: "0.85rem",
                                            opacity: 0.8,
                                        }}
                                    >
                                        üìä Appels API aujourd'hui :{" "}
                                        {getApiStats().today} | Total :{" "}
                                        {getApiStats().total}
                                        {getApiStats().failed > 0 &&
                                            ` | ‚ö†Ô∏è √âchecs : ${getApiStats().failed}`}
                                    </div>
                                </div>
                                <div
                                    style={{
                                        display: "flex",
                                        flexDirection: "column",
                                        gap: "8px",
                                    }}
                                >
                                    <button
                                        className="refresh-btn"
                                        onClick={fetchAllWeatherData}
                                        disabled={loading}
                                        style={{
                                            opacity: loading ? 0.5 : 1,
                                            cursor: loading
                                                ? "not-allowed"
                                                : "pointer",
                                        }}
                                    >
                                        üîÑ Actualiser
                                    </button>
                                    <div
                                        style={{ display: "flex", gap: "5px" }}
                                    >
                                        <button
                                            onClick={downloadLog}
                                            style={{
                                                padding: "8px 12px",
                                                fontSize: "0.75rem",
                                                background: "#3498db",
                                                color: "white",
                                                border: "none",
                                                borderRadius: "4px",
                                                cursor: "pointer",
                                            }}
                                            title="T√©l√©charger le log des appels API"
                                        >
                                            üì• Log
                                        </button>
                                        <button
                                            onClick={clearLog}
                                            style={{
                                                padding: "8px 12px",
                                                fontSize: "0.75rem",
                                                background: "#95a5a6",
                                                color: "white",
                                                border: "none",
                                                borderRadius: "4px",
                                                cursor: "pointer",
                                            }}
                                            title="R√©initialiser le log"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div className="main-content">
                            {error && <div className="error">‚ö†Ô∏è {error}</div>}

                            <div style={{ marginBottom: "30px" }}>
                                <h3
                                    style={{
                                        fontFamily:
                                            "Barlow Condensed, sans-serif",
                                        fontSize: "1.3rem",
                                        color: "var(--deep-blue)",
                                        marginBottom: "15px",
                                    }}
                                >
                                    üìç Mes Secteurs
                                </h3>
                                {resorts.length > 0 ? (
                                    <div className="resort-list">
                                        {resorts.map((resort, index) => (
                                            <div
                                                key={index}
                                                className="resort-tag"
                                            >
                                                {resort.name}
                                                <button
                                                    className="remove-resort"
                                                    onClick={() =>
                                                        removeResort(index)
                                                    }
                                                    title="Retirer ce secteur"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div
                                        style={{
                                            padding: "20px",
                                            background: "var(--powder)",
                                            borderRadius: "8px",
                                            textAlign: "center",
                                            color: "var(--storm-gray)",
                                            fontSize: "0.95rem",
                                        }}
                                    >
                                        Aucun secteur ajout√©. Cliquez sur
                                        "Ajouter un Secteur" pour commencer.
                                    </div>
                                )}
                                <button
                                    className="add-resort-btn"
                                    onClick={() => setIsModalOpen(true)}
                                    style={{ marginTop: "15px" }}
                                >
                                    ‚ûï Ajouter un Secteur
                                </button>
                            </div>

                            {resorts.length > 0 ? (
                                <>
                                    {snowData.length > 0 && (
                                        <section className="section">
                                            <h2>
                                                <span className="icon">‚ùÑÔ∏è</span>
                                                Chutes de Neige (7 jours)
                                            </h2>
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Secteur</th>
                                                        {[
                                                            -2, -1, 0, 1, 2, 3,
                                                            4,
                                                        ].map((offset, i) => (
                                                            <th
                                                                key={offset}
                                                                className={
                                                                    offset === 0
                                                                        ? "today"
                                                                        : ""
                                                                }
                                                            >
                                                                {getDayLabel(
                                                                    offset,
                                                                )}
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {snowData.map(
                                                        (resort, index) => {
                                                            const resortInfo =
                                                                resorts[index];
                                                            const meteoblueUrl =
                                                                resortInfo
                                                                    ? getMeteoblueUrl(
                                                                          resortInfo,
                                                                      )
                                                                    : "#";
                                                            return (
                                                                <tr key={index}>
                                                                    <td>
                                                                        <a
                                                                            href={
                                                                                meteoblueUrl
                                                                            }
                                                                            target="_blank"
                                                                            rel="noopener noreferrer"
                                                                            style={{
                                                                                fontWeight:
                                                                                    "600",
                                                                            }}
                                                                        >
                                                                            {
                                                                                resort.name
                                                                            }
                                                                        </a>{" "}
                                                                        (
                                                                        {
                                                                            resortInfo?.altitude
                                                                        }
                                                                        m)
                                                                    </td>
                                                                    {resort.snowByDay.map(
                                                                        (
                                                                            snow,
                                                                            dayIndex,
                                                                        ) => {
                                                                            const offset =
                                                                                dayIndex -
                                                                                2; // convertir index 0-6 en offset -2 √† +4
                                                                            return (
                                                                                <td
                                                                                    key={
                                                                                        dayIndex
                                                                                    }
                                                                                    className={
                                                                                        offset ===
                                                                                        0
                                                                                            ? "today"
                                                                                            : ""
                                                                                    }
                                                                                >
                                                                                    <span
                                                                                        className={`snow-value ${snow > 15 ? "heavy-snow" : ""}`}
                                                                                    >
                                                                                        {
                                                                                            snow
                                                                                        }{" "}
                                                                                        cm
                                                                                    </span>
                                                                                </td>
                                                                            );
                                                                        },
                                                                    )}
                                                                </tr>
                                                            );
                                                        },
                                                    )}
                                                </tbody>
                                            </table>
                                        </section>
                                    )}

                                    {weatherData.length > 0 && (
                                        <section className="section">
                                            <div
                                                style={{
                                                    display: "flex",
                                                    justifyContent:
                                                        "space-between",
                                                    alignItems: "center",
                                                    marginBottom: "10px",
                                                }}
                                            >
                                                <h2 style={{ margin: 0 }}>
                                                    <span className="icon">
                                                        üå§Ô∏è
                                                    </span>
                                                    M√©t√©o Comparative (5 jours)
                                                </h2>
                                                <div className="view-toggle">
                                                    <button
                                                        className={`view-toggle-btn ${viewMode === "day" ? "active" : ""}`}
                                                        onClick={() =>
                                                            setViewMode("day")
                                                        }
                                                    >
                                                        üìÖ Vue Jour
                                                    </button>
                                                    <button
                                                        className={`view-toggle-btn ${viewMode === "hourly" ? "active" : ""}`}
                                                        onClick={() =>
                                                            setViewMode(
                                                                "hourly",
                                                            )
                                                        }
                                                    >
                                                        üïê Vue Horaire
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="unified-table-wrapper">
                                                <table className="unified-weather-table">
                                                    <thead>
                                                        <tr>
                                                            <th
                                                                className="sticky-first-col"
                                                                style={{
                                                                    background:
                                                                        "linear-gradient(135deg, var(--deep-blue) 0%, #2874a6 100%)",
                                                                    color: "white",
                                                                }}
                                                            >
                                                                Secteur
                                                            </th>
                                                            {viewMode === "day"
                                                                ? // Vue par jour
                                                                  [
                                                                      0, 1, 2,
                                                                      3, 4,
                                                                  ].map(
                                                                      (
                                                                          offset,
                                                                      ) => (
                                                                          <th
                                                                              key={
                                                                                  offset
                                                                              }
                                                                              className={`day-col-header ${offset === 0 ? "today-col" : ""}`}
                                                                              style={{
                                                                                  background:
                                                                                      offset ===
                                                                                      0
                                                                                          ? ""
                                                                                          : "linear-gradient(135deg, var(--deep-blue) 0%, #2874a6 100%)",
                                                                                  color: "white",
                                                                              }}
                                                                          >
                                                                              {getDayLabel(
                                                                                  offset,
                                                                              )}
                                                                          </th>
                                                                      ),
                                                                  )
                                                                : // Vue horaire (23 heures par jour : 1h-23h)
                                                                  [
                                                                      0, 1, 2,
                                                                      3, 4,
                                                                  ].map(
                                                                      (
                                                                          offset,
                                                                      ) => (
                                                                          <th
                                                                              key={
                                                                                  offset
                                                                              }
                                                                              colSpan={
                                                                                  23
                                                                              }
                                                                              className={`day-col-header ${offset === 0 ? "today-col" : ""}`}
                                                                              style={{
                                                                                  background:
                                                                                      offset ===
                                                                                      0
                                                                                          ? ""
                                                                                          : "linear-gradient(135deg, var(--deep-blue) 0%, #2874a6 100%)",
                                                                                  color: "white",
                                                                                  padding:
                                                                                      "8px 4px",
                                                                              }}
                                                                          >
                                                                              {getDayLabel(
                                                                                  offset,
                                                                              )}
                                                                          </th>
                                                                      ),
                                                                  )}
                                                        </tr>
                                                        {viewMode ===
                                                            "hourly" && (
                                                            <tr
                                                                style={{
                                                                    background:
                                                                        "linear-gradient(135deg, #5dade2 0%, #85c1e9 100%)",
                                                                    color: "white",
                                                                }}
                                                            >
                                                                <th
                                                                    className="sticky-first-col"
                                                                    style={{
                                                                        background:
                                                                            "linear-gradient(135deg, #5dade2 0%, #85c1e9 100%)",
                                                                        fontSize:
                                                                            "0.7rem",
                                                                    }}
                                                                ></th>
                                                                {[
                                                                    0, 1, 2, 3,
                                                                    4,
                                                                ].map(
                                                                    (
                                                                        offset,
                                                                    ) => (
                                                                        <React.Fragment
                                                                            key={
                                                                                offset
                                                                            }
                                                                        >
                                                                            {[
                                                                                1,
                                                                                2,
                                                                                3,
                                                                                4,
                                                                                5,
                                                                                6,
                                                                                7,
                                                                                8,
                                                                                9,
                                                                                10,
                                                                                11,
                                                                                12,
                                                                                13,
                                                                                14,
                                                                                15,
                                                                                16,
                                                                                17,
                                                                                18,
                                                                                19,
                                                                                20,
                                                                                21,
                                                                                22,
                                                                                23,
                                                                            ].map(
                                                                                (
                                                                                    h,
                                                                                ) => (
                                                                                    <th
                                                                                        key={
                                                                                            h
                                                                                        }
                                                                                        className="hourly-col-header"
                                                                                    >
                                                                                        {
                                                                                            h
                                                                                        }

                                                                                        h
                                                                                    </th>
                                                                                ),
                                                                            )}
                                                                        </React.Fragment>
                                                                    ),
                                                                )}
                                                            </tr>
                                                        )}
                                                    </thead>
                                                    <tbody>
                                                        {weatherData.map(
                                                            (
                                                                resort,
                                                                resortIndex,
                                                            ) => {
                                                                const resortInfo =
                                                                    resorts.find(
                                                                        (r) =>
                                                                            r.name ===
                                                                            resort.name,
                                                                    );
                                                                const meteoblueUrl =
                                                                    resortInfo
                                                                        ? getMeteoblueUrl(
                                                                              resortInfo,
                                                                          )
                                                                        : "#";
                                                                return (
                                                                    <tr
                                                                        key={
                                                                            resortIndex
                                                                        }
                                                                    >
                                                                        <td className="sticky-first-col">
                                                                            <a
                                                                                href={
                                                                                    meteoblueUrl
                                                                                }
                                                                                target="_blank"
                                                                                rel="noopener noreferrer"
                                                                                style={{
                                                                                    fontWeight:
                                                                                        "700",
                                                                                    display:
                                                                                        "block",
                                                                                }}
                                                                            >
                                                                                {
                                                                                    resort.name
                                                                                }
                                                                            </a>
                                                                            <div
                                                                                style={{
                                                                                    fontSize:
                                                                                        "0.7rem",
                                                                                    opacity: 0.8,
                                                                                    marginTop:
                                                                                        "2px",
                                                                                }}
                                                                            >
                                                                                (
                                                                                {resortInfo?.altitude ||
                                                                                    "?"}
                                                                                m)
                                                                            </div>
                                                                        </td>

                                                                        {viewMode ===
                                                                        "day"
                                                                            ? // Vue par jour
                                                                              [
                                                                                  0,
                                                                                  1,
                                                                                  2,
                                                                                  3,
                                                                                  4,
                                                                              ].map(
                                                                                  (
                                                                                      offset,
                                                                                  ) => {
                                                                                      const dayWeather =
                                                                                          resort
                                                                                              .days[
                                                                                              offset
                                                                                          ];
                                                                                      if (
                                                                                          !dayWeather
                                                                                      )
                                                                                          return (
                                                                                              <td
                                                                                                  key={
                                                                                                      offset
                                                                                                  }
                                                                                              >
                                                                                                  -
                                                                                              </td>
                                                                                          );

                                                                                      const avgTemp =
                                                                                          Math.round(
                                                                                              (dayWeather.temp_max +
                                                                                                  dayWeather.temp_min) /
                                                                                                  2,
                                                                                          );
                                                                                      const braDataForResort =
                                                                                          braData[
                                                                                              resort
                                                                                                  .name
                                                                                          ];

                                                                                      // D√©terminer quelle √©ch√©ance BRA afficher selon l'offset
                                                                                      let braEcheance =
                                                                                          null;
                                                                                      if (
                                                                                          offset ===
                                                                                              0 &&
                                                                                          braDataForResort?.[
                                                                                              "aujourd'hui"
                                                                                          ]
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort[
                                                                                                  "aujourd'hui"
                                                                                              ];
                                                                                      } else if (
                                                                                          offset ===
                                                                                              1 &&
                                                                                          braDataForResort?.demain
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort.demain;
                                                                                      } else if (
                                                                                          offset ===
                                                                                              2 &&
                                                                                          braDataForResort?.apresdemain
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort.apresdemain;
                                                                                      }

                                                                                      return (
                                                                                          <td
                                                                                              key={
                                                                                                  offset
                                                                                              }
                                                                                              className={`day-cell ${offset === 0 ? "today-cell" : ""}`}
                                                                                          >
                                                                                              <div className="day-cell-inner">
                                                                                                  <div
                                                                                                      className="day-cell-icon"
                                                                                                      title={
                                                                                                          dayWeather.condition
                                                                                                      }
                                                                                                  >
                                                                                                      {
                                                                                                          dayWeather.icon
                                                                                                      }
                                                                                                  </div>
                                                                                                  <div className="day-cell-info">
                                                                                                      <div className="info-row">
                                                                                                          <span
                                                                                                              style={{
                                                                                                                  fontWeight: 600,
                                                                                                              }}
                                                                                                          >
                                                                                                              {Math.round(
                                                                                                                  dayWeather.temp_min,
                                                                                                              )}

                                                                                                              ¬∞
                                                                                                              /{" "}
                                                                                                              {Math.round(
                                                                                                                  dayWeather.temp_max,
                                                                                                              )}

                                                                                                              ¬∞
                                                                                                          </span>
                                                                                                      </div>
                                                                                                      <div className="info-row">
                                                                                                          <span>
                                                                                                              {Math.round(
                                                                                                                  dayWeather.wind,
                                                                                                              )}{" "}
                                                                                                              km/h
                                                                                                          </span>
                                                                                                          {dayWeather.windDirection !==
                                                                                                              null &&
                                                                                                              (() => {
                                                                                                                  const windDir =
                                                                                                                      getWindDirectionDisplay(
                                                                                                                          dayWeather.windDirection,
                                                                                                                      );
                                                                                                                  return (
                                                                                                                      <span
                                                                                                                          style={{
                                                                                                                              marginLeft:
                                                                                                                                  "2px",
                                                                                                                          }}
                                                                                                                      >
                                                                                                                          <span className="wind-arrow">
                                                                                                                              {
                                                                                                                                  windDir.arrow
                                                                                                                              }
                                                                                                                          </span>
                                                                                                                          <span className="wind-cardinal">
                                                                                                                              {
                                                                                                                                  windDir.cardinal
                                                                                                                              }
                                                                                                                          </span>
                                                                                                                      </span>
                                                                                                                  );
                                                                                                              })()}
                                                                                                      </div>
                                                                                                      {braEcheance &&
                                                                                                          braEcheance.haut >
                                                                                                              0 && (
                                                                                                              <div className="info-row">
                                                                                                                  <span
                                                                                                                      style={{
                                                                                                                          backgroundColor:
                                                                                                                              getBRAColor(
                                                                                                                                  braEcheance.haut,
                                                                                                                              ),
                                                                                                                          color: "white",
                                                                                                                          padding:
                                                                                                                              "1px 6px",
                                                                                                                          borderRadius:
                                                                                                                              "3px",
                                                                                                                          fontWeight: 700,
                                                                                                                          boxShadow:
                                                                                                                              "0 1px 2px rgba(0,0,0,0.15)",
                                                                                                                      }}
                                                                                                                  >
                                                                                                                      Risque
                                                                                                                      :{" "}
                                                                                                                      {
                                                                                                                          braEcheance.haut
                                                                                                                      }
                                                                                                                      /5
                                                                                                                  </span>
                                                                                                              </div>
                                                                                                          )}
                                                                                                      {offset ===
                                                                                                          0 &&
                                                                                                          braDataForResort?._detail && (
                                                                                                              <div className="info-row">
                                                                                                                  <a
                                                                                                                      href="#"
                                                                                                                      onClick={(
                                                                                                                          e,
                                                                                                                      ) => {
                                                                                                                          e.preventDefault();
                                                                                                                          const detail =
                                                                                                                              braDataForResort._detail;
                                                                                                                          setBeraModal(
                                                                                                                              {
                                                                                                                                  resortName:
                                                                                                                                      resort.name,
                                                                                                                                  detail,
                                                                                                                                  loading: true,
                                                                                                                              },
                                                                                                                          );
                                                                                                                          fetch(
                                                                                                                              `https://public-api.meteofrance.fr/public/DPBRA/v1/massif/BRA?id-massif=${detail.massifId}&format=pdf`,
                                                                                                                              {
                                                                                                                                  headers:
                                                                                                                                      {
                                                                                                                                          apikey: MF_API_KEY,
                                                                                                                                      },
                                                                                                                              },
                                                                                                                          )
                                                                                                                              .then(
                                                                                                                                  (
                                                                                                                                      r,
                                                                                                                                  ) =>
                                                                                                                                      r.blob(),
                                                                                                                              )
                                                                                                                              .then(
                                                                                                                                  (
                                                                                                                                      blob,
                                                                                                                                  ) => {
                                                                                                                                      const url =
                                                                                                                                          URL.createObjectURL(
                                                                                                                                              blob,
                                                                                                                                          );
                                                                                                                                      setBeraModal(
                                                                                                                                          (
                                                                                                                                              prev,
                                                                                                                                          ) =>
                                                                                                                                              prev
                                                                                                                                                  ? {
                                                                                                                                                        ...prev,
                                                                                                                                                        pdfUrl: url,
                                                                                                                                                        loading: false,
                                                                                                                                                    }
                                                                                                                                                  : null,
                                                                                                                                      );
                                                                                                                                  },
                                                                                                                              )
                                                                                                                              .catch(
                                                                                                                                  () => {
                                                                                                                                      setBeraModal(
                                                                                                                                          (
                                                                                                                                              prev,
                                                                                                                                          ) =>
                                                                                                                                              prev
                                                                                                                                                  ? {
                                                                                                                                                        ...prev,
                                                                                                                                                        loading: false,
                                                                                                                                                        pdfError: true,
                                                                                                                                                    }
                                                                                                                                                  : null,
                                                                                                                                      );
                                                                                                                                  },
                                                                                                                              );
                                                                                                                      }}
                                                                                                                      style={{
                                                                                                                          cursor: "pointer",
                                                                                                                      }}
                                                                                                                  >
                                                                                                                      Voir
                                                                                                                      le
                                                                                                                      BERA
                                                                                                                  </a>
                                                                                                              </div>
                                                                                                          )}
                                                                                                  </div>
                                                                                              </div>
                                                                                          </td>
                                                                                      );
                                                                                  },
                                                                              )
                                                                            : // Vue horaire (1h-23h)
                                                                              [
                                                                                  0,
                                                                                  1,
                                                                                  2,
                                                                                  3,
                                                                                  4,
                                                                              ].map(
                                                                                  (
                                                                                      offset,
                                                                                  ) => {
                                                                                      const dayWeather =
                                                                                          resort
                                                                                              .days[
                                                                                              offset
                                                                                          ];
                                                                                      if (
                                                                                          !dayWeather ||
                                                                                          !dayWeather.hourly
                                                                                      ) {
                                                                                          return (
                                                                                              <React.Fragment
                                                                                                  key={
                                                                                                      offset
                                                                                                  }
                                                                                              >
                                                                                                  {[
                                                                                                      1,
                                                                                                      2,
                                                                                                      3,
                                                                                                      4,
                                                                                                      5,
                                                                                                      6,
                                                                                                      7,
                                                                                                      8,
                                                                                                      9,
                                                                                                      10,
                                                                                                      11,
                                                                                                      12,
                                                                                                      13,
                                                                                                      14,
                                                                                                      15,
                                                                                                      16,
                                                                                                      17,
                                                                                                      18,
                                                                                                      19,
                                                                                                      20,
                                                                                                      21,
                                                                                                      22,
                                                                                                      23,
                                                                                                  ].map(
                                                                                                      (
                                                                                                          h,
                                                                                                      ) => (
                                                                                                          <td
                                                                                                              key={
                                                                                                                  h
                                                                                                              }
                                                                                                              className={`hourly-cell ${offset === 0 ? "today-cell" : ""}`}
                                                                                                              style={{
                                                                                                                  fontSize:
                                                                                                                      "0.65rem",
                                                                                                                  color: "#95a5a6",
                                                                                                              }}
                                                                                                          >
                                                                                                              -
                                                                                                          </td>
                                                                                                      ),
                                                                                                  )}
                                                                                              </React.Fragment>
                                                                                          );
                                                                                      }

                                                                                      return (
                                                                                          <React.Fragment
                                                                                              key={
                                                                                                  offset
                                                                                              }
                                                                                          >
                                                                                              {[
                                                                                                  1,
                                                                                                  2,
                                                                                                  3,
                                                                                                  4,
                                                                                                  5,
                                                                                                  6,
                                                                                                  7,
                                                                                                  8,
                                                                                                  9,
                                                                                                  10,
                                                                                                  11,
                                                                                                  12,
                                                                                                  13,
                                                                                                  14,
                                                                                                  15,
                                                                                                  16,
                                                                                                  17,
                                                                                                  18,
                                                                                                  19,
                                                                                                  20,
                                                                                                  21,
                                                                                                  22,
                                                                                                  23,
                                                                                              ].map(
                                                                                                  (
                                                                                                      hour,
                                                                                                  ) => {
                                                                                                      const hourData =
                                                                                                          dayWeather
                                                                                                              .hourly[
                                                                                                              hour
                                                                                                          ];
                                                                                                      if (
                                                                                                          !hourData
                                                                                                      ) {
                                                                                                          return (
                                                                                                              <td
                                                                                                                  key={
                                                                                                                      hour
                                                                                                                  }
                                                                                                                  className={`hourly-cell ${offset === 0 ? "today-cell" : ""}`}
                                                                                                                  style={{
                                                                                                                      fontSize:
                                                                                                                          "0.65rem",
                                                                                                                      color: "#95a5a6",
                                                                                                                  }}
                                                                                                              >
                                                                                                                  -
                                                                                                              </td>
                                                                                                          );
                                                                                                      }

                                                                                                      return (
                                                                                                          <td
                                                                                                              key={
                                                                                                                  hour
                                                                                                              }
                                                                                                              className={`hourly-cell ${offset === 0 ? "today-cell" : ""}`}
                                                                                                          >
                                                                                                              <div
                                                                                                                  className="cell-icon"
                                                                                                                  title={
                                                                                                                      hourData.condition
                                                                                                                  }
                                                                                                              >
                                                                                                                  {
                                                                                                                      hourData.icon
                                                                                                                  }
                                                                                                              </div>
                                                                                                              <div className="cell-temp">
                                                                                                                  {
                                                                                                                      hourData.temp
                                                                                                                  }

                                                                                                                  ¬∞
                                                                                                              </div>
                                                                                                              <div className="cell-wind">
                                                                                                                  <span>
                                                                                                                      {
                                                                                                                          hourData.wind
                                                                                                                      }
                                                                                                                  </span>
                                                                                                                  {hourData.windDirection !==
                                                                                                                      null &&
                                                                                                                      (() => {
                                                                                                                          const windDir =
                                                                                                                              getWindDirectionDisplay(
                                                                                                                                  hourData.windDirection,
                                                                                                                              );
                                                                                                                          return (
                                                                                                                              <>
                                                                                                                                  <span className="wind-arrow">
                                                                                                                                      {
                                                                                                                                          windDir.arrow
                                                                                                                                      }
                                                                                                                                  </span>
                                                                                                                                  <span className="wind-cardinal">
                                                                                                                                      {
                                                                                                                                          windDir.cardinal
                                                                                                                                      }
                                                                                                                                  </span>
                                                                                                                              </>
                                                                                                                          );
                                                                                                                      })()}
                                                                                                              </div>
                                                                                                          </td>
                                                                                                      );
                                                                                                  },
                                                                                              )}
                                                                                          </React.Fragment>
                                                                                      );
                                                                                  },
                                                                              )}
                                                                    </tr>
                                                                );
                                                            },
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </section>
                                    )}
                                </>
                            ) : null}
                        </div>

                        <AddResortModal
                            isOpen={isModalOpen}
                            onClose={() => setIsModalOpen(false)}
                            onAdd={addResort}
                        />

                        {/* Modale BERA ‚Äî PDF embed */}
                        {beraModal && (
                            <div
                                style={{
                                    position: "fixed",
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    backgroundColor: "rgba(0,0,0,0.6)",
                                    zIndex: 9999,
                                    display: "flex",
                                    alignItems: "center",
                                    justifyContent: "center",
                                    padding: "16px",
                                }}
                                onClick={() => {
                                    if (beraModal.pdfUrl)
                                        URL.revokeObjectURL(beraModal.pdfUrl);
                                    setBeraModal(null);
                                }}
                            >
                                <div
                                    style={{
                                        background: "white",
                                        borderRadius: "12px",
                                        width: "100%",
                                        maxWidth: "900px",
                                        height: "90vh",
                                        display: "flex",
                                        flexDirection: "column",
                                        position: "relative",
                                        boxShadow:
                                            "0 20px 60px rgba(0,0,0,0.3)",
                                        overflow: "hidden",
                                    }}
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    {/* Header */}
                                    <div
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            padding: "16px 20px",
                                            borderBottom: "1px solid #e0e0e0",
                                            flexShrink: 0,
                                        }}
                                    >
                                        <div>
                                            <h2
                                                style={{
                                                    margin: 0,
                                                    fontSize: "1.1rem",
                                                    color: "var(--deep-blue)",
                                                }}
                                            >
                                                BERA ‚Äî{" "}
                                                {beraModal.detail.massifName}
                                            </h2>
                                            <div
                                                style={{
                                                    fontSize: "0.75rem",
                                                    color: "#666",
                                                    marginTop: "2px",
                                                }}
                                            >
                                                {beraModal.resortName} ‚Äî
                                                Bulletin du{" "}
                                                {new Date(
                                                    beraModal.detail
                                                        .dateBulletin,
                                                ).toLocaleDateString("fr-FR", {
                                                    weekday: "long",
                                                    day: "numeric",
                                                    month: "long",
                                                    year: "numeric",
                                                })}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (beraModal.pdfUrl)
                                                    URL.revokeObjectURL(
                                                        beraModal.pdfUrl,
                                                    );
                                                setBeraModal(null);
                                            }}
                                            style={{
                                                background: "#e0e0e0",
                                                border: "none",
                                                borderRadius: "50%",
                                                width: "36px",
                                                height: "36px",
                                                fontSize: "1.2rem",
                                                cursor: "pointer",
                                                display: "flex",
                                                alignItems: "center",
                                                justifyContent: "center",
                                                flexShrink: 0,
                                            }}
                                        >
                                            X
                                        </button>
                                    </div>

                                    {/* Contenu PDF */}
                                    <div
                                        style={{ flex: 1, overflow: "hidden" }}
                                    >
                                        {beraModal.loading ? (
                                            <div
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    height: "100%",
                                                    fontSize: "1rem",
                                                    color: "#666",
                                                }}
                                            >
                                                Chargement du BERA...
                                            </div>
                                        ) : beraModal.pdfError ? (
                                            <div
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    height: "100%",
                                                    fontSize: "0.9rem",
                                                    color: "#c00",
                                                }}
                                            >
                                                Impossible de charger le PDF du
                                                BERA.
                                            </div>
                                        ) : beraModal.pdfUrl ? (
                                            <iframe
                                                src={beraModal.pdfUrl}
                                                style={{
                                                    width: "100%",
                                                    height: "100%",
                                                    border: "none",
                                                }}
                                                title="BERA PDF"
                                            />
                                        ) : null}
                                    </div>

                                    {/* Footer */}
                                    <div
                                        style={{
                                            padding: "12px 20px",
                                            borderTop: "1px solid #e0e0e0",
                                            textAlign: "center",
                                            flexShrink: 0,
                                        }}
                                    >
                                        <button
                                            onClick={() => {
                                                if (beraModal.pdfUrl)
                                                    URL.revokeObjectURL(
                                                        beraModal.pdfUrl,
                                                    );
                                                setBeraModal(null);
                                            }}
                                            style={{
                                                background: "var(--deep-blue)",
                                                color: "white",
                                                border: "none",
                                                borderRadius: "8px",
                                                padding: "10px 32px",
                                                fontSize: "0.9rem",
                                                fontWeight: "600",
                                                cursor: "pointer",
                                            }}
                                        >
                                            Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            ReactDOM.render(
                <MountainWeatherApp />,
                document.getElementById("root"),
            );
        </script>
    </body>
</html>
