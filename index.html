<!doctype html>
<html lang="fr">
    <head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB6G3EL32M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CB6G3EL32M');
</script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ski rando Météo - Dashboard Ski de Randonnée</title>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="icons.js?v=7.14.0"></script>
        <script src="weatherCodes.js?v=7.15.0"></script>
        <script src="massifMapping.js?v=7.13.0"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Inter:wght@400;500&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="design-system.css?v=7.20.0" />
        <style>
            body {
                font-family: "JetBrains Mono", monospace;
                background: white;
                min-height: 100vh;
                padding: 0;
                color: var(--storm-gray);
            }

            .container {
                max-width: 1440px;
                margin: 0 auto;
                background: white;
                animation: slideDown 0.6s ease-out;
            }

            header {
                background: white;
                padding: 20px 75px;
                border-bottom: 1px solid #E1E8F2;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            h1 {
                margin-bottom: 0;
                display: flex;
                align-items: center;
            }

            .subtitle {
                font-size: 0.95rem;
                color: var(--storm-gray);
                font-weight: 500;
                letter-spacing: 1px;
            }

            .header-controls {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                align-items: center;
            }

            .date-display {
                flex: 1;
                padding: 10px 16px;
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                font-size: 0.85rem;
                color: var(--deep-blue);
                font-weight: 500;
            }

            .refresh-btn {
                font-size: 0.95rem;
            }

            .main-content {
                background: white;
                padding: 40px 75px;
                border-radius: 0;
                box-shadow: none;
            }

            .loading {
                text-align: center;
                padding: 60px 20px;
                font-size: 1.2rem;
                color: var(--deep-blue);
            }

            .error {
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 8px;
                padding: 14px 18px;
                margin: 16px 0;
                color: #dc2626;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .section {
                margin-bottom: 40px;
                animation: fadeIn 0.5s ease-out backwards;
            }

            .section:nth-child(1) {
                animation-delay: 0.1s;
            }
            .section:nth-child(2) {
                animation-delay: 0.2s;
            }

            h2 {
                font-family: "Garnett", sans-serif;
                font-size: 24px;
                font-weight: 500;
                color: #1F2023;
                line-height: normal;
                margin-bottom: 20px;
                padding-bottom: 0;
                border-bottom: none;
                display: flex;
                align-items: center;
                gap: 8px;
            }


            /* Generic table styles — overridden by .snow-table for snow section */
            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                border-radius: 10px;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
                border: 1px solid #e2e8f0;
                overflow: hidden;
            }

            thead {
                background: var(--deep-blue);
                color: white;
            }

            th {
                padding: 14px 16px;
                text-align: left;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 0.9rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-right: 1px solid rgba(255, 255, 255, 0.08);
            }

            th:first-child {
                font-size: 1rem;
                min-width: 180px;
            }

            th:last-child {
                border-right: none;
            }

            tbody tr {
                transition: background 0.15s ease;
                background: white;
            }

            tbody tr:nth-child(even) {
                background: #f8fafc;
            }

            tbody tr:hover {
                background: #f0f7ff;
            }

            td {
                padding: 14px 16px;
                border-right: 1px solid #f1f5f9;
                border-bottom: 1px solid #f1f5f9;
                font-size: 0.9rem;
            }

            td:first-child {
                font-weight: 600;
                color: var(--deep-blue);
                font-size: 0.95rem;
            }

            td:last-child {
                border-right: none;
            }

            .heavy-snow .snow-value {
                color: var(--warning-orange);
            }

            .date-header {
                font-size: 0.85rem;
                opacity: 0.9;
                display: block;
                margin-top: 4px;
                font-weight: 400;
            }

            .weather-icon {
                display: inline-flex;
                align-items: center;
                margin-right: 8px;
                vertical-align: middle;
            }
            .weather-icon svg {
                width: 22px;
                height: 22px;
            }

            .temp {
                font-weight: 600;
                color: var(--deep-blue);
            }

            .temp-cold {
                color: #3498db;
            }

            .temp-warm {
                color: var(--warning-orange);
            }

            .conditions {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .wind-info {
                font-size: 0.85rem;
                color: #7f8c8d;
                margin-top: 4px;
            }

            .legend {
                margin-top: 16px;
                padding: 12px 18px;
                background: #f8fafc;
                border-radius: 8px;
                font-size: 0.8rem;
                color: var(--storm-gray);
                border: 1px solid #e2e8f0;
            }

            .legend-item {
                display: inline-block;
                margin-right: 25px;
                margin-bottom: 5px;
            }

            /* Toggle View Switch — Surfline-style pill */
            .view-toggle-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            /* Toggle : utilise .toggle / .toggle-btn de design-system.css */

            /* Hourly sub-header */
            .hourly-col-header {
                text-align: center;
                padding: 4px 2px;
                font-family: "Garnett", sans-serif;
                font-size: 11px;
                font-weight: 500;
                color: #5E7690;
                min-width: 35px;
                max-width: 35px;
                border-right: 1px solid #E1E8F2;
                background: #F9FAFC;
            }

            /* Une heure sur deux en bold pour faciliter la lecture */
            .hourly-col-header:nth-child(2n + 2) {
                font-weight: 500;
                color: #1F2023;
            }

            .hourly-col-header:first-of-type {
                border-left: none;
            }

            .day-cell {
                padding: 38px 16px;
                min-width: 300px;
                min-height: 237px;
                vertical-align: middle;
                background: #f9fafc;
            }

            .day-cell-inner {
                display: flex;
                align-items: flex-start;
                gap: 16px;
            }

            .day-cell-icon {
                flex: 0 0 100px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                gap: 4px;
            }
            .day-cell-icon svg,
            .day-cell-icon img {
                width: 40px;
                height: 40px;
            }

            .day-cell-condition {
                font-family: "Inter", sans-serif;
                font-size: 12px;
                font-weight: 400;
                color: #45556C;
                line-height: 15px;
                text-align: center;
            }

            .day-cell-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            /* Ligne température : -4° + (-7° / -3°) sur la même ligne */
            .cell-temp-line {
                display: flex;
                align-items: baseline;
                gap: 4px;
                line-height: 32px;
            }
            .cell-temp-main {
                font-family: "Inter", sans-serif;
                font-size: 24px;
                font-weight: 700;
                color: #0F172B;
                line-height: 32px;
            }
            .cell-temp-range {
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 400;
                color: #62748E;
                line-height: 20px;
            }

            /* Lignes vent & rafales */
            .day-cell-info .info-row {
                display: flex;
                align-items: center;
                gap: 6px;
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 400;
                color: #314158;
                line-height: 20px;
            }
            .day-cell-info .info-row svg {
                width: 16px;
                height: 16px;
                flex-shrink: 0;
            }

            /* Badge BERA */
            .bera-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 8px;
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 600;
                color: #ffffff;
                line-height: 20px;
                cursor: default;
            }

            /* Lien "Voir le BERA" */
            .bera-link {
                font-family: "Inter", sans-serif;
                font-size: 14px;
                font-weight: 500;
                color: #155DFC;
                line-height: 20px;
                text-decoration: underline;
                cursor: pointer;
            }
            .bera-link:hover {
                color: #0f3fa0;
            }

            /* Lien vers la page Meteoblue du secteur */
            .resort-link {
                text-decoration: none;
                color: inherit;
            }
            .resort-link:hover .sector-name {
                text-decoration: underline;
            }

            /* ================================================
             * VUE HORAIRE (3h) — cellules compactes
             * Chaque cellule affiche verticalement :
             *   icône météo → température → vent (flèche + vitesse) → précipitations
             * ================================================ */
            .hourly-cell {
                text-align: center;
                padding: 8px 6px;
                min-width: 80px;
                border-right: 1px solid #E1E8F2;
                vertical-align: top;
                font-family: "Inter", sans-serif;
                font-size: 12px;
            }

            .cell-icon {
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 4px;
            }
            .cell-icon img {
                width: 28px;
                height: 28px;
            }

            .cell-temp {
                font-size: 13px;
                font-weight: 600;
                color: #1F2023;
                margin-bottom: 2px;
            }

            .cell-wind {
                font-size: 11px;
                color: #5E7690;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 2px;
                margin-bottom: 2px;
            }

            .wind-arrow {
                display: inline-flex;
                align-items: center;
                line-height: 1;
            }
            .wind-arrow svg {
                width: 14px;
                height: 14px;
            }

            /* Précipitations dans la cellule horaire */
            .cell-precip {
                font-size: 11px;
                font-weight: 500;
                color: #3498db;
            }
            .cell-precip.has-snow {
                color: #3498db;
                font-weight: 600;
            }
            .cell-precip.has-rain {
                color: #2980b9;
            }

            /* ---- Vue horaire : sticky column + en-têtes ----
             *
             * POURQUOI inline styles sur les th plutôt que ces classes :
             *   Le design-system a des règles `.snow-table thead th` et
             *   `.snow-table thead th:first-child` avec la même spécificité
             *   que `.hourly-view thead th:first-child`. Pour garantir
             *   l'application sans !important, les overrides critiques
             *   sont posés en inline style directement dans le JSX.
             *
             * Ce CSS gère uniquement les règles sans conflit de spécificité.
             * ---------------------------------------------------------------- */

            /* Hauteur auto pour le thead horaire (design-system impose 84px) */
            .hourly-view .snow-table thead tr {
                height: auto;
            }

            /* Séparateur visuel + sticky sur la colonne Secteur (th ET td) */
            .hourly-view .snow-table th:first-child,
            .hourly-view .snow-table td:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background: white;
                border-right: 2px solid #C8D6E5 !important;
                box-shadow: 3px 0 6px rgba(0, 0, 0, 0.07);
            }
            /* Le th Secteur passe en z-index 3 (inline style) pour rester au-dessus des td */

            /* Alternance légère sur les lignes du tbody */
            .hourly-view .snow-table tbody tr:nth-child(even) td:first-child {
                background: #f8fafc;
            }
            .hourly-view .snow-table tbody tr:hover td:first-child {
                background: #f0f7ff;
            }

            /* Séparateur vertical entre groupes de jours */
            .hourly-view .snow-table td.hourly-day-sep,
            .hourly-view .snow-table th.hourly-day-sep {
                border-right: 2px solid #7B9EC0 !important;
            }

            /* Tableau horaire détaillé */
            .hourly-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                overflow-x: auto;
                display: block;
            }

            .hourly-table thead,
            .hourly-table tbody {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            .resort-header-sticky {
                position: sticky;
                left: 0;
                z-index: 10;
                background: white;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                padding: 15px 20px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.3rem;
                color: var(--deep-blue);
                border-bottom: 2px solid var(--glacier);
                min-width: 200px;
                max-width: 200px;
            }

            .day-column {
                text-align: center;
                vertical-align: top;
                border-right: 1px solid #e2e8f0;
                padding: 0;
                min-width: 180px;
                max-width: 180px;
            }

            .day-column:last-child {
                border-right: none;
            }

            .day-header {
                background: var(--deep-blue);
                color: white;
                padding: 10px 6px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 0.8rem;
                font-weight: 700;
                text-transform: uppercase;
                line-height: 1.3;
            }

            .day-header.today-header {
                background: var(--fresh-green);
            }

            .hourly-slots {
                display: flex;
                flex-direction: row;
                border-top: 1px solid #e0e0e0;
            }

            .hour-slot {
                flex: 1;
                padding: 6px 3px;
                border-right: 1px solid #f0f0f0;
                min-width: 60px;
            }

            .hour-slot:last-child {
                border-right: none;
            }

            .hour-time {
                font-size: 0.7rem;
                font-weight: 700;
                color: var(--deep-blue);
                margin-bottom: 4px;
            }

            .hour-icon {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 3px 0;
            }
            .hour-icon svg {
                width: 22px;
                height: 22px;
            }

            .hour-temp {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--storm-gray);
                margin: 3px 0;
            }

            .temp-trend {
                font-size: 0.6rem;
                color: #95a5a6;
            }

            .hour-wind {
                font-size: 0.65rem;
                color: #7f8c8d;
                margin-top: 3px;
            }

            .wind-trend {
                font-size: 0.6rem;
                color: #95a5a6;
            }

            .trend-up {
                color: #e74c3c;
            }

            .trend-down {
                color: #3498db;
            }

            .trend-stable {
                color: #95a5a6;
            }

            .weather-table-wrapper {
                overflow-x: auto;
                margin-bottom: 40px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .weather-table-container {
                display: flex;
                min-width: fit-content;
            }

            .resort-name-column {
                position: sticky;
                left: 0;
                z-index: 10;
                background: var(--deep-blue);
                color: white;
                padding: 14px 18px;
                font-family: "Barlow Condensed", sans-serif;
                font-size: 1.1rem;
                font-weight: 700;
                text-transform: uppercase;
                display: flex;
                align-items: center;
                min-width: 200px;
                max-width: 200px;
                box-shadow: 3px 0 6px rgba(0, 0, 0, 0.06);
            }

            .days-container {
                display: flex;
                flex: 1;
            }

            .past-day {
                opacity: 0.7;
                background: #f8f9fa !important;
            }

            .today {
                background: linear-gradient(
                    135deg,
                    rgba(168, 213, 226, 0.2),
                    rgba(212, 233, 247, 0.2)
                ) !important;
                border: 2px solid var(--glacier);
            }

            .future-day {
                background: white !important;
            }

            .add-resort-btn {
                margin-top: 10px;
            }

            /* Modal, input : utilise .modal-overlay / .modal / .modal-header / .input de design-system.css */

            .search-input {
                margin-bottom: 16px;
            }

            .search-results {
                max-height: 300px;
                overflow-y: auto;
                margin-bottom: 20px;
            }

            .search-result-item {
                padding: 12px 14px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                margin-bottom: 8px;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .search-result-item:hover {
                background: #f0f7ff;
                border-color: var(--glacier);
            }

            .result-name {
                font-weight: 700;
                color: var(--deep-blue);
                font-size: 1.1rem;
                margin-bottom: 5px;
            }

            .result-info {
                font-size: 0.85rem;
                color: #7f8c8d;
            }

            .modal-buttons {
                display: flex;
                gap: 15px;
                margin-top: 25px;
            }

            .modal-limit-alert {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 16px;
                background: #FFF7ED;
                border: 1px solid #FDDCAB;
                border-radius: 8px;
                margin-bottom: 8px;
            }
            .modal-limit-alert .icon svg {
                width: 20px;
                height: 20px;
                color: #EA580C;
                flex-shrink: 0;
            }
            .modal-limit-alert p {
                margin: 0;
                font-family: "Inter", sans-serif;
                font-size: 14px;
                color: #9A3412;
                line-height: 20px;
            }


            .loading-search {
                text-align: center;
                padding: 20px;
                color: var(--deep-blue);
                font-style: italic;
            }

            .no-results {
                text-align: center;
                padding: 20px;
                color: #95a5a6;
            }

            .resort-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }

            /* Tag : utilise .tag de design-system.css */

            .remove-resort {
                background: none;
                border: none;
                color: var(--deep-blue);
                cursor: pointer;
                font-size: 1.2rem;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s ease;
            }

            .remove-resort:hover {
                background: var(--deep-blue);
                color: white;
            }

            @media (max-width: 1200px) {
                .logo-text-primary {
                    font-size: 1.6rem;
                }
                .logo-text-secondary {
                    font-size: 1.1rem;
                }
                .logo-icon svg {
                    width: 40px;
                    height: 40px;
                }

                .main-content {
                    padding: 25px;
                }

                table {
                    font-size: 0.85rem;
                }

                th,
                td {
                    padding: 12px 10px;
                }
            }

            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                .logo-text-primary {
                    font-size: 1.4rem;
                }
                .logo-text-secondary {
                    font-size: 1rem;
                }
                .logo-icon svg {
                    width: 36px;
                    height: 36px;
                }
                .logo {
                    gap: 10px;
                }

                h2 {
                    font-size: 1.5rem;
                }

                .main-content {
                    padding: 20px;
                }

                table {
                    font-size: 0.75rem;
                }

                th,
                td {
                    padding: 10px 6px;
                }

                .date-header {
                    font-size: 0.7rem;
                }

                .legend-item {
                    display: block;
                    margin-bottom: 8px;
                }

                .resort-inputs {
                    grid-template-columns: 1fr;
                }
            }

        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            // Configuration des secteurs de ski avec coordonnées
            const DEFAULT_RESORTS = [];

            // URL du proxy Cloudflare Worker
            const PROXY_URL = "https://ou-skier-proxy.tdauvet.workers.dev";

            const MAX_RESORTS = 5;


            // === CACHE MÉTÉO (localStorage, TTL 2h) ===
            const CACHE_TTL_MS = 2 * 60 * 60 * 1000; // 2 heures
            const CACHE_KEY = "weatherCache";
            // v10 : invalide cache v9 stocké sans data_3h (worker redéployé avec basic-3h)
            const CACHE_VERSION = 10;

            function getWeatherCache() {
                try {
                    const raw = localStorage.getItem(CACHE_KEY);
                    if (!raw) return null;
                    const cache = JSON.parse(raw);
                    // Invalider si version différente
                    if (cache.version !== CACHE_VERSION) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    const age = Date.now() - cache.timestamp;
                    if (age > CACHE_TTL_MS) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    // Invalider le cache si aucun résultat ne contient de données
                    const hasData =
                        cache.results && cache.results.some((r) => r.data);
                    if (!hasData) {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                    return cache;
                } catch {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
            }

            function setWeatherCache(resorts, results, braDataObj) {
                const cache = {
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    resortKeys: resorts.map(
                        (r) => `${r.name}_${r.lat}_${r.lon}_${r.altitude}`,
                    ),
                    results,
                    braData: braDataObj,
                };
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
                } catch (e) {
                    console.warn("Cache write failed:", e);
                }
            }

            function isCacheValidForResorts(cache, resorts) {
                if (!cache) return false;
                const currentKeys = resorts.map(
                    (r) => `${r.name}_${r.lat}_${r.lon}_${r.altitude}`,
                );
                return (
                    JSON.stringify(currentKeys) ===
                    JSON.stringify(cache.resortKeys)
                );
            }

            // === Météo France BRA — API Key (header apikey:) ===
            // Générer sur https://portail-api.meteofrance.fr > Mes APIs > Générer Token
            // Mettre la durée au maximum (ex: 31536000 = 1 an) pour éviter de renouveler
            const MF_API_KEY =
                "eyJ4NXQiOiJZV0kxTTJZNE1qWTNOemsyTkRZeU5XTTRPV014TXpjek1UVmhNbU14T1RSa09ETXlOVEE0Tnc9PSIsImtpZCI6ImdhdGV3YXlfY2VydGlmaWNhdGVfYWxpYXMiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ0ZGF1dmV0QGNhcmJvbi5zdXBlciIsImFwcGxpY2F0aW9uIjp7Im93bmVyIjoidGRhdXZldCIsInRpZXJRdW90YVR5cGUiOm51bGwsInRpZXIiOiJVbmxpbWl0ZWQiLCJuYW1lIjoiRGVmYXVsdEFwcGxpY2F0aW9uIiwiaWQiOjM2OTU0LCJ1dWlkIjoiOWI5Y2VhNDAtYmEwZi00YzVhLTgwNDctM2EwYjM3NWQyODM3In0sImlzcyI6Imh0dHBzOlwvXC9wb3J0YWlsLWFwaS5tZXRlb2ZyYW5jZS5mcjo0NDNcL29hdXRoMlwvdG9rZW4iLCJ0aWVySW5mbyI6eyI1MFBlck1pbiI6eyJ0aWVyUXVvdGFUeXBlIjoicmVxdWVzdENvdW50IiwiZ3JhcGhRTE1heENvbXBsZXhpdHkiOjAsImdyYXBoUUxNYXhEZXB0aCI6MCwic3RvcE9uUXVvdGFSZWFjaCI6dHJ1ZSwic3Bpa2VBcnJlc3RMaW1pdCI6MCwic3Bpa2VBcnJlc3RVbml0Ijoic2VjIn19LCJrZXl0eXBlIjoiUFJPRFVDVElPTiIsInN1YnNjcmliZWRBUElzIjpbeyJzdWJzY3JpYmVyVGVuYW50RG9tYWluIjoiY2FyYm9uLnN1cGVyIiwibmFtZSI6IkRvbm5lZXNQdWJsaXF1ZXNCUkEiLCJjb250ZXh0IjoiXC9wdWJsaWNcL0RQQlJBXC92MSIsInB1Ymxpc2hlciI6ImJhc3RpZW5nIiwidmVyc2lvbiI6InYxIiwic3Vic2NyaXB0aW9uVGllciI6IjUwUGVyTWluIn1dLCJleHAiOjE4MDIzODIxMDEsInRva2VuX3R5cGUiOiJhcGlLZXkiLCJpYXQiOjE3NzA4NDYxMDEsImp0aSI6IjhkYzI2MjU0LTlmZTktNGIwNC1iYTQyLWIxNzhkZmQzMzI3MCJ9.T0Sah5HGtP61Lk2f7dUMVqxQUTj0kiOz0yn_ceaHuy_gtUSHFfZ0SDec28M72AHqh12On_IETCDNRFR90mrlzbWUTREK8h8b5GvR-wRtPrBAze0WQ_1GhSsOIMcHCETqioCSa84kAy6Kv1yazPlkHnP5Cn9ZNzB5K_x8Dqo1kyyNazuO-7lpnkovmWMg-vnCVYEGmkWaFPPQTpOR_uBn84hiEb1PoG0RJ5vjl5Yxv72kJ24uWSwS-hBQbxsXNhB_ddPTEdd4WIiwuC_wZ7aNsFRplJMCmgCeH7K0sRKy4sLWB4kuQuTozrIgeWny9q_QDlzpc73ZQBV4sSbXF_FcOg==";

            /**
             * Récupère les données BRA (Bulletin Risque Avalanche) pour un massif
             * @param {number} massifId - ID du massif Météo France
             * @returns {Promise<object>} Données BRA
             */
            async function fetchBRAData(massifId) {
                if (!massifId) return null;

                const baseUrl =
                    "https://public-api.meteofrance.fr/public/DPBRA/v1";
                const headers = {
                    apikey: MF_API_KEY,
                };

                try {
                    // Récupérer le XML du bulletin
                    const response = await fetch(
                        `${baseUrl}/massif/BRA?id-massif=${massifId}&format=xml`,
                        { headers },
                    );

                    if (!response.ok) {
                        console.warn(
                            `BRA indisponible pour massif ${massifId}: ${response.status}`,
                        );
                        return null;
                    }

                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                    // Extraire le risque depuis CARTOUCHERISQUE > RISQUE
                    const risqueEl = xmlDoc.querySelector(
                        "CARTOUCHERISQUE RISQUE",
                    );
                    if (!risqueEl) {
                        console.warn(
                            `BRA: pas de balise RISQUE pour massif ${massifId}`,
                        );
                        return null;
                    }

                    const dateBulletin =
                        xmlDoc.documentElement.getAttribute("DATEBULLETIN");
                    const dateEcheance =
                        xmlDoc.documentElement.getAttribute("DATEECHEANCE");

                    // Risque J1 : RISQUE1 est le risque principal, EVOLURISQUE1 l'évolution
                    const risque1 =
                        parseInt(risqueEl.getAttribute("RISQUE1")) || 0;
                    const evoluRisque1 =
                        parseInt(risqueEl.getAttribute("EVOLURISQUE1")) || 0;
                    const risqueMaxi =
                        parseInt(risqueEl.getAttribute("RISQUEMAXI")) ||
                        risque1;

                    // Risque J2
                    const risqueMaxiJ2 =
                        parseInt(risqueEl.getAttribute("RISQUEMAXIJ2")) || 0;

                    // LOC1/LOC2 pour risques différenciés par altitude (ex: "<2400" / ">2400")
                    const loc1 = risqueEl.getAttribute("LOC1") || "";
                    const loc2 = risqueEl.getAttribute("LOC2") || "";
                    const risque2 =
                        parseInt(risqueEl.getAttribute("RISQUE2")) || 0;

                    const braData = {};

                    // Aujourd'hui (J1) — risque maxi, ou différencié bas/haut si LOC1/LOC2 renseignés
                    if (loc1 && loc2 && risque2) {
                        braData["aujourd'hui"] = {
                            bas: risque1,
                            haut: risque2,
                            evolution: evoluRisque1,
                            date: dateEcheance,
                        };
                    } else {
                        braData["aujourd'hui"] = {
                            bas: risqueMaxi,
                            haut: risqueMaxi,
                            evolution: evoluRisque1,
                            date: dateEcheance,
                        };
                    }

                    // Demain (J2)
                    if (risqueMaxiJ2) {
                        const dateJ2 =
                            risqueEl.getAttribute("DATE_RISQUE_J2") || "";
                        braData["demain"] = {
                            bas: risqueMaxiJ2,
                            haut: risqueMaxiJ2,
                            date: dateJ2,
                        };
                    }

                    // Extraire les infos détaillées du BERA
                    const massifName =
                        xmlDoc.documentElement.getAttribute("MASSIF") || "";
                    const commentaireRisque =
                        risqueEl.getAttribute("COMMENTAIRE") || "";
                    const resume =
                        xmlDoc.querySelector("CARTOUCHERISQUE RESUME")
                            ?.textContent || "";
                    const stabilite =
                        xmlDoc.querySelector("STABILITE TEXTESANSTITRE")
                            ?.textContent || "";
                    const qualiteNeige =
                        xmlDoc.querySelector("QUALITE TEXTE")?.textContent ||
                        "";

                    // Enneigement
                    const enneigementEl = xmlDoc.querySelector("ENNEIGEMENT");
                    const enneigement = enneigementEl
                        ? {
                              limiteSud:
                                  enneigementEl.getAttribute("LimiteSud"),
                              limiteNord:
                                  enneigementEl.getAttribute("LimiteNord"),
                          }
                        : null;

                    // Pentes exposées
                    const penteEl = xmlDoc.querySelector(
                        "CARTOUCHERISQUE PENTE",
                    );
                    const pentes = penteEl
                        ? ["N", "NE", "E", "SE", "S", "SW", "W", "NW"].filter(
                              (d) => penteEl.getAttribute(d) === "true",
                          )
                        : [];

                    braData._detail = {
                        massifName,
                        massifId,
                        dateBulletin,
                        commentaireRisque,
                        resume,
                        stabilite,
                        qualiteNeige,
                        enneigement,
                        pentes,
                        risqueMaxi,
                        evoluRisque1,
                        risqueMaxiJ2,
                    };

                    return Object.keys(braData).length > 0 ? braData : null;
                } catch (error) {
                    console.error(`Erreur BRA pour massif ${massifId}:`, error);
                    return null;
                }
            }

            /**
             * Retourne la couleur selon le niveau de risque
             * @param {number} niveau - Niveau de risque (1-5)
             * @returns {string} Code couleur
             */
            function getBRAColor(niveau) {
                switch (niveau) {
                    case 1:
                        return "#27ae60"; // Vert
                    case 2:
                        return "#f1c40f"; // Jaune
                    case 3:
                        return "#e67e22"; // Orange
                    case 4:
                    case 5:
                        return "#e74c3c"; // Rouge
                    default:
                        return "#95a5a6"; // Gris
                }
            }

            // Weather codes importés depuis weatherCodes.js
            // Fonctions disponibles: getWeatherInfo(code, hour)

            /**
             * Retourne la date d'aujourd'hui au format YYYY-MM-DD en heure locale France (Europe/Paris).
             * À utiliser pour comparer avec data_day.time retourné par Meteoblue (tz=Europe/Paris).
             */
            function getTodayStr() {
                return new Date().toLocaleDateString("en-CA", { timeZone: "Europe/Paris" });
            }

            /**
             * Convertit une direction en degrés en flèche et point cardinal
             * @param {number} degrees - Direction en degrés (0-360)
             * @returns {object} { arrow: string, cardinal: string }
             */
            function getWindDirectionDisplay(degrees) {
                if (degrees === null || degrees === undefined) {
                    return { cardinal: "" };
                }

                // Normaliser entre 0-360
                const normalized = ((degrees % 360) + 360) % 360;

                // Points cardinaux (8 directions)
                const cardinals = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];

                const index = Math.round(normalized / 45) % 8;
                return { cardinal: cardinals[index] };
            }

            /**
             * Couleur du vent selon la vitesse (km/h)
             */
            function getWindColor(speed) {
                if (speed >= 80) return "#c0392b"; // rouge — dangereux
                if (speed >= 50) return "#e67e22"; // orange — très fort
                if (speed >= 30) return "#f39c12"; // jaune-orange — fort
                return "inherit";
            }

            /**
             * Génère l'URL Meteoblue pour un secteur
             * @param {string} name - Nom du secteur
             * @param {number} lat - Latitude
             * @param {number} lon - Longitude
             * @returns {string} URL Meteoblue
             */
            function getMeteoblueUrl(resort) {
                if (resort.mbUrl) {
                    return `https://www.meteoblue.com/fr/meteo/semaine/${resort.mbUrl}`;
                }
                // Fallback : URL basée sur les coordonnées (moins fiable)
                const slug = resort.name
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/^-+|-+$/g, "");
                return `https://www.meteoblue.com/fr/meteo/semaine/${slug}?lat=${resort.lat}&lon=${resort.lon}&asl=${resort.altitude}`;
            }

            function AddResortModal({ isOpen, onClose, onAdd, isAtLimit }) {
                const [searchQuery, setSearchQuery] = useState("");
                const [searchResults, setSearchResults] = useState([]);
                const [isSearching, setIsSearching] = useState(false);

                const searchLocation = async (query) => {
                    if (query.length < 3) {
                        setSearchResults([]);
                        return;
                    }

                    setIsSearching(true);

                    try {
                        const url = `${PROXY_URL}/search?query=${encodeURIComponent(query)}`;
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.results) {
                            setSearchResults(data.results.slice(0, 10));
                        } else {
                            console.warn("⚠️ Pas de champ 'results' dans la réponse :", data);
                        }
                    } catch (err) {
                        console.error("❌ Erreur recherche:", err.message, err);
                        setSearchResults([]);
                    } finally {
                        setIsSearching(false);
                    }
                };

                useEffect(() => {
                    const timer = setTimeout(() => {
                        if (searchQuery) {
                            searchLocation(searchQuery);
                        }
                    }, 500);

                    return () => clearTimeout(timer);
                }, [searchQuery]);

                const handleSelect = (location) => {
                    // --- DÉBUT DE L'AJOUT GOOGLE ANALYTICS ---
                    if (typeof gtag === 'function') {
                        gtag('event', 'ajout_secteur', {
                            'nom_secteur': location.name,      // ex: Guzet
                            'region_secteur': location.admin1, // ex: Occitanie
                            'altitude_secteur': location.asl   // ex: 1400
                        });
                    }
                    // --- FIN DE L'AJOUT ---
                    
                    onAdd({
                        name: location.name,
                        lat: location.lat,
                        lon: location.lon,
                        altitude: location.asl || 1000,
                        mbUrl: location.url || null,
                    });
                    setSearchQuery("");
                    setSearchResults([]);
                    onClose();
                };

                if (!isOpen) return null;

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div
                            className="modal"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h2 className="title" style={{marginBottom:'16px'}}>Ajouter un Secteur</h2>

                            {isAtLimit ? (
                                <>
                                    <div className="modal-limit-alert">
                                        <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.alert}}></span>
                                        <p>Le nombre de secteur maximum est atteint. Veuillez retirer un secteur pour en ajouter un autre.</p>
                                    </div>
                                    <div className="modal-buttons">
                                        <a
                                            className="btn btn-primary"
                                            href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            style={{textDecoration:'none'}}
                                        >
                                            Proposer une amélioration
                                        </a>
                                        <button
                                            className="btn btn-secondary"
                                            onClick={onClose}
                                        >
                                            Annuler
                                        </button>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <p className="subtitle" style={{marginBottom:'20px'}}>Entrer le nom d'une station, d'un pic pour l'ajouter. Les données sont fournis par meteobleu.</p>

                                    <input
                                        type="text"
                                        className="input search-input"
                                        placeholder="Rechercher une commune (min. 3 caractères - ex: Guzet, Saint-Lary...)"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        autoFocus
                                    />

                                    <div className="search-results">
                                        {isSearching && (
                                            <div className="loading-search">
                                                <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.search}}></span> Recherche en cours...
                                            </div>
                                        )}

                                        {!isSearching &&
                                            searchResults.length === 0 &&
                                            searchQuery.length >= 3 && (
                                                <div className="no-results">
                                                    Aucun résultat trouvé. Essayez une
                                                    autre recherche.
                                                </div>
                                            )}

                                        {!isSearching &&
                                            searchQuery.length > 0 &&
                                            searchQuery.length < 3 && (
                                                <div className="no-results">
                                                    Tapez au moins 3 caractères pour
                                                    lancer la recherche.
                                                </div>
                                            )}

                                        {!isSearching &&
                                            searchResults.map((result, index) => (
                                                <div
                                                    key={index}
                                                    className="search-result-item"
                                                    onClick={() => handleSelect(result)}
                                                >
                                                    <div className="result-name">
                                                        {result.name}
                                                    </div>
                                                    <div className="result-info">
                                                        {result.country || ""}{" "}
                                                        {result.admin1
                                                            ? `• ${result.admin1}`
                                                            : ""}{" "}
                                                        {result.asl
                                                            ? `• Alt: ${result.asl}m`
                                                            : ""}
                                                    </div>
                                                </div>
                                            ))}
                                    </div>

                                    <div className="modal-buttons">
                                        <button
                                            className="btn btn-secondary"
                                            onClick={onClose}
                                        >
                                            Annuler
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            function MountainWeatherApp() {
                const [resorts, setResorts] = useState(() => {
                    const saved = localStorage.getItem("skiResorts");
                    return saved ? JSON.parse(saved) : DEFAULT_RESORTS;
                });
                const [weatherData, setWeatherData] = useState([]);
                const [snowData, setSnowData] = useState([]);
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState(null);
                const [currentDate, setCurrentDate] = useState("");
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [lastUpdate, setLastUpdate] = useState(null);
                const [braData, setBraData] = useState({});
                const [beraModal, setBeraModal] = useState(null);

                // --- Vue horaire (3h) ---
                // weatherView : 'day' = vue journalière (défaut), 'hour' = vue horaire 3h
                const [weatherView, setWeatherView] = useState('day');
                // hourlyData : tableau de { name, hours: [{ label, icon, desc, temp, windSpeed, windDir, windCardinal, precip, snowCm }] }
                const [hourlyData, setHourlyData] = useState([]);

                useEffect(() => {
                    const now = new Date();
                    setCurrentDate(
                        now.toLocaleDateString("fr-FR", {
                            weekday: "long",
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        }) +
                            " à " +
                            now.toLocaleTimeString("fr-FR", {
                                hour: "2-digit",
                                minute: "2-digit",
                            }),
                    );

                    // Charger la dernière mise à jour depuis localStorage
                    const savedUpdate =
                        localStorage.getItem("lastWeatherUpdate");
                    if (savedUpdate) {
                        setLastUpdate(savedUpdate);
                    }

                    // Charger les données au premier chargement (ignore les restrictions)
                    if (resorts.length > 0) {
                        loadInitialWeatherData();
                    }
                }, []);

                const loadInitialWeatherData = async () => {
                    // Vérifier le cache avant d'appeler l'API
                    const cache = getWeatherCache();
                    if (cache && isCacheValidForResorts(cache, resorts)) {
                        processWeatherData(cache.results);
                        processSnowData(cache.results);
                        processHourlyData(cache.results);
                        if (cache.braData) setBraData(cache.braData);

                        const cachedDate = new Date(cache.timestamp);
                        setLastUpdate(cachedDate.toISOString());
                        setCurrentDate(
                            cachedDate.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                cachedDate.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                        return;
                    }

                    setLoading(true);
                    setError(null);

                    try {
                        const promises = resorts.map((resort) =>
                            fetchWeatherForResort(resort),
                        );
                        const results = await Promise.all(promises);

                        processWeatherData(results);
                        processSnowData(results);
                        processHourlyData(results);

                        // Charger les données BRA pour tous les secteurs
                        const braPromises = resorts.map(async (resort) => {
                            const massif = getMassifFromCoords(
                                resort.lat,
                                resort.lon,
                                resort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                return data
                                    ? { name: resort.name, data }
                                    : null;
                            }
                            return null;
                        });

                        const braResults = await Promise.all(braPromises);
                        const braDataObj = {};
                        braResults.forEach((result) => {
                            if (result) {
                                braDataObj[result.name] = result.data;
                            }
                        });
                        setBraData(braDataObj);

                        // Sauvegarder dans le cache
                        setWeatherCache(resorts, results, braDataObj);

                        // Enregistrer l'heure de mise à jour
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        localStorage.setItem(
                            "lastWeatherUpdate",
                            now.toISOString(),
                        );

                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                    } catch (err) {
                        setError(
                            `Erreur lors de la récupération des données: ${err.message}`,
                        );
                    } finally {
                        setLoading(false);
                    }
                };

                useEffect(() => {
                    localStorage.setItem("skiResorts", JSON.stringify(resorts));
                }, [resorts]);

                const addResort = async (newResort) => {
                    if (resorts.length >= MAX_RESORTS) return;
                    // Ajouter le secteur à la liste
                    const updatedResorts = [...resorts, newResort];
                    setResorts(updatedResorts);

                    // Charger uniquement les données pour ce nouveau secteur (sans loading général)
                    try {
                        const result = await fetchWeatherForResort(newResort);

                        // Ajouter les données météo du nouveau secteur
                        if (result.data) {
                            const newWeatherData =
                                processWeatherDataForResort(result);
                            const newSnowData =
                                processSnowDataForResort(result);
                            const newHourlyData =
                                processHourlyDataForResort(result);

                            if (newWeatherData) {
                                setWeatherData((prev) => [
                                    ...prev,
                                    newWeatherData,
                                ]);
                            }
                            if (newSnowData) {
                                setSnowData((prev) => [...prev, newSnowData]);
                            }
                            if (newHourlyData) {
                                setHourlyData((prev) => [...prev, newHourlyData]);
                            }

                            // Récupérer les données BRA pour ce secteur
                            const massif = getMassifFromCoords(
                                newResort.lat,
                                newResort.lon,
                                newResort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                if (data) {
                                    setBraData((prev) => ({
                                        ...prev,
                                        [newResort.name]: data,
                                    }));
                                }
                            }
                        }
                        // Invalider le cache (la liste de stations a changé)
                        localStorage.removeItem(CACHE_KEY);
                    } catch (err) {
                        console.error(
                            "Erreur lors de l'ajout du secteur:",
                            err,
                        );
                    }
                };

                const removeResort = (index) => {
                    // Retirer le secteur et ses données
                    const newResorts = resorts.filter((_, i) => i !== index);
                    setResorts(newResorts);
                    setWeatherData((prev) =>
                        prev.filter((_, i) => i !== index),
                    );
                    setSnowData((prev) => prev.filter((_, i) => i !== index));
                    setHourlyData((prev) => prev.filter((_, i) => i !== index));
                    // Invalider le cache (la liste de stations a changé)
                    localStorage.removeItem(CACHE_KEY);
                };

                const fetchWeatherForResort = async (resort) => {
                    const url = `${PROXY_URL}/weather?lat=${resort.lat}&lon=${resort.lon}&asl=${resort.altitude}`;
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        const data = await response.json();
                        return { ...resort, data };
                    } catch (err) {
                        console.error(`Erreur météo pour ${resort.name}:`, err);
                        return { ...resort, data: null, error: err.message };
                    }
                };

                const fetchAllWeatherData = async () => {
                    setLoading(true);
                    setError(null);

                    try {
                        const promises = resorts.map((resort) =>
                            fetchWeatherForResort(resort),
                        );
                        const results = await Promise.all(promises);

                        processWeatherData(results);
                        processSnowData(results);
                        processHourlyData(results);

                        // Recharger les BRA aussi
                        const braPromises = resorts.map(async (resort) => {
                            const massif = getMassifFromCoords(
                                resort.lat,
                                resort.lon,
                                resort.name,
                            );
                            if (massif) {
                                const data = await fetchBRAData(massif.id);
                                return data
                                    ? { name: resort.name, data }
                                    : null;
                            }
                            return null;
                        });
                        const braResults = await Promise.all(braPromises);
                        const braDataObj = {};
                        braResults.forEach((result) => {
                            if (result) braDataObj[result.name] = result.data;
                        });
                        setBraData(braDataObj);

                        // Sauvegarder dans le cache
                        setWeatherCache(resorts, results, braDataObj);

                        // Enregistrer l'heure de mise à jour
                        const now = new Date();
                        setLastUpdate(now.toISOString());
                        localStorage.setItem(
                            "lastWeatherUpdate",
                            now.toISOString(),
                        );

                        setCurrentDate(
                            now.toLocaleDateString("fr-FR", {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            }) +
                                " à " +
                                now.toLocaleTimeString("fr-FR", {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }),
                        );
                    } catch (err) {
                        setError(
                            `Erreur lors de la récupération des données: ${err.message}`,
                        );
                    } finally {
                        setLoading(false);
                    }
                };

                const getDayLabel = (offset) => {
                    const date = new Date();
                    date.setDate(date.getDate() + offset);

                    if (offset === 0) return "Aujourd'hui";
                    if (offset === 1) return "Demain";

                    // Pour J+2 et plus : afficher le jour de la semaine + date
                    const dayName = date.toLocaleDateString("fr-FR", {
                        weekday: "long",
                    });
                    const dateStr = date.toLocaleDateString("fr-FR", {
                        day: "2-digit",
                        month: "2-digit",
                    });
                    return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${dateStr}`;
                };

                const processWeatherDataForResort = (resort) => {
                    if (!resort.data || !resort.data.data_day) return null;

                    const dayData = resort.data.data_day;
                    const days = {};
                    const todayStr = getTodayStr();

                    let todayIndex = dayData.time.findIndex(d => d === todayStr);
                    if (todayIndex === -1) todayIndex = 0;

                    // On récupère 5 jours : aujourd'hui + 4 jours futurs
                    for (let offset = 0; offset <= 4; offset++) {
                        const dataIndex = todayIndex + offset;
                        if (dataIndex >= 0 && dataIndex < dayData.time.length) {
                            const weatherCode = dayData.pictocode?.[dataIndex] || 1;
                            const weatherInfo = getWeatherInfo(weatherCode);

                            // snowaccumulation (snowice-day) est en cm de neige fraîche
                            const snowCm = Math.round(dayData.snowaccumulation?.[dataIndex] || 0);
                            const precip = dayData.precipitation?.[dataIndex] || 0;
                            const snowFraction = dayData.snowfraction?.[dataIndex] || 0;
                            const rainMm = Math.round((1 - snowFraction) * precip);

                            days[offset] = {
                                offset,
                                date: dayData.time?.[dataIndex] || "",
                                condition: weatherInfo.desc,
                                icon: weatherInfo.icon,
                                temp_max: dayData.temperature_max?.[dataIndex] || 0,
                                temp_min: dayData.temperature_min?.[dataIndex] || 0,
                                wind_mean: dayData.windspeed_mean?.[dataIndex] || 0,
                                gust_min: dayData.gust_min?.[dataIndex] || 0,
                                gust_max: dayData.gust_max?.[dataIndex] || 0,
                                windDirection: dayData.winddirection?.[dataIndex] || null,
                                precipitation: precip,
                                snowCm,
                                rainMm,
                            };
                        }
                    }

                    return { name: resort.name, days };
                };

                const processSnowDataForResort = (resort) => {
                    if (!resort.data || !resort.data.data_day) return null;

                    const dayData = resort.data.data_day;
                    const snowByDay = [];
                    const todayStr = getTodayStr();

                    let todayIndex = dayData.time.findIndex(d => d === todayStr);
                    if (todayIndex === -1) todayIndex = 0;

                    // 7 jours : J-2 à J+4
                    for (let offset = -2; offset <= 4; offset++) {
                        const dataIndex = todayIndex + offset;
                        if (dataIndex >= 0 && dataIndex < dayData.time.length) {
                            // snowaccumulation (snowice-day) est en cm de neige fraîche
                            snowByDay.push(Math.round(dayData.snowaccumulation?.[dataIndex] || 0));
                        } else {
                            snowByDay.push(0);
                        }
                    }

                    return { name: resort.name, snowByDay };
                };

                const processWeatherData = (results) => {
                    const processed = results
                        .map((resort) => processWeatherDataForResort(resort))
                        .filter(Boolean);
                    setWeatherData(processed);
                };

                const processSnowData = (results) => {
                    const processed = results
                        .map((resort) => processSnowDataForResort(resort))
                        .filter(Boolean);
                    setSnowData(processed);
                };

                /**
                 * Traite les données horaires (3h) pour UN secteur.
                 * Extrait les créneaux de AUJOURD'HUI depuis data_3h.
                 *
                 * Champs utilisés (package basic-3h Meteoblue) :
                 *   - data_3h.time            → "YYYY-MM-DD HH:MM"
                 *   - data_3h.pictocode       → code météo (1-35)
                 *   - data_3h.temperature      → °C
                 *   - data_3h.windspeed        → km/h
                 *   - data_3h.winddirection    → degrés (0-360)
                 *   - data_3h.precipitation    → mm total
                 *   - data_3h.snowfraction     → fraction neige (0-1)
                 *
                 * @param {Object} resort - Données brutes { name, data: { data_3h: {...} } }
                 * @returns {Object|null} { name, hours: [...] } ou null si pas de data_3h
                 */
                const processHourlyDataForResort = (resort) => {
                    // ─── LOGS DE DÉBOGAGE ────────────────────────────────────────
                    // Permet de vérifier si data_3h arrive bien dans la réponse API.
                    // À lire dans la console du navigateur (F12 → Console).
                    if (!resort.data) {
                        console.warn(`[Hourly] ❌ ${resort.name} : aucune data`);
                        return null;
                    }

                    // Log 1 — clés présentes dans la réponse (data_day, data_3h, etc.)
                    const apiKeys = Object.keys(resort.data).sort().join(', ');
                    console.log(`[Hourly] ${resort.name} → clés API reçues : ${apiKeys}`);

                    if (!resort.data.data_3h) {
                        // Cause la plus probable : le worker Cloudflare n'est pas encore
                        // redéployé avec le package basic-3h, OU le cache Cloudflare sert
                        // l'ancienne réponse (sans data_3h). Vérifier le déploiement.
                        console.warn(`[Hourly] ❌ ${resort.name} : data_3h ABSENT → worker non redéployé ou vieux cache CF (v=2)`);
                        return null;
                    }

                    const d3h = resort.data.data_3h;
                    const totalSlots = d3h.time?.length ?? 0;

                    // Log 2 — nombre de créneaux et plage de dates
                    console.log(`[Hourly] ✅ ${resort.name} : ${totalSlots} créneaux 3h`);
                    if (totalSlots > 0) {
                        console.log(`[Hourly]   plage : ${d3h.time[0]}  →  ${d3h.time[totalSlots - 1]}`);
                    }

                    // ─── REGROUPEMENT PAR JOUR (max 5 jours) ────────────────────
                    // On groupe tous les créneaux 3h par date (YYYY-MM-DD).
                    // On s'arrête à 5 jours pour garder le tableau lisible.
                    const dayMap = new Map(); // date → slots[]

                    for (let i = 0; i < d3h.time.length; i++) {
                        const timeStr = d3h.time[i]; // format Meteoblue : "YYYY-MM-DD HH:MM"
                        const dateStr = timeStr.substring(0, 10);

                        if (!dayMap.has(dateStr)) {
                            if (dayMap.size >= 5) continue; // ← limite à 5 jours
                            dayMap.set(dateStr, []);
                        }

                        const hour = parseInt(timeStr.substring(11, 13), 10);
                        const weatherInfo = getWeatherInfo(d3h.pictocode?.[i] || 1, hour);
                        const windDisplay = getWindDirectionDisplay(d3h.winddirection?.[i]);

                        const totalPrecip = d3h.precipitation?.[i] || 0;
                        const snowFraction = d3h.snowfraction?.[i] || 0;
                        const snowMm  = Math.round(totalPrecip * snowFraction * 10) / 10;
                        const rainMm  = Math.round(totalPrecip * (1 - snowFraction) * 10) / 10;

                        dayMap.get(dateStr).push({
                            label: `${hour.toString().padStart(2, '0')}h`,
                            hour,
                            icon:        weatherInfo.icon,
                            desc:        weatherInfo.desc,
                            temp:        Math.round(d3h.temperature?.[i] || 0),
                            windSpeed:   Math.round(d3h.windspeed?.[i]   || 0),
                            windDir:     d3h.winddirection?.[i] ?? null,
                            windCardinal: windDisplay.cardinal,
                            precip:      Math.round(totalPrecip * 10) / 10,
                            snowMm,
                            rainMm,
                        });
                    }

                    // Construire le tableau de jours avec labels français
                    const days = [];
                    for (const [date, hours] of dayMap.entries()) {
                        // Instancier à midi local pour éviter les glissements de timezone
                        const dt = new Date(`${date}T12:00:00`);
                        const dayLabel = dt.toLocaleDateString('fr-FR', {
                            weekday: 'short', day: 'numeric', month: 'short',
                        });
                        const dayLabelLong = dt.toLocaleDateString('fr-FR', {
                            weekday: 'long', day: 'numeric', month: 'long',
                        });
                        days.push({ date, dayLabel, dayLabelLong, hours });
                    }

                    // Log 3 — récapitulatif par jour
                    console.log(
                        `[Hourly] ${resort.name} → ${days.length} jours :`,
                        days.map(d => `${d.date}(${d.hours.length} créneaux)`).join(', ')
                    );

                    return days.length > 0 ? { name: resort.name, days } : null;
                };

                /** Traite les données horaires pour TOUS les secteurs */
                const processHourlyData = (results) => {
                    const processed = results
                        .map((resort) => processHourlyDataForResort(resort))
                        .filter(Boolean);
                    setHourlyData(processed);
                };

                if (loading) {
                    return (
                        <div className="container">
                            <header>
                                <h1>
                                    <span className="logo" dangerouslySetInnerHTML={{__html: logoSvg}}></span>
                                </h1>
                            </header>
                            <div className="main-content">
                                <div className="loading">
                                    <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.refresh}}></span>{" "}
                                    Chargement des données météo depuis
                                    Meteoblue...
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="container">
                        <header>
                            <h1>
                                <span className="logo" dangerouslySetInnerHTML={{__html: logoSvg}}></span>
                            </h1>
                            <div className="header-controls">
                                <a
                                    className="btn btn-primary"
                                    href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{textDecoration: "none"}}
                                >
                                    Proposer une amélioration
                                </a>
                            </div>
                        </header>

                        <div className="main-content">
                            {error && <div className="error"><span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.alert}}></span> {error}</div>}

                            <div className="sectors-block">
                                <p className="title-xl" style={{textAlign:"center",margin:0}}>Ajoute tes stations préférées pour voir d'un coup d'œil où sont les meilleures conditions de ski.</p>
                                {resorts.length > 0 && (
                                    <div className="resort-list">
                                        {resorts.map((resort, index) => (
                                            <div key={index} className="tag">
                                                {resort.name}
                                                <button
                                                    className="remove-resort"
                                                    onClick={() => removeResort(index)}
                                                    title="Retirer ce secteur"
                                                >×</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <button
                                    className="btn btn-primary"
                                    onClick={() => setIsModalOpen(true)}
                                >
                                    <span className="icon" dangerouslySetInnerHTML={{__html: uiSvg.plus}}></span> Ajouter un Secteur
                                </button>
                            </div>

                            <>
                                    <section className="section">
                                            <div className="comparison-card">
                                                <div className="comparison-card-header">
                                                    <div>
                                                        <h2 className="title" style={{margin:0}}>Chutes de Neige (7 jours)</h2>
                                                        <p className="subtitle" style={{margin:0}}>Les données viennent de <a href="https://www.meteoblue.com" target="_blank" rel="noopener noreferrer" style={{color:'inherit',textDecoration:'underline'}}>Meteobleu</a></p>
                                                    </div>
                                                </div>
                                                <div className="comparison-card-body">
                                            <div className="snow-table">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>Secteur</th>
                                                            {[
                                                                -2, -1, 0, 1, 2, 3,
                                                                4,
                                                            ].map((offset) => {
                                                                const date = new Date();
                                                                date.setDate(date.getDate() + offset);
                                                                const dayAbbr = date.toLocaleDateString("fr-FR", { weekday: "short" });
                                                                const dayNum = date.getDate();
                                                                return (
                                                                    <th key={offset}>
                                                                        <span className="day-abbr">{dayAbbr.charAt(0).toUpperCase() + dayAbbr.slice(1)}</span>
                                                                        <span className="day-num">{dayNum}</span>
                                                                    </th>
                                                                );
                                                            })}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {snowData.length > 0 ? snowData.map(
                                                            (resort, index) => {
                                                                const resortInfo = resorts[index];
                                                                const meteoblueUrl = resortInfo ? getMeteoblueUrl(resortInfo) : "#";
                                                                return (
                                                                    <tr key={index}>
                                                                        <td>
                                                                            <a href={meteoblueUrl} target="_blank" rel="noopener noreferrer" className="resort-link">
                                                                                <span className="sector-name">{resort.name}</span>
                                                                            </a>
                                                                            <span className="sector-altitude"> ({resortInfo?.altitude}m)</span>
                                                                        </td>
                                                                        {resort.snowByDay.map(
                                                                            (snow, dayIndex) => (
                                                                                <td key={dayIndex}>
                                                                                    <span className="snow-value">{snow}</span>
                                                                                    {" "}<span className="snow-unit">cm</span>
                                                                                </td>
                                                                            ),
                                                                        )}
                                                                    </tr>
                                                                );
                                                            },
                                                        ) : (
                                                            <tr>
                                                                <td className="table-blank-state" colSpan={8}>Aucun secteur à afficher</td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                                </div>
                                            </div>
                                        </section>

                                    <section className="section">
                                            <div className="comparison-card">
                                                <div className="comparison-card-header">
                                                    <div>
                                                        <h2 className="title" style={{margin:0}}>
                                                            {weatherView === 'day' ? 'Prévisions météo 5 jours' : "Prévisions météo aujourd'hui (3h)"}
                                                        </h2>
                                                        <p className="subtitle" style={{margin:0}}>Les données viennent de <a href="https://www.meteoblue.com" target="_blank" rel="noopener noreferrer" style={{color:'inherit',textDecoration:'underline'}}>Meteobleu</a> et France Météo. Contrairement aux chutes de neige, il n'est pas possible d'afficher la météo des jours précédents.</p>
                                                    </div>
                                                    {/* Toggle Par jour / Par heure — utilise .toggle / .toggle-btn du design-system */}
                                                    <div className="toggle">
                                                        <button
                                                            className={`toggle-btn${weatherView === 'day' ? ' active' : ''}`}
                                                            onClick={() => setWeatherView('day')}
                                                        >
                                                            Par jour
                                                        </button>
                                                        <button
                                                            className={`toggle-btn${weatherView === 'hour' ? ' active' : ''}`}
                                                            onClick={() => setWeatherView('hour')}
                                                        >
                                                            Par heure
                                                        </button>
                                                    </div>
                                                </div>
                                                {/* ============================================================
                                                  * CONTENU CONDITIONNEL : vue jour OU vue horaire
                                                  * ============================================================ */}
                                                <div className={`comparison-card-body${weatherView === 'hour' ? ' hourly-view' : ''}`}>
                                            {/* ==================== VUE PAR JOUR ==================== */}
                                            {weatherView === 'day' && (
                                            <div className="snow-table">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>
                                                                Secteur
                                                            </th>
                                                            {[0, 1, 2, 3, 4].map((offset) => {
                                                                const date = new Date();
                                                                date.setDate(date.getDate() + offset);
                                                                const dayAbbr = date.toLocaleDateString("fr-FR", { weekday: "short" });
                                                                const dayNum = date.getDate();
                                                                return (
                                                                    <th key={offset}>
                                                                        <span className="day-abbr">{dayAbbr.charAt(0).toUpperCase() + dayAbbr.slice(1)}</span>
                                                                        <span className="day-num">{dayNum}</span>
                                                                    </th>
                                                                );
                                                            })}
                                                        </tr>

                                                    </thead>
                                                    <tbody>
                                                        {weatherData.length > 0 ? weatherData.map(
                                                            (
                                                                resort,
                                                                resortIndex,
                                                            ) => {
                                                                const resortInfo =
                                                                    resorts.find(
                                                                        (r) =>
                                                                            r.name ===
                                                                            resort.name,
                                                                    );
                                                                const meteoblueUrl =
                                                                    resortInfo
                                                                        ? getMeteoblueUrl(
                                                                              resortInfo,
                                                                          )
                                                                        : "#";
                                                                return (
                                                                    <tr
                                                                        key={
                                                                            resortIndex
                                                                        }
                                                                    >
                                                                        <td>
                                                                            <a href={meteoblueUrl} target="_blank" rel="noopener noreferrer" className="resort-link">
                                                                                <span className="sector-name">{resort.name}</span>
                                                                            </a>
                                                                            <span className="sector-altitude"> ({resortInfo?.altitude || "?"}m)</span>
                                                                        </td>

                                                                        {[0, 1, 2, 3, 4].map(
                                                                                  (
                                                                                      offset,
                                                                                  ) => {
                                                                                      const dayWeather =
                                                                                          resort
                                                                                              .days[
                                                                                              offset
                                                                                          ];
                                                                                      if (
                                                                                          !dayWeather
                                                                                      )
                                                                                          return (
                                                                                              <td
                                                                                                  key={
                                                                                                      offset
                                                                                                  }
                                                                                              >
                                                                                                  -
                                                                                              </td>
                                                                                          );

                                                                                      const avgTemp =
                                                                                          Math.round(
                                                                                              (dayWeather.temp_max +
                                                                                                  dayWeather.temp_min) /
                                                                                                  2,
                                                                                          );
                                                                                      const braDataForResort =
                                                                                          braData[
                                                                                              resort
                                                                                                  .name
                                                                                          ];

                                                                                      // Déterminer quelle échéance BRA afficher selon l'offset
                                                                                      let braEcheance =
                                                                                          null;
                                                                                      if (
                                                                                          offset ===
                                                                                              0 &&
                                                                                          braDataForResort?.[
                                                                                              "aujourd'hui"
                                                                                          ]
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort[
                                                                                                  "aujourd'hui"
                                                                                              ];
                                                                                      } else if (
                                                                                          offset ===
                                                                                              1 &&
                                                                                          braDataForResort?.demain
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort.demain;
                                                                                      } else if (
                                                                                          offset ===
                                                                                              2 &&
                                                                                          braDataForResort?.apresdemain
                                                                                      ) {
                                                                                          braEcheance =
                                                                                              braDataForResort.apresdemain;
                                                                                      }

                                                                                      // Vent moyen + direction
                                                                                      const windMean =
                                                                                          Math.round(
                                                                                              dayWeather.wind_mean,
                                                                                          );
                                                                                      const gustMin =
                                                                                          Math.round(
                                                                                              dayWeather.gust_min,
                                                                                          );
                                                                                      const gustMax =
                                                                                          Math.round(
                                                                                              dayWeather.gust_max,
                                                                                          );
                                                                                      const windDir =
                                                                                          dayWeather.windDirection !==
                                                                                          null
                                                                                              ? getWindDirectionDisplay(
                                                                                                    dayWeather.windDirection,
                                                                                                )
                                                                                              : null;

                                                                                      // Couleur rafales (sur le max)
                                                                                      const gustColor =
                                                                                          getWindColor(
                                                                                              gustMax,
                                                                                          );

                                                                                      return (
                                                                                          <td
                                                                                              key={
                                                                                                  offset
                                                                                              }
                                                                                              className="day-cell"
                                                                                          >
                                                                                              <div className="day-cell-inner">
                                                                                                  {/* Colonne gauche : icône + label */}
                                                                                                  <div className="day-cell-icon" title={dayWeather.condition}>
                                                                                                      <span dangerouslySetInnerHTML={{__html: dayWeather.icon}}></span>
                                                                                                      <div className="day-cell-condition">{dayWeather.condition}</div>
                                                                                                  </div>
                                                                                                  {/* Colonne droite : données */}
                                                                                                  <div className="day-cell-info">
                                                                                                      {/* -4° (−7° / −3°) sur la même ligne, mixed styles */}
                                                                                                      <div className="cell-temp-line">
                                                                                                          <span className="cell-temp-main">{avgTemp}°</span>
                                                                                                          <span className="cell-temp-range">({Math.round(dayWeather.temp_min)}° / {Math.round(dayWeather.temp_max)}°)</span>
                                                                                                      </div>
                                                                                                      {/* ↓ Vent 12 km/h */}
                                                                                                      <div className="info-row">
                                                                                                          {windDir && (
                                                                                                              <span dangerouslySetInnerHTML={{__html: windArrowSvg(dayWeather.windDirection, 16)}}></span>
                                                                                                          )}
                                                                                                          <span>Vent moy. {windMean} km/h</span>
                                                                                                      </div>
                                                                                                      {/* Raf. 15-25 km/h */}
                                                                                                      <div className="info-row">
                                                                                                          <span>Raf. {gustMin}-{gustMax} km/h</span>
                                                                                                      </div>
                                                                                                      {/* Précipitations — masque si ≤ 0 */}
                                                                                                      {dayWeather.snowCm > 0 && (
                                                                                                          <div className="info-row" style={{color:"#3498db",fontWeight:600}}>
                                                                                                              <span dangerouslySetInnerHTML={{__html: uiSvg.snowflake}}></span>
                                                                                                              {dayWeather.snowCm} cm
                                                                                                          </div>
                                                                                                      )}
                                                                                                      {dayWeather.rainMm > 0 && dayWeather.snowCm <= 0 && (
                                                                                                          <div className="info-row" style={{color:"#2980b9"}}>
                                                                                                              <span dangerouslySetInnerHTML={{__html: uiSvg.droplet}}></span>
                                                                                                              {dayWeather.rainMm} mm
                                                                                                          </div>
                                                                                                      )}
                                                                                                      {/* Badge BERA */}
                                                                                                      {braEcheance && braEcheance.haut > 0 && (
                                                                                                          <div className="bera-badge" style={{backgroundColor: getBRAColor(braEcheance.haut)}}>
                                                                                                              BERA {braEcheance.haut}/5
                                                                                                          </div>
                                                                                                      )}
                                                                                                      {/* Lien "Voir le BERA" */}
                                                                                                      {braDataForResort?._detail && (offset === 0 || offset === 1) && (
                                                                                                          <a className="bera-link" href="#" onClick={(e) => {
                                                                                                              e.preventDefault();
                                                                                                              const detail = braDataForResort._detail;
                                                                                                              setBeraModal({ resortName: resort.name, detail, loading: true });
                                                                                                              fetch(
                                                                                                                  `https://public-api.meteofrance.fr/public/DPBRA/v1/massif/BRA?id-massif=${detail.massifId}&format=pdf`,
                                                                                                                  { headers: { apikey: MF_API_KEY } }
                                                                                                              )
                                                                                                                  .then(r => r.blob())
                                                                                                                  .then(blob => {
                                                                                                                      const url = URL.createObjectURL(blob);
                                                                                                                      setBeraModal(prev => prev ? { ...prev, pdfUrl: url, loading: false } : null);
                                                                                                                  })
                                                                                                                  .catch(() => {
                                                                                                                      setBeraModal(prev => prev ? { ...prev, loading: false, pdfError: true } : null);
                                                                                                                  });
                                                                                                          }}>
                                                                                                              Voir le BERA
                                                                                                          </a>
                                                                                                      )}
                                                                                                  </div>
                                                                                              </div>
                                                                                          </td>
                                                                                      );
                                                                                  },
                                                                              )}
                                                                    </tr>
                                                                );
                                                            },
                                                        ) : (
                                                            <tr>
                                                                <td className="table-blank-state" colSpan={6}>Aucun secteur à afficher</td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                            )}

                                            {/* ==================== VUE PAR HEURE (3h) ====================
                                              * Tableau comparatif : 1 ligne par secteur, 5 jours × 8 créneaux.
                                              *
                                              * Règles clés :
                                              *  • On itère sur `resorts` (source de vérité) → secteur toujours visible.
                                              *  • hourlyData[i].days[] contient les créneaux groupés par jour (max 5).
                                              *  • En-tête double ligne : Secteur (rowSpan=2) | jour1 | jour2 | ...
                                              *                                                  | 00h 03h ... | 00h 03h ...
                                              *  • .hourly-day-sep marque la dernière colonne de chaque jour.
                                              *  • Inline styles sur les <th> bypasse la spécificité design-system.
                                              *  • Les logs [Hourly] dans la console permettent de diagnostiquer
                                              *    si data_3h arrive bien de l'API (worker redéployé ?).
                                              * ============================================================ */}
                                            {weatherView === 'hour' && (() => {
                                                /* Jours de référence : vient du 1er secteur chargé.
                                                 * Fallback : 5 jours fictifs si data_3h pas encore disponible. */
                                                const refDays = hourlyData[0]?.days || Array.from({length: 5}, (_, i) => {
                                                    const dt = new Date();
                                                    dt.setDate(dt.getDate() + i);
                                                    const dayLabelLong = dt.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
                                                    return {
                                                        date: dt.toLocaleDateString('en-CA'),
                                                        dayLabel: dt.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'short'}),
                                                        dayLabelLong,
                                                        hours: Array.from({length:8}, (_, j) => ({label:`${(j*3).toString().padStart(2,'0')}h`})),
                                                    };
                                                });
                                                const totalCols = refDays.reduce((sum, d) => sum + d.hours.length, 0);

                                                /* Styles inline pour la colonne Secteur
                                                 * (bypass spécificité design-system snow-table thead th:first-child) */
                                                const sectorThStyle = {
                                                    textAlign: 'left', paddingLeft: '24px', minWidth: '200px',
                                                    background: '#F9FAFC', fontFamily: '"Garnett", sans-serif',
                                                    fontSize: '16px', fontWeight: 600, color: '#1F2023',
                                                    position: 'sticky', left: 0, zIndex: 3, verticalAlign: 'middle',
                                                };
                                                const dayThStyle = {
                                                    textAlign: 'center', fontSize: '13px', fontWeight: 600,
                                                    color: '#5E7690', background: '#F9FAFC',
                                                    padding: '10px 16px 4px', fontFamily: '"Inter", sans-serif',
                                                };
                                                const hourThStyle = {
                                                    textAlign: 'center', minWidth: '80px', fontSize: '13px',
                                                    fontWeight: 600, color: '#1F2023', padding: '4px 8px 10px',
                                                    background: '#F9FAFC', fontFamily: '"Inter", sans-serif',
                                                };

                                                return (
                                                <div className="snow-table">
                                                    <table>
                                                        <thead>
                                                            {/* Ligne 1 : "Secteur" (rowSpan=2) + 1 th par jour */}
                                                            <tr>
                                                                <th rowSpan={2} style={sectorThStyle}>Secteur</th>
                                                                {refDays.map((day, dIdx) => {
                                                                    const sep = dIdx < refDays.length - 1;
                                                                    const cap = day.dayLabelLong.charAt(0).toUpperCase() + day.dayLabelLong.slice(1);
                                                                    return (
                                                                        <th key={dIdx} colSpan={day.hours.length}
                                                                            className={sep ? 'hourly-day-sep' : ''}
                                                                            style={dayThStyle}>
                                                                            {cap}
                                                                        </th>
                                                                    );
                                                                })}
                                                            </tr>
                                                            {/* Ligne 2 : créneaux 3h (00h → 21h) pour chaque jour */}
                                                            <tr>
                                                                {refDays.flatMap((day, dIdx) =>
                                                                    day.hours.map((slot, hIdx) => {
                                                                        const sep = hIdx === day.hours.length - 1 && dIdx < refDays.length - 1;
                                                                        return (
                                                                            <th key={`${dIdx}-${hIdx}`}
                                                                                className={sep ? 'hourly-day-sep' : ''}
                                                                                style={hourThStyle}>
                                                                                {slot.label}
                                                                            </th>
                                                                        );
                                                                    })
                                                                )}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {/* Source de vérité : `resorts` → le secteur s'affiche même
                                                              * si data_3h n'est pas encore chargé (voir logs F12) */}
                                                            {resorts.length > 0 ? resorts.map((resort, idx) => {
                                                                /* Lookup par index (alignement garanti après load initial)
                                                                 * puis par nom en fallback (addResort / removeResort) */
                                                                const hourlyResort =
                                                                    hourlyData[idx]?.name === resort.name
                                                                        ? hourlyData[idx]
                                                                        : hourlyData.find(h => h.name === resort.name);
                                                                const meteoblueUrl = getMeteoblueUrl(resort);
                                                                return (
                                                                    <tr key={idx}>
                                                                        {/* Colonne secteur — toujours rendu depuis `resorts` */}
                                                                        <td>
                                                                            <a href={meteoblueUrl} target="_blank" rel="noopener noreferrer" className="resort-link">
                                                                                <span className="sector-name">{resort.name}</span>
                                                                            </a>
                                                                            <span className="sector-altitude"> ({resort.altitude}m)</span>
                                                                        </td>
                                                                        {/* Données 3h : 1 td par créneau, .hourly-day-sep en fin de journée */}
                                                                        {hourlyResort ? hourlyResort.days.flatMap((day, dIdx) =>
                                                                            day.hours.map((h, hIdx) => {
                                                                                const sep = hIdx === day.hours.length - 1 && dIdx < hourlyResort.days.length - 1;
                                                                                return (
                                                                                    <td key={`${dIdx}-${hIdx}`}
                                                                                        className={`hourly-cell${sep ? ' hourly-day-sep' : ''}`}
                                                                                        title={h.desc}>
                                                                                        {/* Icône météo (pictocode adapté jour/nuit) */}
                                                                                        <div className="cell-icon">
                                                                                            <span dangerouslySetInnerHTML={{__html: h.icon}}></span>
                                                                                        </div>
                                                                                        {/* Température */}
                                                                                        <div className="cell-temp">{h.temp}°</div>
                                                                                        {/* Vent : flèche direction + vitesse km/h */}
                                                                                        <div className="cell-wind" style={{color: getWindColor(h.windSpeed)}}>
                                                                                            {h.windDir !== null && (
                                                                                                <span className="wind-arrow" dangerouslySetInnerHTML={{__html: windArrowSvg(h.windDir, 14)}}></span>
                                                                                            )}
                                                                                            <span>{h.windSpeed}</span>
                                                                                        </div>
                                                                                        {/* Précipitations — neige ou pluie, tiret si 0 */}
                                                                                        {h.precip > 0 ? (
                                                                                            <div className={`cell-precip${h.snowMm > 0 ? ' has-snow' : ' has-rain'}`}>
                                                                                                {h.snowMm > 0 ? `${h.snowMm}mm` : `${h.rainMm}mm`}
                                                                                            </div>
                                                                                        ) : (
                                                                                            <div className="cell-precip" style={{color:'#ccc'}}>-</div>
                                                                                        )}
                                                                                    </td>
                                                                                );
                                                                            })
                                                                        ) : (
                                                                            /* data_3h absent — voir logs [Hourly] dans la console F12 */
                                                                            <td colSpan={totalCols} style={{textAlign:'center', color:'#aaa', fontSize:'12px', padding:'16px'}}>
                                                                                Données horaires non disponibles — voir console (F12) pour diagnostic
                                                                            </td>
                                                                        )}
                                                                    </tr>
                                                                );
                                                            }) : (
                                                                <tr>
                                                                    <td className="table-blank-state" colSpan={totalCols + 1}>Aucun secteur à afficher</td>
                                                                </tr>
                                                            )}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                );
                                            })()}
                                                </div>
                                            </div>
                                        </section>
                                    </>
                        </div>

                        <AddResortModal
                            isOpen={isModalOpen}
                            onClose={() => setIsModalOpen(false)}
                            onAdd={addResort}
                            isAtLimit={resorts.length >= MAX_RESORTS}
                        />

                        {/* Modale BERA — PDF embed */}
                        {beraModal && (
                            <div
                                style={{
                                    position: "fixed",
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    backgroundColor: "rgba(0,0,0,0.6)",
                                    zIndex: 9999,
                                    display: "flex",
                                    alignItems: "center",
                                    justifyContent: "center",
                                    padding: "16px",
                                }}
                                onClick={() => {
                                    if (beraModal.pdfUrl)
                                        URL.revokeObjectURL(beraModal.pdfUrl);
                                    setBeraModal(null);
                                }}
                            >
                                <div
                                    style={{
                                        background: "white",
                                        borderRadius: "12px",
                                        width: "100%",
                                        maxWidth: "900px",
                                        height: "90vh",
                                        display: "flex",
                                        flexDirection: "column",
                                        position: "relative",
                                        boxShadow:
                                            "0 20px 60px rgba(0,0,0,0.3)",
                                        overflow: "hidden",
                                    }}
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    {/* Header */}
                                    <div
                                        style={{
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "space-between",
                                            padding: "16px 20px",
                                            borderBottom: "1px solid #e0e0e0",
                                            flexShrink: 0,
                                        }}
                                    >
                                        <div>
                                            <h2
                                                style={{
                                                    margin: 0,
                                                    fontSize: "1.1rem",
                                                    color: "var(--deep-blue)",
                                                }}
                                            >
                                                BERA —{" "}
                                                {beraModal.detail.massifName}
                                            </h2>
                                            <div
                                                style={{
                                                    fontSize: "0.75rem",
                                                    color: "#666",
                                                    marginTop: "2px",
                                                }}
                                            >
                                                {beraModal.resortName} —
                                                Bulletin du{" "}
                                                {new Date(
                                                    beraModal.detail
                                                        .dateBulletin,
                                                ).toLocaleDateString("fr-FR", {
                                                    weekday: "long",
                                                    day: "numeric",
                                                    month: "long",
                                                    year: "numeric",
                                                })}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (beraModal.pdfUrl)
                                                    URL.revokeObjectURL(
                                                        beraModal.pdfUrl,
                                                    );
                                                setBeraModal(null);
                                            }}
                                            style={{
                                                background: "#e0e0e0",
                                                border: "none",
                                                borderRadius: "50%",
                                                width: "36px",
                                                height: "36px",
                                                fontSize: "1.2rem",
                                                cursor: "pointer",
                                                display: "flex",
                                                alignItems: "center",
                                                justifyContent: "center",
                                                flexShrink: 0,
                                            }}
                                        >
                                            X
                                        </button>
                                    </div>

                                    {/* Contenu PDF */}
                                    <div
                                        style={{ flex: 1, overflow: "hidden" }}
                                    >
                                        {beraModal.loading ? (
                                            <div
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    height: "100%",
                                                    fontSize: "1rem",
                                                    color: "#666",
                                                }}
                                            >
                                                Chargement du BERA...
                                            </div>
                                        ) : beraModal.pdfError ? (
                                            <div
                                                style={{
                                                    display: "flex",
                                                    alignItems: "center",
                                                    justifyContent: "center",
                                                    height: "100%",
                                                    fontSize: "0.9rem",
                                                    color: "#c00",
                                                }}
                                            >
                                                Impossible de charger le PDF du
                                                BERA.
                                            </div>
                                        ) : beraModal.pdfUrl ? (
                                            <iframe
                                                src={beraModal.pdfUrl}
                                                style={{
                                                    width: "100%",
                                                    height: "100%",
                                                    border: "none",
                                                }}
                                                title="BERA PDF"
                                            />
                                        ) : null}
                                    </div>

                                    {/* Footer */}
                                    <div
                                        style={{
                                            padding: "12px 20px",
                                            borderTop: "1px solid #e0e0e0",
                                            textAlign: "center",
                                            flexShrink: 0,
                                        }}
                                    >
                                        <button
                                            onClick={() => {
                                                if (beraModal.pdfUrl)
                                                    URL.revokeObjectURL(
                                                        beraModal.pdfUrl,
                                                    );
                                                setBeraModal(null);
                                            }}
                                            style={{
                                                background: "var(--deep-blue)",
                                                color: "white",
                                                border: "none",
                                                borderRadius: "8px",
                                                padding: "10px 32px",
                                                fontSize: "0.9rem",
                                                fontWeight: "600",
                                                cursor: "pointer",
                                            }}
                                        >
                                            Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Footer CTA */}
                        <div className="footer-cta">
                            <div className="footer-cta-title">
                                Trouves le bon spot pour ta rando
                            </div>
                            <div className="footer-cta-buttons">
                                <a
                                    className="btn btn-primary"
                                    href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{textDecoration: "none"}}
                                >
                                    Proposer une amélioration
                                </a>
                                <a
                                    className="btn btn-secondary"
                                    href="https://charmed-origami-8bf.notion.site/3039717d683f807a91d5e7864b74b5cc"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{textDecoration: "none"}}
                                >
                                    Faire un don
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.render(
                <MountainWeatherApp />,
                document.getElementById("root"),
            );
        </script>
    </body>
</html>
